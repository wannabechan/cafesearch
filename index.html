<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasty 500m</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #ffffff;
            color: #202124;
            line-height: 1.6;
            min-height: 100vh;
        }

        .address-item::selection,
        .address-item *::selection {
            background: transparent;
        }

        .address-item::-moz-selection,
        .address-item *::-moz-selection {
            background: transparent;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        h1 {
            text-align: center;
            font-size: 48px;
            font-weight: 300;
            color: #202124;
            margin-bottom: 50px;
            letter-spacing: -0.5px;
        }

        .search-section {
            margin-bottom: 40px;
        }

        .search-box {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 600px;
            margin: 0 auto;
        }

        .search-input {
            width: 100%;
            padding: 16px 20px;
            font-size: 16px;
            border: 1px solid #dfe1e5;
            border-radius: 24px;
            outline: none;
            transition: all 0.2s;
        }

        .search-buttons {
            display: flex;
            gap: 12px;
            width: 100%;
            align-items: center;
        }

        .search-input:focus {
            border-color: #4285f4;
            box-shadow: 0 2px 5px 1px rgba(64, 60, 67, 0.16);
        }

        .search-button {
            flex: 1;
            padding: 12px 24px;
            font-size: 15px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
        }

        .search-button:hover {
            background-color: #357ae8;
        }

        .search-button:active {
            background-color: #2a5fcc;
        }

        .location-button {
            flex: 0 0 auto;
            padding: 12px 16px;
            font-size: 18px;
            background-color: #34a853;
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .category-select {
            flex: 0 0 auto;
            padding: 12px 16px;
            font-size: 15px;
            background-color: #ffffff;
            color: #202124;
            border: 1px solid #dfe1e5;
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            outline: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%235f6368' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        .category-select:hover {
            border-color: #4285f4;
            box-shadow: 0 2px 5px 1px rgba(64, 60, 67, 0.16);
        }

        .category-select:focus {
            border-color: #4285f4;
            box-shadow: 0 2px 5px 1px rgba(64, 60, 67, 0.16);
        }

        .location-button:hover {
            background-color: #2d8f47;
        }

        .location-button:active {
            background-color: #267d3e;
        }

        .location-button:disabled {
            background-color: #c0c0c0;
            cursor: not-allowed;
        }

        .results-section {
            margin-top: 40px;
        }

        .results-header {
            font-size: 14px;
            color: #5f6368;
            margin-bottom: 20px;
            text-align: center;
        }

        .cafe-list {
            list-style: none;
        }

        .cafe-item {
            padding: 20px;
            border-bottom: 1px solid #f1f3f4;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .cafe-item:hover {
            background-color: #f8f9fa;
        }

        .cafe-item:last-child {
            border-bottom: none;
        }

        .cafe-name {
            font-size: 18px;
            font-weight: 500;
            color: #1a73e8;
            margin-bottom: 8px;
        }

        .cafe-name:hover {
            text-decoration: underline;
        }

        .cafe-address {
            font-size: 14px;
            color: #5f6368;
            margin-bottom: 6px;
        }

        .cafe-distance {
            font-size: 13px;
            color: #80868b;
        }



        .loading {
            text-align: center;
            padding: 40px;
            color: #5f6368;
            font-size: 14px;
        }

        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
        }

        .progress-container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        .progress-bar-wrapper {
            width: 100%;
            height: 8px;
            background-color: #f1f3f4;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4285f4, #34a853);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 13px;
            color: #5f6368;
            margin-bottom: 4px;
        }

        .progress-percentage {
            font-size: 14px;
            font-weight: 500;
            color: #202124;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #ea4335;
            font-size: 14px;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #5f6368;
        }

        .no-results-title {
            font-size: 18px;
            margin-bottom: 8px;
            color: #202124;
        }

        .no-results-text {
            font-size: 14px;
        }

        .address-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dfe1e5;
            border-radius: 12px;
            margin-top: 8px;
        }

        .address-item {
            padding: 20px;
            border-bottom: 1px solid #f1f3f4;
            transition: background-color 0.2s;
            cursor: pointer !important;
            user-select: none !important;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            -webkit-touch-callout: none !important;
            -webkit-tap-highlight-color: transparent;
            background-color: #ffffff;
            display: block;
            width: 100%;
            text-align: left;
            border: none;
            outline: none;
        }

        .address-item:hover {
            background-color: #f8f9fa;
            cursor: pointer !important;
        }

        .address-item:active {
            background-color: #f1f3f4;
        }

        .address-item:last-child {
            border-bottom: none;
        }

        .address-item * {
            cursor: pointer !important;
            user-select: none !important;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            pointer-events: none !important;
            -webkit-touch-callout: none !important;
        }

        .address-main {
            font-size: 16px;
            color: #202124;
            margin-bottom: 4px;
            font-weight: 500;
            display: block;
        }

        .address-sub {
            font-size: 14px;
            color: #5f6368;
            display: block;
        }

        /* Î™®Î∞îÏùº ÏµúÏ†ÅÌôî */
        @media screen and (max-width: 768px) {
            .container {
                padding: 20px 16px;
            }

            h1 {
                font-size: 32px;
                margin-bottom: 30px;
            }

            .search-box {
                gap: 10px;
                max-width: 100%;
            }

            .search-buttons {
                flex-direction: row;
                gap: 8px;
            }

            .category-select {
                padding: 12px 14px;
                font-size: 14px;
                padding-right: 32px;
            }

            .search-input {
                padding: 14px 18px;
                font-size: 16px; /* iOS Ï§å Î∞©ÏßÄ */
                border-radius: 20px;
            }

            .search-button {
                flex: 1;
                padding: 12px 16px;
                font-size: 14px;
                border-radius: 20px;
                min-width: 0;
            }

            .location-button {
                padding: 12px 14px;
                font-size: 18px;
                border-radius: 20px;
                flex: 0 0 auto;
            }
            
            .category-select {
                flex: 0 0 auto;
                min-width: 70px;
            }

            .cafe-item {
                padding: 16px;
            }

            .cafe-name {
                font-size: 16px;
                margin-bottom: 6px;
            }

            .cafe-address {
                font-size: 13px;
                margin-bottom: 4px;
                line-height: 1.5;
            }

            .cafe-distance {
                font-size: 12px;
            }



            .results-header {
                font-size: 13px;
                margin-bottom: 16px;
            }

            .address-item {
                padding: 14px 16px;
            }

            .address-main {
                font-size: 15px;
            }

            .address-sub {
                font-size: 13px;
            }

            .loading {
                padding: 30px 20px;
                font-size: 13px;
            }

            .loading-container {
                padding: 40px 16px;
            }

            .progress-container {
                max-width: 100%;
            }

            .progress-text {
                font-size: 12px;
            }

            .progress-percentage {
                font-size: 13px;
            }

            .error {
                padding: 30px 20px;
                font-size: 13px;
            }

            .no-results {
                padding: 40px 16px;
            }

            .no-results-title {
                font-size: 16px;
            }
        }

        /* ÏûëÏùÄ Î™®Î∞îÏùº ÌôîÎ©¥ (iPhone SE Îì±) */
        @media screen and (max-width: 375px) {
            .container {
                padding: 16px 12px;
            }

            h1 {
                font-size: 28px;
                margin-bottom: 24px;
            }

            .search-input {
                padding: 12px 16px;
            }

            .search-button {
                padding: 12px 14px;
                font-size: 13px;
            }

            .location-button {
                padding: 12px 12px;
                font-size: 16px;
            }

            .category-select {
                padding: 12px 12px;
                font-size: 13px;
                padding-right: 28px;
                min-width: 65px;
            }

            .cafe-item {
                padding: 14px;
            }

            .cafe-name {
                font-size: 15px;
            }

            .cafe-address {
                font-size: 12px;
            }
        }

        /* Í∞ÄÎ°ú Î™®Îìú ÏµúÏ†ÅÌôî */
        @media screen and (max-width: 768px) and (orientation: landscape) {
            .container {
                padding: 16px 20px;
            }

            h1 {
                font-size: 28px;
                margin-bottom: 20px;
            }

            .search-buttons {
                flex-direction: row;
                gap: 8px;
            }

            .search-button {
                flex: 1;
            }

            .location-button {
                flex: 0 0 auto;
                min-width: 80px;
            }

            .category-select {
                flex: 0 0 auto;
                min-width: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Tasty 500m</h1>
        
        <div class="search-section">
            <div class="search-box">
                <input 
                    type="text" 
                    id="addressInput" 
                    class="search-input" 
                    placeholder="Ï£ºÏÜå ÏûÖÎ†•"
                    autocomplete="off"
                >
                <div class="search-buttons">
                    <button id="searchButton" class="search-button">Í≤ÄÏÉâ</button>
                    <button id="locationButton" class="location-button" title="ÌòÑÏúÑÏπò">üìç</button>
                    <select id="categorySelect" class="category-select" title="Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù">
                        <option value="Ïπ¥Ìéò" selected>Ïπ¥Ìéò</option>
                        <option value="Îπµ">Îπµ</option>
                        <option value="ÎßàÎùºÌÉï">ÎßàÎùºÌÉï</option>
                        <option value="Íµ≠Î∞•">Íµ≠Î∞•</option>
                        <option value="ÍπÄÎ∞•">ÍπÄÎ∞•</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="results-section" id="resultsSection" style="display: none;">
            <div class="results-header" id="resultsHeader"></div>
            <ul class="cafe-list" id="cafeList"></ul>
        </div>

        <div class="loading" id="loading" style="display: none;">
            <div class="loading-container">
                <div class="progress-container">
                    <div class="progress-text" id="progressText">Í≤ÄÏÉâ Ï§ÄÎπÑ Ï§ë...</div>
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <div class="progress-percentage" id="progressPercentage">0%</div>
                </div>
            </div>
        </div>
        <div class="error" id="error" style="display: none;"></div>
    </div>

    <script>
        // ============================================
        // ÏÑ§Ï†ï ÏÑπÏÖò (Î©îÎâ¥Î≥Ñ ÏÑ§Ï†ï Í∞ùÏ≤¥)
        // ============================================
        
        // Î©îÎâ¥Î≥Ñ ÏÑ§Ï†ï Í∞ùÏ≤¥
        const MENU_CONFIGS = {
            'Ïπ¥Ìéò': {
                categoryGroups: ['Ïπ¥Ìéò', 'Ïª§Ìîº', 'ÏõêÎëê', 'cafe', 'coffee', 'ÏõêÎëêÏª§Ìîº'],
                excludedNames: ['Ïù¥ÎîîÏïº', 'Ïª¥Ìè¨Ï¶à', 'Î©îÍ∞Ä', 'MGC', 'Ïπ¥ÌéòÎ≤†ÎÑ§', 'Îß§Î®∏Îìú', 'Î∞±ÏñµÏª§Ìîº', 'ÎπΩÎã§Î∞©', 'Î∞©ÌÉàÏ∂ú', 'ÏöîÍ±∞Ìä∏', 'Í≥µÏ∞®', 'ÌÉêÏï§ÌÉêÏä§', 'ÌååÏä§Ïø†Ï∞å', 'ÌÖêÌçºÏÑºÌä∏Ïª§Ìîº'],
                excludedCategoryKeywords: ['Î∏åÎü∞Ïπò', 'brunch', 'Î†àÏä§ÌÜ†Îûë', 'restaurant', 'Ïà†Ïßë', 'Î∞î', 'bar', 'ÌéúÏÖò', 'Ìò∏ÌÖî', 'hotel', 'ÏπòÌÇ®', 'chicken', 'ÌîºÏûê', 'pizza', 'ÏïÑÏù¥Ïä§ÌÅ¨Î¶º', 'ÏöîÍ±∞Ìä∏', 'ÏÉêÎü¨Îìú', 'ÌïúÏãù', 'Ï§ëÏãù', 'ÏùºÏãù', 'ÏñëÏãù'],
                superpassKeywords: [],
                searchMessage: 'ÏßÄÎèÑÏóêÏÑú Ïπ¥Ìéò Í≤ÄÏÉâ Ï§ë...',
                hasSupplementLogic: false
            },
            'ÎßàÎùºÌÉï': {
                categoryGroups: ['ÎßàÎùºÌÉï', 'ÎßàÎùºÏÉπÍ∂à', 'ÎßàÎùº'],
                excludedNames: [],
                excludedCategoryKeywords: [],
                superpassKeywords: ['ÎßàÎùº', 'ÎßàÎùºÌÉï', 'ÎßàÎùºÏÉπÍ∂à', 'ÏÉπÍ∂à', 'ÎßàÎùºÎ©¥', 'Ìõ†Í∂à', 'ÏÉ§Î∏åÏÉ§Î∏å', 'malatang', 'ÎßàÎùºÌÉïÏßë', 'ÎßàÎùºÏÉπÍ∂àÏßë', 'Ìõ†Í∂àÏßë'],
                searchMessage: 'ÏßÄÎèÑÏóêÏÑú ÎßàÎùºÌÉï Îß§Ïû• Í≤ÄÏÉâ Ï§ë...',
                hasSupplementLogic: false
            },
            'Îπµ': {
                categoryGroups: ['ÎπµÏßë', 'Î≤†Ïù¥Ïª§Î¶¨', 'Ï†úÍ≥º', 'Ï†úÎπµ', 'Îπµ', 'bakery', 'Ï†úÍ≥ºÏ†ê', 'Ï†úÎπµÏÜå'],
                excludedNames: [],
                excludedCategoryKeywords: [],
                superpassKeywords: ['ÎöúÎ†àÏ•¨Î•¥', 'ÏïÑÌã∞Ï†ú', 'ÎçòÌÇ®', 'ÎèÑÎÑàÏ∏†', 'ÌååÎ¶¨Î∞îÍ≤åÌä∏', 'ÌååÎ¶¨ÌÅ¨ÎùºÏÉÅ', 'Ï†úÍ≥º', 'Ï†úÎπµ', 'Î≤†Ïù¥Ïª§Î¶¨'],
                searchMessage: 'ÏßÄÎèÑÏóêÏÑú ÎπµÏßë Í≤ÄÏÉâ Ï§ë...',
                hasSupplementLogic: false
            },
            'Íµ≠Î∞•': {
                categoryGroups: ['ÏàúÎåÄÍµ≠', 'ÏÑ§Î†ÅÌÉï', 'Í≥∞ÌÉï', 'Íµ≠Î∞•', 'ÏàúÎåìÍµ≠', 'ÏÑ§Î†ÅÌÉïÏßë', 'Í≥∞ÌÉïÏßë', 'Ìï¥Ïû•Íµ≠', 'Ìï¥Ïû•Íµ≠Ïßë', 'ÎºàÌï¥Ïû•Íµ≠', 'ÏΩ©ÎÇòÎ¨ºÌï¥Ïû•Íµ≠', 'ÏãúÎ†àÍ∏∞Ìï¥Ïû•Íµ≠', 'ÏÑ†ÏßÄÌï¥Ïû•Íµ≠', 'Îî∞Î°úÍµ≠Î∞•', 'Í∞êÏûêÌÉï', 'Í∞êÏûêÌÉïÏßë', 'ÎºàÍ∞êÏûêÌÉï', 'Í∞êÏûêÌÉïÍµ≠Î∞•', 'Ìï¥Ïû•', 'Ïú°Í∞úÏû•', 'Ïú°Í≤åÏû•', 'ÏÇ¨Í≥®Íµ≠Î∞•'],
                excludedNames: [],
                excludedCategoryKeywords: [],
                superpassKeywords: ['ÏàúÎåÄÍµ≠', 'ÏÑ§Î†ÅÌÉï', 'Í≥∞ÌÉï', 'Íµ≠Î∞•', 'ÏàúÎåìÍµ≠', 'ÏÑ§Î†ÅÌÉïÏßë', 'Í≥∞ÌÉïÏßë', 'Ìï¥Ïû•Íµ≠', 'Ìï¥Ïû•Íµ≠Ïßë', 'ÎºàÌï¥Ïû•Íµ≠', 'ÏΩ©ÎÇòÎ¨ºÌï¥Ïû•Íµ≠', 'ÏãúÎ†àÍ∏∞Ìï¥Ïû•Íµ≠', 'ÏÑ†ÏßÄÌï¥Ïû•Íµ≠', 'Îî∞Î°úÍµ≠Î∞•', 'Í∞êÏûêÌÉï', 'Í∞êÏûêÌÉïÏßë', 'ÎºàÍ∞êÏûêÌÉï', 'Í∞êÏûêÌÉïÍµ≠Î∞•', 'Ìï¥Ïû•', 'Ïú°Í∞úÏû•', 'Ïú°Í≤åÏû•'],
                searchMessage: 'ÏßÄÎèÑÏóêÏÑú Íµ≠Î∞• Îß§Ïû• Í≤ÄÏÉâ Ï§ë...',
                hasSupplementLogic: true
            },
            'ÍπÄÎ∞•': {
                categoryGroups: ['ÍπÄÎ∞•', 'ÍπÄÎ∞•Ïßë', 'kimbap', 'Î∂ÑÏãù', 'Î∂ÑÏãùÏßë'],
                excludedNames: [],
                excludedCategoryKeywords: [],
                superpassKeywords: ['ÍπÄÎ∞•', 'ÍπÄÎ∞•Ïßë', 'Î∂ÑÏãù', 'kimbap'],
                searchMessage: 'ÏßÄÎèÑÏóêÏÑú ÍπÄÎ∞• Ïßë Í≤ÄÏÉâ Ï§ë...',
                hasSupplementLogic: false
            }
        };
        
        // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Î©îÎâ¥Ïùò ÏÑ§Ï†ïÏùÑ Î∞òÌôòÌïòÎäî Ìï®Ïàò
        function getCurrentMenuConfig() {
            const categorySelect = document.getElementById('categorySelect');
            const selectedMenu = categorySelect?.value || 'Ïπ¥Ìéò';
            return MENU_CONFIGS[selectedMenu] || MENU_CONFIGS['Ïπ¥Ìéò'];
        }
        
        // ÌòÑÏû¨ ÏÑ§Ï†ïÏùÑ Î≥ÄÏàòÎ°ú Ï†ëÍ∑ºÌïòÍ∏∞ ÏúÑÌïú Ìó¨Ìçº Ìï®ÏàòÎì§
        function getMenuCategoryGroups() {
            return getCurrentMenuConfig().categoryGroups;
        }
        
        function getExcludedNames() {
            return getCurrentMenuConfig().excludedNames;
        }
        
        function getExcludedCategoryKeywords() {
            return getCurrentMenuConfig().excludedCategoryKeywords;
        }
        
        function getSuperpassKeywords() {
            return getCurrentMenuConfig().superpassKeywords;
        }
        
        function getSearchMessage() {
            return getCurrentMenuConfig().searchMessage;
        }
        
        function hasSupplementLogic() {
            return getCurrentMenuConfig().hasSupplementLogic || false;
        }
        
        // ============================================
        // API ÏÑ§Ï†ï
        // ============================================
        
        // API ÏóîÎìúÌè¨Ïù∏Ìä∏ (ÏÑúÎ≤ÑÎ¶¨Ïä§ Ìï®Ïàò ÏÇ¨Ïö©)
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:3000/api'
            : '/api';

        // ============================================
        // ÌîÑÎ°úÍ∑∏Î†àÏä§Î∞î ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        // ============================================
        
        function updateProgress(percentage, text) {
            const progressBar = document.getElementById('progressBar');
            const progressPercentage = document.getElementById('progressPercentage');
            const progressText = document.getElementById('progressText');
            
            if (progressBar) {
                progressBar.style.width = `${percentage}%`;
            }
            if (progressPercentage) {
                progressPercentage.textContent = `${percentage}%`;
            }
            if (progressText && text) {
                progressText.textContent = text;
            }
        }

        // ÎÑ§Ïù¥Î≤Ñ Ï¢åÌëúÍ≥Ñ(KATECH/TM128)Î•º WGS84Î°ú Î≥ÄÌôò (Í∑ºÏÇ¨ Î≥ÄÌôò)
        function naverToWGS84(mapx, mapy) {
            // ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ APIÏùò mapx, mapyÎäî KATECH Ï¢åÌëúÍ≥Ñ
            // Ï†ïÌôïÌïú Î≥ÄÌôòÏùÄ Î≥µÏû°ÌïòÎØÄÎ°ú, Ïπ¥Ïπ¥Ïò§ APIÎ°ú Ï£ºÏÜå‚ÜíÏ¢åÌëú Î≥ÄÌôòÏùÑ Ï£ºÎ°ú ÏÇ¨Ïö©
            // Ïó¨Í∏∞ÏÑúÎäî ÎåÄÎûµÏ†ÅÏù∏ Í±∞Î¶¨ Í≥ÑÏÇ∞Ïö© Í∑ºÏÇ¨ Î≥ÄÌôòÎßå ÏàòÌñâ
            const x = parseFloat(mapx);
            const y = parseFloat(mapy);
            
            // Í∞ÑÎã®Ìïú ÏÑ†Ìòï Î≥ÄÌôò (Í∑ºÏÇ¨Í∞í)
            // Ï†ïÌôïÌïú Î≥ÄÌôòÏùÑ ÏúÑÌï¥ÏÑúÎäî PROJ4 Í∞ôÏùÄ ÎùºÏù¥Î∏åÎü¨Î¶¨ ÌïÑÏöî
            const lon = 126.9784 + (x - 200000) * 0.000009;
            const lat = 37.5665 + (y - 500000) * 0.000009;
            
            return { lon, lat };
        }

        // Ïπ¥Ïπ¥Ïò§ API Ìò∏Ï∂ú (ÏÑúÎ≤ÑÎ¶¨Ïä§ Ìï®ÏàòÎ•º ÌÜµÌï¥) - Ï£ºÏÜå Í≤ÄÏÉâÏö©
        async function callKakaoAPI(endpoint, params) {
            try {
                const queryParams = new URLSearchParams({
                    endpoint: endpoint,
                    ...params
                });
                
                const response = await fetch(`${API_BASE_URL}/kakao?${queryParams}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'API Ìò∏Ï∂ú Ïã§Ìå®');
                }

                return await response.json();
            } catch (error) {
                console.error('Kakao API Ìò∏Ï∂ú Ïò§Î•ò:', error);
                throw error;
            }
        }

        // ÎÑ§Ïù¥Î≤Ñ API Ìò∏Ï∂ú (ÏÑúÎ≤ÑÎ¶¨Ïä§ Ìï®ÏàòÎ•º ÌÜµÌï¥) - Ïπ¥Ìéò Í≤ÄÏÉâÏö©
        async function callNaverAPI(endpoint, params) {
            try {
                const queryParams = new URLSearchParams({
                    endpoint: endpoint,
                    ...params
                });
                
                const response = await fetch(`${API_BASE_URL}/naver?${queryParams}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'API Ìò∏Ï∂ú Ïã§Ìå®');
                }

                return await response.json();
            } catch (error) {
                console.error('Naver API Ìò∏Ï∂ú Ïò§Î•ò:', error);
                throw error;
            }
        }


        // Îëê Ï¢åÌëú Í∞ÑÏùò Í±∞Î¶¨ Í≥ÑÏÇ∞ (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // ÏßÄÍµ¨ Î∞òÏßÄÎ¶Ñ (ÎØ∏ÌÑ∞)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // ÎØ∏ÌÑ∞ Îã®ÏúÑ Í±∞Î¶¨
        }

        // ============================================
        // ÌïÑÌÑ∞ÎßÅ Ìï®Ïàò
        // ============================================
        
        // Ï†úÏô∏Ìï† Îß§Ïû•Ïù∏ÏßÄ ÌôïÏù∏
        function isExcludedPlace(placeName) {
            if (!placeName) return false;
            const name = placeName.toLowerCase();
            const excludedNames = getExcludedNames();
            return excludedNames.some(excluded => name.includes(excluded.toLowerCase()));
        }
        
        // Ïπ¥ÌÖåÍ≥†Î¶¨Ïù∏ÏßÄ ÌôïÏù∏ (Ï†úÏô∏ ÌïÑÌÑ∞ÎßÅ Îã®Ïñ¥ Í∑∏Î£π ÏÇ¨Ïö©)
        function isValidCategory(categoryName) {
            // Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†ïÎ≥¥Í∞Ä ÏóÜÏúºÎ©¥ ÌóàÏö©
            if (!categoryName) return true;
            
            const category = categoryName.toLowerCase();
            const excludedKeywords = getExcludedCategoryKeywords();
            
            // Ïπ¥Ïπ¥Ïò§ APIÎäî "ÏùåÏãùÏ†ê > Ïπ¥Ìéò > Ïπ¥Ìéò" Í∞ôÏùÄ ÌòïÏãùÏúºÎ°ú Î∞òÌôòÌï† Ïàò ÏûàÏùå
            // Îî∞ÎùºÏÑú Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†ÑÏ≤¥ Î¨∏ÏûêÏó¥ÏóêÏÑú Ï†úÏô∏ ÌÇ§ÏõåÎìúÎ•º Ï∞æÎêò,
            // "ÏùåÏãùÏ†ê" Í∞ôÏùÄ ÏÉÅÏúÑ Ïπ¥ÌÖåÍ≥†Î¶¨Îäî Î¨¥ÏãúÌïòÍ≥† Ïã§Ï†ú Ïπ¥ÌÖåÍ≥†Î¶¨Îßå ÌôïÏù∏
            const categoryParts = category.split('>').map(part => part.trim());
            
            // Í∞Å Ïπ¥ÌÖåÍ≥†Î¶¨ Î∂ÄÎ∂ÑÏóêÏÑú Ï†úÏô∏ ÌÇ§ÏõåÎìú ÌôïÏù∏
            // Îã®, "ÏùåÏãùÏ†ê" Í∞ôÏùÄ ÏÉÅÏúÑ Ïπ¥ÌÖåÍ≥†Î¶¨Îäî Ï†úÏô∏ ÌÇ§ÏõåÎìúÍ∞Ä ÏïÑÎãàÎ©¥ Î¨¥Ïãú
            const isExcluded = excludedKeywords.some(keyword => {
                // Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†ÑÏ≤¥ Î¨∏ÏûêÏó¥ÏóêÏÑú ÌÇ§ÏõåÎìú ÌôïÏù∏
                if (category.includes(keyword)) {
                    // Îã®, "ÏùåÏãùÏ†ê > Ïπ¥Ìéò" Í∞ôÏùÄ Í≤ΩÏö∞ "ÏùåÏãùÏ†ê"Ïù¥ Ï†úÏô∏ ÌÇ§ÏõåÎìúÍ∞Ä ÏïÑÎãàÎ©¥ ÌóàÏö©
                    // Ïã§Ï†úÎ°úÎäî Í∞Å Î∂ÄÎ∂ÑÏùÑ Í∞úÎ≥ÑÏ†ÅÏúºÎ°ú ÌôïÏù∏
                    return categoryParts.some(part => part.includes(keyword));
                }
                return false;
            });
            
            // Ï†úÏô∏ ÌÇ§ÏõåÎìúÍ∞Ä ÏóÜÏúºÎ©¥ ÌóàÏö©
            return !isExcluded;
        }
        
        // ÏäàÌçºÌå®Ïä§ ÌÇ§ÏõåÎìúÍ∞Ä Îß§Ïû•Î™ÖÏóê Ìè¨Ìï®ÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏
        function hasSuperpassKeyword(placeName) {
            if (!placeName) return false;
            const superpassKeywords = getSuperpassKeywords();
            if (superpassKeywords.length === 0) return false;
            const name = placeName.toLowerCase();
            return superpassKeywords.some(keyword => name.includes(keyword.toLowerCase()));
        }
        
        // ============================================
        // ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ Ìï®Ïàò (4Îã®Í≥Ñ - ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ Ïö∞ÏÑ†)
        // ============================================
        
        // ÎÑ§Ïù¥Î≤Ñ APIÎ°ú Îß§Ïû• Í≤ÄÏÉâ (Î©îÎâ¥ Ïó∞Í¥Ä Ïπ¥ÌÖåÍ≥†Î¶¨ Í∑∏Î£π + Ï£ºÏÜå ÏÇ¨Ïö©)
        async function searchFromNaverAPI(baseX, baseY, baseAddress, radius = 750) {
            const categoryGroups = getMenuCategoryGroups();
            const allResults = [];
            
            // Ï£ºÏÜåÏóêÏÑú Íµ¨/Îèô Îã®ÏúÑ Ï∂îÏ∂ú (ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâÏóê ÏÇ¨Ïö©)
            const getAreaFromAddress = (address) => {
                if (!address) return '';
                
                // Ï£ºÏÜå ÌòïÏãù ÏòàÏãú:
                // "ÏÑúÏö∏ÌäπÎ≥ÑÏãú Í∞ïÎÇ®Íµ¨ ÌÖåÌó§ÎûÄÎ°ú 152" -> "Í∞ïÎÇ®Íµ¨"
                // "ÏÑúÏö∏Ïãú Í∞ïÎÇ®Íµ¨ Ïó≠ÏÇºÎèô" -> "Í∞ïÎÇ®Íµ¨ Ïó≠ÏÇºÎèô"
                // "Í≤ΩÍ∏∞ÎèÑ ÏÑ±ÎÇ®Ïãú Î∂ÑÎãπÍµ¨" -> "ÏÑ±ÎÇ®Ïãú Î∂ÑÎãπÍµ¨"
                
                const parts = address.split(' ').filter(p => p.trim());
                
                if (parts.length < 2) return '';
                
                // Ïãú/ÎèÑ Ï†úÍ±∞ (Ï≤´ Î≤àÏß∏ ÏöîÏÜå)
                const withoutCity = parts.slice(1);
                
                // "Íµ¨"Î°ú ÎÅùÎÇòÎäî ÏöîÏÜå Ï∞æÍ∏∞
                const guIndex = withoutCity.findIndex(p => p.includes('Íµ¨'));
                if (guIndex !== -1) {
                    const gu = withoutCity[guIndex];
                    // Íµ¨ Îã§ÏùåÏóê "Îèô"Ïù¥ ÏûàÏúºÎ©¥ Ìï®Íªò Î∞òÌôò
                    if (guIndex + 1 < withoutCity.length && withoutCity[guIndex + 1].includes('Îèô')) {
                        return `${gu} ${withoutCity[guIndex + 1]}`;
                    }
                    return gu;
                }
                
                // "Ïãú"Î°ú ÎÅùÎÇòÎäî ÏöîÏÜå Ï∞æÍ∏∞ (Í≤ΩÍ∏∞ÎèÑ ÏÑ±ÎÇ®Ïãú Î∂ÑÎãπÍµ¨ Í∞ôÏùÄ Í≤ΩÏö∞)
                const siIndex = withoutCity.findIndex(p => p.includes('Ïãú'));
                if (siIndex !== -1 && siIndex + 1 < withoutCity.length) {
                    const si = withoutCity[siIndex];
                    const nextPart = withoutCity[siIndex + 1];
                    if (nextPart.includes('Íµ¨')) {
                        return `${si} ${nextPart}`;
                    }
                }
                
                // Íµ¨Î•º Ï∞æÏßÄ Î™ªÌñàÏúºÎ©¥ Îëê Î≤àÏß∏ ÏöîÏÜåÎßå Î∞òÌôò (ÎåÄÎ∂ÄÎ∂Ñ Íµ¨)
                return withoutCity[0] || '';
            };
            
            const area = getAreaFromAddress(baseAddress);
            console.log('ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ - Í∏∞Ï§Ä Ï£ºÏÜå:', baseAddress, 'Ï∂îÏ∂úÎêú ÏßÄÏó≠:', area);
            
            // Í∞Å Ïπ¥ÌÖåÍ≥†Î¶¨ Í∑∏Î£πÏóê ÎåÄÌï¥ ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ ÏàòÌñâ
            for (const category of categoryGroups) {
                try {
                    // ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ: Ïπ¥ÌÖåÍ≥†Î¶¨ + ÏßÄÏó≠ (ÏßÄÏó≠Ïù¥ ÏûàÏúºÎ©¥ Ï∂îÍ∞Ä, ÏóÜÏúºÎ©¥ Ïπ¥ÌÖåÍ≥†Î¶¨Îßå)
                    let searchQuery = category;
                    if (area) {
                        searchQuery = `${category} ${area}`;
                    }
                    
                    console.log('ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ ÏøºÎ¶¨:', searchQuery);
                    
                    const data = await callNaverAPI('local', {
                        query: searchQuery,
                        display: 100, // ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâÏùÄ Îçî ÎßéÏùÄ Í≤∞Í≥º Í∞ÄÎä•
                        sort: 'random'
                    });
                    
                    console.log(`Ïπ¥ÌÖåÍ≥†Î¶¨ "${category}" Í≤ÄÏÉâ Í≤∞Í≥º:`, data.items?.length || 0, 'Í∞ú');
                    
                    if (data.items && data.items.length > 0) {
                        // ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ Í≤∞Í≥ºÎ•º ÌëúÏ§Ä ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò
                        const convertedResults = data.items.map(item => {
                            const title = (item.title || '').replace(/<[^>]*>/g, '');
                            const category = (item.category || '').replace(/<[^>]*>/g, '');
                            const address = (item.address || '').replace(/<[^>]*>/g, '');
                            const roadAddress = (item.roadAddress || '').replace(/<[^>]*>/g, '');
                            
                            // ÎÑ§Ïù¥Î≤Ñ Ï¢åÌëúÎäî Î∂ÄÏ†ïÌôïÌïòÎØÄÎ°ú Í±∞Î¶¨ ÌïÑÌÑ∞ÎßÅÏùÑ ÌïòÏßÄ ÏïäÏùå
                            // Ï†ïÌôïÌïú Ï¢åÌëúÏôÄ Í±∞Î¶¨Îäî enrichWithAddressÏóêÏÑú Ïπ¥Ïπ¥Ïò§ APIÎ°ú Î≥ÄÌôò ÌõÑ Í≥ÑÏÇ∞Îê®
                            // Ïó¨Í∏∞ÏÑúÎäî ÏûÑÏãú Ï¢åÌëúÎßå ÏÑ§Ï†ï (ÎÇòÏ§ëÏóê Ï†ïÌôïÌûà Î≥ÄÌôòÎê®)
                            let lon = baseX;
                            let lat = baseY;
                            let distance = 0; // Í±∞Î¶¨Îäî ÎÇòÏ§ëÏóê Ï†ïÌôïÌûà Í≥ÑÏÇ∞
                            
                            // ÎÑ§Ïù¥Î≤Ñ Ï¢åÌëúÍ∞Ä ÏûàÏúºÎ©¥ Í∑ºÏÇ¨Í∞íÏúºÎ°ú ÏÑ§Ï†ï (Í±∞Î¶¨ ÌïÑÌÑ∞ÎßÅÏùÄ ÌïòÏßÄ ÏïäÏùå)
                            if (item.mapx && item.mapy) {
                                const coords = naverToWGS84(parseFloat(item.mapx), parseFloat(item.mapy));
                                lon = coords.lon;
                                lat = coords.lat;
                                // Í±∞Î¶¨Îäî ÎÇòÏ§ëÏóê Ï†ïÌôïÌïú Ï¢åÌëúÎ°ú Ïû¨Í≥ÑÏÇ∞ÌïòÎØÄÎ°ú Ïó¨Í∏∞ÏÑúÎäî Í≥ÑÏÇ∞ÌïòÏßÄ ÏïäÏùå
                            }
                            
                            // Ïπ¥Ïπ¥Ïò§ API ÌòïÏãùÍ≥º Ïú†ÏÇ¨ÌïòÍ≤å Î≥ÄÌôò
                            // Ï¢åÌëúÎäî enrichWithAddressÏóêÏÑú Ïπ¥Ïπ¥Ïò§ APIÎ°ú Ï†ïÌôïÌûà Î≥ÄÌôòÎê®
                            return {
                                id: item.link || title, // ÎÑ§Ïù¥Î≤Ñ ÎßÅÌÅ¨ ÎòêÎäî Ï†úÎ™©ÏùÑ IDÎ°ú ÏÇ¨Ïö©
                                place_name: title,
                                category_name: category,
                                address_name: address,
                                road_address: {
                                    address_name: roadAddress
                                },
                                x: lon.toString(), // ÏûÑÏãú Ï¢åÌëú (ÎÇòÏ§ëÏóê Ï†ïÌôïÌûà Î≥ÄÌôò)
                                y: lat.toString(), // ÏûÑÏãú Ï¢åÌëú (ÎÇòÏ§ëÏóê Ï†ïÌôïÌûà Î≥ÄÌôò)
                                distance: distance, // ÏûÑÏãú Í±∞Î¶¨ (ÎÇòÏ§ëÏóê Ï†ïÌôïÌûà Í≥ÑÏÇ∞)
                                displayAddress: roadAddress || address,
                                _naverData: item, // ÏõêÎ≥∏ ÎÑ§Ïù¥Î≤Ñ Îç∞Ïù¥ÌÑ∞ Î≥¥Í¥Ä
                                _needsCoordConversion: true // Ï¢åÌëú Î≥ÄÌôòÏù¥ ÌïÑÏöîÌï®ÏùÑ ÌëúÏãú
                            };
                        }).filter(item => item !== null); // null Ï†úÍ±∞
                        
                        console.log(`Ïπ¥ÌÖåÍ≥†Î¶¨ "${category}" Î≥ÄÌôò ÌõÑ Í≤∞Í≥º:`, convertedResults.length, 'Í∞ú (Í±∞Î¶¨ ÌïÑÌÑ∞ÎßÅ ÏóÜÏùå - ÎÇòÏ§ëÏóê Ï†ïÌôïÌïú Ï¢åÌëúÎ°ú Ïû¨Í≥ÑÏÇ∞)');
                        allResults.push(...convertedResults);
                    } else {
                        console.log(`Ïπ¥ÌÖåÍ≥†Î¶¨ "${category}" Í≤ÄÏÉâ Í≤∞Í≥º ÏóÜÏùå`);
                    }
                    
                    // API Ìò∏Ï∂ú Í∞Ñ ÏßÄÏó∞ (rate limiting)
                    if (categoryGroups.indexOf(category) < categoryGroups.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }
                } catch (error) {
                    console.warn(`Ïπ¥ÌÖåÍ≥†Î¶¨ "${category}" ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ Ïã§Ìå®:`, error);
                }
            }
            
            // Ï§ëÎ≥µ Ï†úÍ±∞ (place_name + Ï£ºÏÜå Í∏∞Ï§Ä)
            const uniqueResults = [];
            const seenKeys = new Set();
            
            for (const doc of allResults) {
                const key = `${doc.place_name}_${doc.road_address?.address_name || doc.address_name || ''}`;
                if (!seenKeys.has(key)) {
                    seenKeys.add(key);
                    uniqueResults.push(doc);
                }
            }
            
            // Í±∞Î¶¨Ïàú Ï†ïÎ†¨
            uniqueResults.sort((a, b) => a.distance - b.distance);
            
            console.log('ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ ÏµúÏ¢Ö ÏßëÍ≥Ñ:', uniqueResults.length, 'Í∞ú (Ï§ëÎ≥µ Ï†úÍ±∞ ÌõÑ)');
            return uniqueResults;
        }
        
        // Ïπ¥Ïπ¥Ïò§ APIÎ°ú Îß§Ïû• Í≤ÄÏÉâ (Î≥¥Ï°∞Ïö© - ÌïÑÏöîÏãú ÏÇ¨Ïö©)
        async function searchFromKakaoAPI(baseX, baseY, radius = 750) {
            const categoryGroups = getMenuCategoryGroups();
            const allResults = [];
            
            // Í∞Å Ïπ¥ÌÖåÍ≥†Î¶¨ Í∑∏Î£πÏóê ÎåÄÌï¥ Í≤ÄÏÉâ ÏàòÌñâ
            for (const category of categoryGroups) {
                try {
                    const data = await callKakaoAPI('keyword', {
                        query: category,
                        x: baseX,
                        y: baseY,
                        radius: radius,
                        size: 15
                    });
                    
                    if (data.documents && data.documents.length > 0) {
                        allResults.push(...data.documents);
                    }
                    
                    // API Ìò∏Ï∂ú Í∞Ñ ÏßÄÏó∞ (rate limiting)
                    if (categoryGroups.indexOf(category) < categoryGroups.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                } catch (error) {
                    console.warn(`Ïπ¥ÌÖåÍ≥†Î¶¨ "${category}" Í≤ÄÏÉâ Ïã§Ìå®:`, error);
                }
            }
            
            // Ï§ëÎ≥µ Ï†úÍ±∞ (place_id Í∏∞Ï§Ä)
            const uniqueResults = [];
            const seenIds = new Set();
            
            for (const doc of allResults) {
                if (doc.id && !seenIds.has(doc.id)) {
                    seenIds.add(doc.id);
                    uniqueResults.push(doc);
                }
            }
            
            return uniqueResults;
        }
        
        // ============================================
        // Í≤∞Í≥º Ï≤òÎ¶¨ Ìï®Ïàò
        // ============================================
        
        // Ïπ¥Ïπ¥Ïò§ API Í≤ÄÏÉâ Í≤∞Í≥º Ï≤òÎ¶¨ Î∞è ÌïÑÌÑ∞ÎßÅ (Ï†úÏô∏ ÌïÑÌÑ∞ÎßÅ Îã®Ïñ¥ Í∑∏Î£π Ï†ÅÏö©)
        function processSearchResults(documents, baseX, baseY) {
            console.log('processSearchResults ÏûÖÎ†•:', documents.length, 'Í∞ú');
            
            const filtered = documents
                .filter(doc => {
                    // Ïπ¥ÌÖåÍ≥†Î¶¨ ÌïÑÌÑ∞ÎßÅ
                    const categoryName = doc.category_name || '';
                    const isValid = isValidCategory(categoryName);
                    if (!isValid) {
                        console.log(`Ïπ¥ÌÖåÍ≥†Î¶¨ ÌïÑÌÑ∞ÎßÅ Ï†úÏô∏ [${doc.place_name}]: Ïπ¥ÌÖåÍ≥†Î¶¨="${categoryName}"`);
                        return false;
                    }
                    // Ï†úÏô∏ Îß§Ïû• ÌïÑÌÑ∞ÎßÅ
                    const placeName = doc.place_name || '';
                    const isExcluded = isExcludedPlace(placeName);
                    if (isExcluded) {
                        console.log(`Ï†úÏô∏ Îß§Ïû• ÌïÑÌÑ∞ÎßÅ Ï†úÏô∏ [${placeName}]`);
                        return false;
                    }
                    return true;
                })
                .map(doc => {
                    const cafeX = parseFloat(doc.x);
                    const cafeY = parseFloat(doc.y);
                    // Í±∞Î¶¨Îäî Ïù¥ÎØ∏ Í≥ÑÏÇ∞ÎêòÏñ¥ ÏûàÏúºÎ©¥ ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ Í≥ÑÏÇ∞
                    let distance = doc.distance;
                    if (distance === undefined || distance === null) {
                        distance = calculateDistance(baseY, baseX, cafeY, cafeX);
                    }
                    
                    const roadAddr = (doc.road_address && doc.road_address.address_name) 
                        ? doc.road_address.address_name 
                        : '';
                    const addr = doc.address_name || '';
                    const placeName = doc.place_name || '';
                    const floorInfo = extractFloorInfo(placeName);
                    
                    return {
                        name: placeName,
                        address: addr,
                        roadAddress: roadAddr,
                        displayAddress: roadAddr || addr,
                        floor: floorInfo,
                        x: cafeX,
                        y: cafeY,
                        distance: distance,
                        categoryName: doc.category_name || '',
                        doc: doc,
                        // ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞ ÏÜçÏÑ± Î≥¥Ï°¥
                        _naverData: doc._naverData,
                        _fromKakao: doc._fromKakao,
                        _needsCoordConversion: doc._needsCoordConversion
                    };
                });
            
            // Í±∞Î¶¨ ÌïÑÌÑ∞ÎßÅÏùÄ ÎÇòÏ§ëÏóê Ï†ïÌôïÌïú Ï¢åÌëúÎ°ú Ïû¨Í≥ÑÏÇ∞Ìïú ÌõÑ ÏàòÌñâ
            // Ïó¨Í∏∞ÏÑúÎäî Ï†ïÎ†¨Îßå ÏàòÌñâ
            filtered.sort((a, b) => a.distance - b.distance);
            console.log('processSearchResults Ï∂úÎ†•:', filtered.length, 'Í∞ú');
            return filtered;
        }
        
        // Ï£ºÏÜå Ïû¨Ï°∞Ìöå Î∞è Ï¢åÌëú Î≥¥ÏôÑ Í≥µÌÜµ Ìï®Ïàò
        async function enrichWithAddress(places) {
            return Promise.all(places.map(async (place) => {
                // Ïπ¥Ïπ¥Ïò§ Í≤ÄÏÉâ Í≤∞Í≥ºÎäî Ïù¥ÎØ∏ Ï†ïÌôïÌïú Ï¢åÌëúÎ•º Í∞ÄÏßÄÍ≥† ÏûàÏúºÎØÄÎ°ú Î≥ÄÌôò Î∂àÌïÑÏöî
                // ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ Í≤∞Í≥ºÏù∏ Í≤ΩÏö∞Îßå Ï¢åÌëú Î≥ÄÌôò (ÌòÑÏû¨Îäî ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÏùå)
                if (place._needsCoordConversion && place.displayAddress && !place._fromKakao) {
                    try {
                        // Ï£ºÏÜåÎ•º Ïù¥Ïö©Ìï¥ Ïπ¥Ïπ¥Ïò§ APIÎ°ú Ï†ïÌôïÌïú Ï¢åÌëú Î≥ÄÌôò
                        const coordData = await callKakaoAPI('address', {
                            query: place.displayAddress,
                            size: 1
                        });
                        
                        if (coordData.documents?.length > 0) {
                            const doc = coordData.documents[0];
                            const newX = parseFloat(doc.x);
                            const newY = parseFloat(doc.y);
                            
                            // Ï¢åÌëú Î≥ÄÌôò ÏÑ±Í≥µ
                            place.x = newX.toString();
                            place.y = newY.toString();
                            
                            // Ï£ºÏÜå Ï†ïÎ≥¥ Î≥¥ÏôÑ
                            const roadAddr = doc.road_address?.address_name || '';
                            if (roadAddr) {
                                place.roadAddress = roadAddr;
                                place.displayAddress = roadAddr;
                            }
                            
                            console.log(`Ï¢åÌëú Î≥ÄÌôò ÏÑ±Í≥µ [${place.name}]: ${place.displayAddress} -> (${newX.toFixed(6)}, ${newY.toFixed(6)})`);
                        } else {
                            console.warn(`Ï¢åÌëú Î≥ÄÌôò Ïã§Ìå® [${place.name}]: Ï£ºÏÜå Í≤ÄÏÉâ Í≤∞Í≥º ÏóÜÏùå - ${place.displayAddress}`);
                            // Ï¢åÌëú Î≥ÄÌôò Ïã§Ìå® Ïãú Í∏∞Ï°¥ Ï¢åÌëú Ïú†ÏßÄ
                            // ÏõêÎ≥∏ ÎÑ§Ïù¥Î≤Ñ Ï¢åÌëúÎ•º ÏÇ¨Ïö©ÌïòÎèÑÎ°ù ÌëúÏãú
                            place._coordConversionFailed = true;
                        }
                    } catch (error) {
                        console.warn(`Ï¢åÌëú Ï†ïÌôïÌôî Ïã§Ìå® [${place.name}]:`, error, '- Ï£ºÏÜå:', place.displayAddress);
                        // Ï¢åÌëú Î≥ÄÌôò Ïã§Ìå® Ïãú Í∏∞Ï°¥ Ï¢åÌëú Ïú†ÏßÄ
                        place._coordConversionFailed = true;
                    }
                }
                
                // ÎèÑÎ°úÎ™Ö Ï£ºÏÜåÍ∞Ä ÏóÜÏúºÎ©¥ Ï¢åÌëúÎ°ú Ï£ºÏÜå Ï°∞Ìöå (Í∏∞Ï°¥ Î°úÏßÅ)
                if (!place.roadAddress && place.x && place.y && !place._needsCoordConversion) {
                    try {
                        const coordData = await callKakaoAPI('coord2address', {
                            x: place.x,
                            y: place.y
                        });
                        
                        if (coordData.documents?.length > 0) {
                            const doc = coordData.documents[0];
                            const roadAddr = doc.road_address?.address_name || '';
                            if (roadAddr) {
                                place.roadAddress = roadAddr;
                                place.displayAddress = roadAddr;
                            }
                        }
                    } catch (error) {
                        console.warn('Ï£ºÏÜå Ïû¨Ï°∞Ìöå Ïã§Ìå®:', place.name, error);
                    }
                }
                
                // _needsCoordConversion ÌîåÎûòÍ∑∏Îäî Í±∞Î¶¨ ÌïÑÌÑ∞ÎßÅÏóêÏÑú ÏÇ¨Ïö©ÌïòÎØÄÎ°ú Ïú†ÏßÄ
                // delete place._needsCoordConversion; // Ï£ºÏÑù Ï≤òÎ¶¨
                
                return place;
            }));
        }

        // Ï∏µ Ï†ïÎ≥¥ Ìå®ÌÑ¥Îì§ (ÎØ∏Î¶¨ Ïª¥ÌååÏùºÌïòÏó¨ ÏÑ±Îä• ÏµúÏ†ÅÌôî)
        const FLOOR_PATTERNS = [
            /(\d+)Ï∏µ/g,           // "2Ï∏µ", "3Ï∏µ"
            /(\d+)F/g,            // "2F", "3F"
            /(\d+)f/g,            // "2f", "3f"
            /B(\d+)/g,            // "B1", "B2" (ÏßÄÌïò)
            /ÏßÄÌïò\s*(\d+)/g,      // "ÏßÄÌïò 1", "ÏßÄÌïò 2"
            /\((\d+)Ï∏µ\)/g,       // "(2Ï∏µ)"
            /\((\d+)F\)/g,        // "(2F)"
            /\[(\d+)Ï∏µ\]/g,       // "[2Ï∏µ]"
            /(\d+)\.(\d+)Ï∏µ/g     // "2.5Ï∏µ" Í∞ôÏùÄ Í≤ΩÏö∞Îäî Ï†úÏô∏ÌïòÍ≥† Ï†ïÏàòÎßå
        ];
        const NUMBER_PATTERN = /\d+/;

        // Ïû•ÏÜåÎ™ÖÏóêÏÑú Ï∏µ Ï†ïÎ≥¥ Ï∂îÏ∂ú
        function extractFloorInfo(placeName) {
            if (!placeName) return '';
            
            let floorInfo = '';
            let foundFloor = null;
            
            // Í∞Å Ìå®ÌÑ¥ÏúºÎ°ú Ï∏µ Ï†ïÎ≥¥ Ï∞æÍ∏∞
            for (const pattern of FLOOR_PATTERNS) {
                const matches = placeName.match(pattern);
                if (matches && matches.length > 0) {
                    // ÎßàÏßÄÎßâ Îß§Ïπ≠Îêú Ï∏µ Ï†ïÎ≥¥ ÏÇ¨Ïö© (Í∞ÄÏû• Ï†ïÌôïÌïú Í≤É)
                    const lastMatch = matches[matches.length - 1];
                    const numberMatch = lastMatch.match(NUMBER_PATTERN);
                    if (numberMatch) {
                        foundFloor = numberMatch[0];
                        
                        // ÏßÄÌïò Ïó¨Î∂Ä ÌôïÏù∏
                        if (lastMatch.includes('B') || lastMatch.includes('ÏßÄÌïò')) {
                            floorInfo = `B${foundFloor}`;
                        } else {
                            floorInfo = `${foundFloor}Ï∏µ`;
                        }
                        break;
                    }
                }
            }
            
            return floorInfo;
        }

        // Îß§Ïû• Î™©Î°ù Î†åÎçîÎßÅ Í≥µÌÜµ Ìï®Ïàò (ÏÑ±Îä• ÏµúÏ†ÅÌôî: DocumentFragment ÏÇ¨Ïö©)
        function renderCafeList(places, resultsHeader, resultsSection, cafeList) {
            const categorySelect = document.getElementById('categorySelect');
            const selectedMenu = categorySelect?.value || 'Ïπ¥Ìéò';
            const menuNames = {
                'Ïπ¥Ìéò': 'Ïπ¥Ìéò',
                'ÎßàÎùºÌÉï': 'ÎßàÎùºÌÉï Îß§Ïû•',
                'Îπµ': 'ÎπµÏßë',
                'Íµ≠Î∞•': 'Íµ≠Î∞• Îß§Ïû•',
                'ÍπÄÎ∞•': 'ÍπÄÎ∞• Ïßë'
            };
            const menuName = menuNames[selectedMenu] || 'Îß§Ïû•';
            const suffix = selectedMenu === 'Ïπ¥Ìéò' ? ' (ÏùºÎ∂Ä ÌîÑÎûúÏ∞®Ïù¥Ï¶à Ï†úÏô∏)' : '';
            resultsHeader.textContent = `Ï£ºÎ≥ÄÏùò ${places.length}Í∞ú ${menuName}ÏûÖÎãàÎã§.${suffix}`;
            resultsSection.style.display = 'block';
            
            // DocumentFragment ÏÇ¨Ïö©ÏúºÎ°ú DOM Î¶¨ÌîåÎ°úÏö∞ ÏµúÏÜåÌôî
            const fragment = document.createDocumentFragment();
            
            for (const cafe of places) {
                const li = document.createElement('li');
                li.className = 'cafe-item';
                
                const nameEl = document.createElement('div');
                nameEl.className = 'cafe-name';
                nameEl.onclick = () => openNaverMap(cafe);
                nameEl.textContent = cafe.name;
                
                const addressEl = document.createElement('div');
                addressEl.className = 'cafe-address';
                let addressText = cafe.displayAddress || cafe.roadAddress || cafe.address;
                if (cafe.floor) {
                    addressText += ` ${cafe.floor}`;
                }
                addressEl.textContent = addressText;
                
                const distanceEl = document.createElement('div');
                distanceEl.className = 'cafe-distance';
                distanceEl.textContent = `${Math.round(cafe.distance)}m`;
                
                li.appendChild(nameEl);
                li.appendChild(addressEl);
                li.appendChild(distanceEl);
                
                fragment.appendChild(li);
            }
            
            // Ìïú Î≤àÏóê DOMÏóê Ï∂îÍ∞Ä (Î¶¨ÌîåÎ°úÏö∞ ÏµúÏÜåÌôî)
            cafeList.appendChild(fragment);
        }


        // Îß§Ïû• Í≤ÄÏÉâ Î∞è Ï≤òÎ¶¨ Í≥µÌÜµ Ìï®Ïàò (Ï§ëÎ≥µ Ï†úÍ±∞)
        async function searchAndProcessPlaces(baseX, baseY, baseAddress, radius = 750) {
            // 4Îã®Í≥Ñ: Ïπ¥Ïπ¥Ïò§ APIÎ°ú Ï†ïÌôïÌïú Î∞òÍ≤Ω Í≤ÄÏÉâ (750m Ïù¥ÎÇ¥Îßå Í≤ÄÏÉâ)
            updateProgress(30, getSearchMessage());
            const kakaoResults = await searchFromKakaoAPI(baseX, baseY, radius);
            console.log('Ïπ¥Ïπ¥Ïò§ Í≤ÄÏÉâ Í≤∞Í≥º:', kakaoResults.length, 'Í∞ú');
            
            if (kakaoResults.length === 0) {
                return [];
            }
            
            // Ïπ¥Ïπ¥Ïò§ Í≤∞Í≥ºÎ•º ÌëúÏ§Ä ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò
            const allResults = kakaoResults.map(doc => ({
                id: doc.id,
                place_name: doc.place_name,
                category_name: doc.category_name,
                address_name: doc.address_name,
                road_address: doc.road_address,
                x: doc.x,
                y: doc.y,
                distance: calculateDistance(baseY, baseX, parseFloat(doc.y), parseFloat(doc.x)),
                displayAddress: doc.road_address?.address_name || doc.address_name,
                _fromKakao: true // Ïπ¥Ïπ¥Ïò§ Í≤ÄÏÉâ Í≤∞Í≥ºÏûÑÏùÑ ÌëúÏãú
            }));
            
            console.log('Ïπ¥Ïπ¥Ïò§ Í≤ÄÏÉâ Î≥ÄÌôò ÌõÑ:', allResults.length, 'Í∞ú');
            
            if (allResults.length === 0) {
                return [];
            }
            
            // Í≤∞Í≥º Ï≤òÎ¶¨ Î∞è ÌïÑÌÑ∞ÎßÅ
            updateProgress(50, 'Í≤ÄÏÉâ Í≤∞Í≥º ÌïÑÌÑ∞ÎßÅ Ï§ë...');
            // ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ Í≤∞Í≥ºÎäî Ï¢åÌëúÍ∞Ä Ï†ïÌôïÌïòÏßÄ ÏïäÏùÑ Ïàò ÏûàÏúºÎØÄÎ°ú, 
            // processSearchResultsÏóêÏÑú Í±∞Î¶¨Î•º Ïû¨Í≥ÑÏÇ∞ÌïòÎèÑÎ°ù Ìï®
            const places = processSearchResults(allResults, baseX, baseY);
            console.log('processSearchResults ÌõÑ:', places.length, 'Í∞ú');
            
            // Í±∞Î¶¨ ÌïÑÌÑ∞ÎßÅ: ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ Í≤∞Í≥ºÎäî Ï¢åÌëúÍ∞Ä Î∂ÄÏ†ïÌôïÌïòÎØÄÎ°ú Ïó¨Í∏∞ÏÑúÎäî ÌïÑÌÑ∞ÎßÅÌïòÏßÄ ÏïäÏùå
            // Ï†ïÌôïÌïú Í±∞Î¶¨Îäî ÎÇòÏ§ëÏóê Ïπ¥Ïπ¥Ïò§ APIÎ°ú Ï¢åÌëú Î≥ÄÌôò ÌõÑ Ïû¨Í≥ÑÏÇ∞Îê®
            const placesWithinRadius = places.filter(place => {
                // ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ Í≤∞Í≥ºÎäî _naverDataÍ∞Ä ÏûàÍ≥†, Í±∞Î¶¨Í∞Ä ÏïÑÏßÅ Í≥ÑÏÇ∞ÎêòÏßÄ ÏïäÏïòÍ±∞ÎÇò Î∂ÄÏ†ïÌôïÌï®
                if (place._naverData || place._needsCoordConversion) {
                    // Í±∞Î¶¨ ÌïÑÌÑ∞ÎßÅ ÏóÜÏù¥ Î™®Îëê Ìè¨Ìï® (ÎÇòÏ§ëÏóê Ï†ïÌôïÌïú Í±∞Î¶¨Î°ú Ïû¨ÌïÑÌÑ∞ÎßÅ)
                    return true;
                }
                // Ïπ¥Ïπ¥Ïò§ Í≤ÄÏÉâ Í≤∞Í≥ºÎäî Ï†ïÌôïÌïú Í±∞Î¶¨ ÏÇ¨Ïö©
                return place.distance <= radius;
            });
            console.log('Í±∞Î¶¨ ÌïÑÌÑ∞ÎßÅ ÌõÑ:', placesWithinRadius.length, 'Í∞ú (ÎÑ§Ïù¥Î≤Ñ Í≤∞Í≥ºÎäî ÌïÑÌÑ∞ÎßÅ ÏóÜÏùå)');
            
            if (placesWithinRadius.length === 0) {
                console.log('Í±∞Î¶¨ ÌïÑÌÑ∞ÎßÅÏóêÏÑú Î™®Îì† Í≤∞Í≥º Ï†úÍ±∞Îê®');
                return [];
            }
            
            // ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ Í≤∞Í≥ºÏùò Ï¢åÌëúÎ•º Ï†ïÌôïÌïòÍ≤å Î≥¥ÏôÑ
            updateProgress(60, 'Ï£ºÏÜå Ï†ïÎ≥¥ Î≥¥ÏôÑ Ï§ë...');
            const placesWithAddress = await enrichWithAddress(placesWithinRadius);
            console.log('Ï£ºÏÜå Î≥¥ÏôÑ ÌõÑ:', placesWithAddress.length, 'Í∞ú');
            
            // Ï¢åÌëú Î≥¥ÏôÑ ÌõÑ Í±∞Î¶¨ Ïû¨Í≥ÑÏÇ∞
            placesWithAddress.forEach(place => {
                const placeX = parseFloat(place.x);
                const placeY = parseFloat(place.y);
                place.distance = calculateDistance(baseY, baseX, placeY, placeX);
                // ÎîîÎ≤ÑÍπÖ: Í±∞Î¶¨ Ï†ïÎ≥¥ Î°úÍ∑∏
                if (place.distance > radius) {
                    console.log(`Îß§Ïû• "${place.name}" Í±∞Î¶¨: ${Math.round(place.distance)}m (Ï†úÏô∏Îê®)`);
                }
            });
            
            // Í±∞Î¶¨Ïàú Ïû¨Ï†ïÎ†¨
            placesWithAddress.sort((a, b) => a.distance - b.distance);
            
            // 750m Ïù¥ÎÇ¥Îßå ÏµúÏ¢Ö Ìè¨Ìï®
            // Ïπ¥Ïπ¥Ïò§ APIÎäî Ï†ïÌôïÌïú Î∞òÍ≤Ω Í≤ÄÏÉâÏù¥ÎØÄÎ°ú 750m Ïù¥ÎÇ¥Îßå ÌïÑÌÑ∞ÎßÅ
            const placesFilteredByDistance = placesWithAddress.filter(place => {
                return place.distance <= radius; // 750m
            });
            console.log('ÏµúÏ¢Ö Í±∞Î¶¨ ÌïÑÌÑ∞ÎßÅ ÌõÑ:', placesFilteredByDistance.length, 'Í∞ú');
            
            // ÎîîÎ≤ÑÍπÖ: Í±∞Î¶¨ Î∂ÑÌè¨ ÌôïÏù∏
            if (placesWithAddress.length > 0) {
                const distances = placesWithAddress.map(p => Math.round(p.distance));
                console.log('Í±∞Î¶¨ Î∂ÑÌè¨:', distances.slice(0, 5), '... (ÏµúÏÜå:', Math.min(...distances), 'm, ÏµúÎåÄ:', Math.max(...distances), 'm)');
            }
            
            if (placesFilteredByDistance.length === 0) {
                console.log('ÏµúÏ¢Ö Í±∞Î¶¨ ÌïÑÌÑ∞ÎßÅÏóêÏÑú Î™®Îì† Í≤∞Í≥º Ï†úÍ±∞Îê®');
                // ÎîîÎ≤ÑÍπÖ: Ïôú Ï†úÍ±∞ÎêòÏóàÎäîÏßÄ ÌôïÏù∏
                if (placesWithAddress.length > 0) {
                    const minDistance = Math.min(...placesWithAddress.map(p => p.distance));
                    console.log(`Í∞ÄÏû• Í∞ÄÍπåÏö¥ Îß§Ïû• Í±∞Î¶¨: ${Math.round(minDistance)}m (ÌïÑÌÑ∞ÎßÅ Í∏∞Ï§Ä: ${radius}m)`);
                }
                return [];
            }
            
            // Í≤ÄÏ¶ù Îã®Í≥Ñ: Ïπ¥Ïπ¥Ïò§ Í≤ÄÏÉâ Í≤∞Í≥ºÎ•º ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâÏúºÎ°ú Í≤ÄÏ¶ù (ÎÑ§Ïù¥Î≤ÑÎßµÏóêÏÑú Í≤ÄÏÉâ Í∞ÄÎä•ÌïúÏßÄ ÌôïÏù∏)
            updateProgress(70, 'ÏßÄÎèÑÏóêÏÑú Í≤ÄÏÉâ ÌôïÏù∏ Ï§ë...');
            const result = await processNaverSearchAndFilter(placesFilteredByDistance, false); // Ïπ¥Ïπ¥Ïò§ Í≤ÄÏÉâ Í≤∞Í≥ºÏù¥ÎØÄÎ°ú Ï†ïÏÉÅ Í≤ÄÏ¶ù
            console.log('ÏµúÏ¢Ö Í≤ÄÏ¶ù ÌõÑ Í≤∞Í≥º:', Array.isArray(result) ? result.length : (result.placesSearchable?.length || 0), 'Í∞ú');
            
            // Íµ≠Î∞•Ïùò Í≤ΩÏö∞ Î≥¥ÏôÑ Î°úÏßÅ Ïã§Ìñâ
            if (hasSupplementLogic()) {
                const { placesSearchable, placesExcluded } = result;
                
                // Î¶¨Ïä§ÌåÖ Î≥¥ÏôÑ: ÌïúÏãù Îß§Ïû• Ï§ë Íµ≠Î∞• Î©îÎâ¥Í∞Ä ÏûàÎäî Îß§Ïû• Ï∂îÍ∞Ä
                updateProgress(85, 'Ï∂îÍ∞Ä Îß§Ïû• Í≤ÄÏÉâ Ï§ë...');
                const supplementedPlaces = await supplementWithKoreanRestaurants(placesExcluded, baseX, baseY, radius);
                
                // ÏµúÏ¢Ö Î¶¨Ïä§ÌåÖ: Í∏∞Ï°¥ Í≤ÄÏÉâ Í∞ÄÎä•Ìïú Îß§Ïû• + Î≥¥ÏôÑÎêú ÌïúÏãù Îß§Ïû•
                const finalPlaces = [...placesSearchable, ...supplementedPlaces];
                // Í±∞Î¶¨ÏàúÏúºÎ°ú Ïû¨Ï†ïÎ†¨
                finalPlaces.sort((a, b) => a.distance - b.distance);
                
                return finalPlaces;
            }
            
            // ÏùºÎ∞òÏ†ÅÏù∏ Í≤ΩÏö∞ (Ïπ¥Ìéò, ÎßàÎùºÌÉï, ÎπµÏßë)
            return result;
        }

        // Ïπ¥Ìéò Í≤ÄÏÉâ
        async function searchCafes(address) {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const resultsSection = document.getElementById('resultsSection');
            const cafeList = document.getElementById('cafeList');
            const resultsHeader = document.getElementById('resultsHeader');

            // UI Ï¥àÍ∏∞Ìôî
            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            resultsSection.style.display = 'none';
            cafeList.innerHTML = '';
            updateProgress(0, 'Í≤ÄÏÉâ Ï§ÄÎπÑ Ï§ë...');

            try {
                // 1Îã®Í≥Ñ: Ïπ¥Ïπ¥Ïò§ APIÎ°ú Ï£ºÏÜåÎ•º Ï¢åÌëúÎ°ú Î≥ÄÌôò
                updateProgress(10, 'Ï£ºÏÜå Í≤ÄÏÉâ Ï§ë...');
                const addressData = await callKakaoAPI('address', {
                    query: address,
                    size: 1
                });

                if (!addressData.documents || addressData.documents.length === 0) {
                    throw new Error('Ï£ºÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Ï£ºÏÜå ÌòïÏãùÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
                }

                const location = addressData.documents[0];
                const baseX = parseFloat(location.x);
                const baseY = parseFloat(location.y);
                const radius = 750;
                
                // Í≤ÄÏÉâ Í∏∞Ï§Ä Ï£ºÏÜå (ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâÏóê ÏÇ¨Ïö©)
                const searchBaseAddress = address;
                
                updateProgress(30, getSearchMessage());
                const cafesSearchable = await searchAndProcessPlaces(baseX, baseY, searchBaseAddress, radius);
                
                updateProgress(100, 'Í≤ÄÏÉâ ÏôÑÎ£å!');

                if (cafesSearchable.length === 0) {
                    loadingEl.style.display = 'none';
                    showNoResults();
                    return;
                }

                // Î®ºÏ†Ä Î°úÎî© Ïï†ÎãàÎ©îÏù¥ÏÖò Ïà®Í∏∞Í∏∞ (Í≤∞Í≥º ÌëúÏãú Ï†ÑÏóê)
                loadingEl.style.display = 'none';

                // Ïπ¥Ìéò Î™©Î°ù ÌëúÏãú (Í≥µÌÜµ Ìï®Ïàò ÏÇ¨Ïö©)
                renderCafeList(cafesSearchable, resultsHeader, resultsSection, cafeList);

            } catch (error) {
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                
                // Îçî Î™ÖÌôïÌïú ÏóêÎü¨ Î©îÏãúÏßÄ
                let errorMessage = 'Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                
                if (error.message && error.message.includes('Failed to fetch')) {
                    errorMessage = 'ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§. Î°úÏª¨ ÌÖåÏä§Ìä∏Î•º ÏúÑÌï¥ÏÑúÎäî Vercel CLIÎ•º ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî.\n\nÌÑ∞ÎØ∏ÎÑêÏóêÏÑú Îã§Ïùå Î™ÖÎ†πÏñ¥Î•º Ïã§ÌñâÌïòÏÑ∏Ïöî:\n1. npm i -g vercel\n2. vercel dev';
                } else if (error.message && error.message.includes('Ï£ºÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§')) {
                    errorMessage = error.message;
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                // Ï§ÑÎ∞îÍøàÏùÑ HTMLÎ°ú Î≥ÄÌôò
                errorMessage = errorMessage.replace(/\n/g, '<br>');
                errorEl.innerHTML = errorMessage;
                console.error('Í≤ÄÏÉâ Ïò§Î•ò:', error);
            }
        }

        // ============================================
        // ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ ÌïÑÌÑ∞ÎßÅ Ìï®Ïàò (5Îã®Í≥Ñ)
        // ============================================
        
        // ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ Í≤∞Í≥º Í∞ÄÏ†∏Ïò§Í∏∞ (ÏäàÌçºÌå®Ïä§ Ïö∞Ìöå Î°úÏßÅ Ìè¨Ìï®, Î©îÎâ¥Î≥Ñ Ïπ¥ÌÖåÍ≥†Î¶¨ ÌôïÏù∏)
        async function getNaverSearchInfo(place) {
            try {
                const categorySelect = document.getElementById('categorySelect');
                const selectedMenu = categorySelect?.value || 'Ïπ¥Ìéò';
                
                // ÏäàÌçºÌå®Ïä§ ÌÇ§ÏõåÎìúÍ∞Ä ÏûàÏúºÎ©¥ ÌïÑÌÑ∞ÎßÅ Ïö∞Ìöå
                if (hasSuperpassKeyword(place.name)) {
                    console.log('ÏäàÌçºÌå®Ïä§ ÌÇ§ÏõåÎìú Îß§Ïû• - ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ ÌïÑÌÑ∞ÎßÅ Ïö∞Ìöå:', place.name);
                    let floorInfo = place.floor || '';
                    
                    // Ï∏µ Ï†ïÎ≥¥Í∞Ä ÏóÜÏúºÎ©¥ ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâÏúºÎ°ú Ï°∞Ìöå ÏãúÎèÑ
                    if (!floorInfo) {
                        try {
                            const address = place.displayAddress || place.roadAddress || place.address || '';
                            const searchQuery = address
                                ? `${place.name} ${address.split(' ').slice(0, 2).join(' ')}`
                                : place.name;
                            
                            const naverResult = await callNaverAPI('local', {
                                query: searchQuery,
                                display: 1,
                                sort: 'random'
                            });
                            
                            if (naverResult.items?.length > 0) {
                                const item = naverResult.items[0];
                                const title = (item.title || '').replace(/<[^>]*>/g, '');
                                const resultAddress = (item.address || '').replace(/<[^>]*>/g, '');
                                const resultRoadAddress = (item.roadAddress || '').replace(/<[^>]*>/g, '');
                                
                                const floorFromTitle = extractFloorInfo(title);
                                const floorFromAddress = extractFloorInfo(resultAddress + ' ' + resultRoadAddress);
                                floorInfo = floorFromTitle || floorFromAddress || '';
                            }
                        } catch (error) {
                            console.warn('ÏäàÌçºÌå®Ïä§ Îß§Ïû• Ï∏µ Ï†ïÎ≥¥ Ï°∞Ìöå Ïã§Ìå®:', place.name, error);
                        }
                    }
                    
                    return { isSearchable: true, floorInfo };
                }
                
                // ÏùºÎ∞ò ÌïÑÌÑ∞ÎßÅ Î°úÏßÅ ÏßÑÌñâ
                const address = place.displayAddress || place.roadAddress || place.address || '';
                
                // Ï£ºÏÜåÎ•º ÎÑ§Ïù¥Î≤ÑÎßµ Í≤ÄÏÉâÍ≥º ÎèôÏùºÌïòÍ≤å Ï≤òÎ¶¨ (Í±¥Î¨ºÎ≤àÌò∏ Ï†úÍ±∞)
                const processAddressForSearch = (addr) => {
                    if (!addr) return '';
                    const addressParts = addr.split(' ');
                    // Ïãú/ÎèÑ Ï†úÍ±∞ÌïòÍ≥† Íµ¨/Îèô/Î°ú/Í∏∏ Ìè¨Ìï®
                    let simplifiedAddress = addressParts.slice(1).join(' ') || addr;
                    // Í±¥Î¨ºÎ≤àÌò∏ Ï†úÍ±∞ (ÎßàÏßÄÎßâ Ïà´Ïûê Ìå®ÌÑ¥ Ï†úÍ±∞)
                    simplifiedAddress = simplifiedAddress.replace(/\s+\d+(\s*Î≤àÏßÄ)?\s*$/, '').trim();
                    return simplifiedAddress;
                };
                
                // 1Ï∞® Í≤ÄÏÉâ: Îß§Ïû•Î™ÖÏπ≠ + Ï£ºÏÜå (Í±¥Î¨ºÎ≤àÌò∏ Ï†úÏô∏, ÎÑ§Ïù¥Î≤ÑÎßµÍ≥º ÎèôÏùº)
                let searchQueryWithAddress = place.name;
                if (address) {
                    const processedAddress = processAddressForSearch(address);
                    searchQueryWithAddress = `${place.name} ${processedAddress}`;
                }
                
                // ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ APIÎ°ú 1Ï∞® Í≤ÄÏÉâ Í≤∞Í≥º ÌôïÏù∏
                const searchResult = await callNaverAPI('local', {
                    query: searchQueryWithAddress,
                    display: 10, // Îçî ÎßéÏùÄ Í≤∞Í≥º ÌôïÏù∏
                    sort: 'random'
                });
                
                let floorInfo = place.floor || '';
                let isSearchable = false;
                
                // Î©îÎâ¥Î≥Ñ Ïπ¥ÌÖåÍ≥†Î¶¨ ÌôïÏù∏ Ìï®Ïàò
                const checkCategory = (resultTitle, resultCategory, resultDescription = '') => {
                    const category = resultCategory || '';
                    const title = resultTitle.toLowerCase();
                    const description = resultDescription.toLowerCase();
                    
                    if (selectedMenu === 'Ïπ¥Ìéò') {
                        return category.includes('Ïπ¥Ìéò') || category.includes('cafe') || category.startsWith('Ïπ¥Ìéò');
                    } else if (selectedMenu === 'ÎßàÎùºÌÉï') {
                        return category.includes('ÎßàÎùºÌÉï') || category.includes('malatang') || 
                               title.includes('ÎßàÎùºÌÉï') || title.includes('ÎßàÎùºÏÉπÍ∂à');
                    } else if (selectedMenu === 'Îπµ') {
                        const bakeryKeywords = ['Î≤†Ïù¥Ïª§Î¶¨', 'bakery', 'ÎπµÏßë', 'Ï†úÍ≥º', 'Ï†úÎπµ', 'Îπµ', 'bread', 'ÌååÌã∞Ïä§Î¶¨', 'patisserie',
                            'ÏÜåÎ≥¥Î°ú', 'Îã®Ìå•Îπµ', 'ÌÅ¨Î¶ºÎπµ', 'ÏãùÎπµ', 'Î∞îÍ≤åÌä∏', 'baguette', 'ÌÅ¨Î£®ÏïÑÏÉÅ', 'croissant', 'Î≤†Ïù¥Í∏Ä', 'bagel',
                            'ÏºÄÏù¥ÌÅ¨', 'cake', 'ÎèÑÎÑõ', 'donut', 'Î®∏ÌïÄ', 'muffin', 'Ïø†ÌÇ§', 'cookie'];
                        const hasBakeryKeyword = bakeryKeywords.some(keyword => category.includes(keyword));
                        const excludedKeywords = ['Î†àÏä§ÌÜ†Îûë', 'restaurant', 'ÏùåÏãùÏ†ê', 'Ïà†Ïßë', 'Î∞î', 'bar', 'ÏπòÌÇ®', 'chicken', 'ÌîºÏûê', 'pizza', 'ÌïúÏãù', 'Ï§ëÏãù', 'ÏùºÏãù', 'ÏñëÏãù', 'ÎßàÎùºÌÉï', 'malatang'];
                        const isExcluded = excludedKeywords.some(keyword => category.includes(keyword));
                        return hasBakeryKeyword && !isExcluded;
                    } else if (selectedMenu === 'Íµ≠Î∞•') {
                        // Íµ≠Î∞• Ïπ¥ÌÖåÍ≥†Î¶¨Îäî 'ÌïúÏãù' Ìè¨Ìï® ÎòêÎäî Ïù¥Î¶Ñ/ÏÑ§Î™ÖÏóê Íµ≠Î∞• Í¥ÄÎ†® ÌÇ§ÏõåÎìú ÌôïÏù∏
                        const soupKeywords = ['ÏàúÎåÄÍµ≠', 'ÏÑ§Î†ÅÌÉï', 'Í≥∞ÌÉï', 'Íµ≠Î∞•', 'ÏàúÎåìÍµ≠', 'Ìï¥Ïû•Íµ≠', 'Í∞êÏûêÌÉï', 'Ïú°Í∞úÏû•'];
                        const menuText = `${title} ${description}`.toLowerCase();
                        return category.includes('ÌïúÏãù') || category.includes('korean') || 
                               soupKeywords.some(keyword => menuText.includes(keyword.toLowerCase()));
                    } else if (selectedMenu === 'ÍπÄÎ∞•') {
                        // ÍπÄÎ∞• Ïπ¥ÌÖåÍ≥†Î¶¨Îäî Î∂ÑÏãù, ÍπÄÎ∞• Í¥ÄÎ†® ÌÇ§ÏõåÎìú ÌôïÏù∏
                        const kimbapKeywords = ['ÍπÄÎ∞•', 'kimbap', 'ÍπÄÎ∞•Ï≤úÍµ≠', 'ÍπÄÎ∞•Ïßë', 'Î∂ÑÏãù', 'Î∂ÑÏãùÏßë'];
                        const menuText = `${title} ${description}`.toLowerCase();
                        return kimbapKeywords.some(keyword => 
                            category.includes(keyword) || menuText.includes(keyword.toLowerCase())
                        );
                    }
                    return false;
                };
                
                // Ï£ºÏÜå Îß§Ïπ≠ ÌôïÏù∏ Ìï®Ïàò (Îçî ÏóÑÍ≤©Ìïú Îß§Ïπ≠)
                const checkAddressMatch = (resultAddress, resultRoadAddress, originalAddress) => {
                    if (!originalAddress) return true; // ÏõêÎ≥∏ Ï£ºÏÜåÍ∞Ä ÏóÜÏúºÎ©¥ ÌÜµÍ≥º
                    
                    const processedOriginal = processAddressForSearch(originalAddress).toLowerCase();
                    const processedRoad = processAddressForSearch(resultRoadAddress || '').toLowerCase();
                    const processedAddress = processAddressForSearch(resultAddress || '').toLowerCase();
                    
                    // ÎèÑÎ°úÎ™Ö Ï£ºÏÜå Ïö∞ÏÑ† Îß§Ïπ≠
                    if (resultRoadAddress) {
                        // ÌïµÏã¨ ÌÇ§ÏõåÎìú Ï∂îÏ∂ú (Íµ¨, Îèô, Î°ú, Í∏∏ Îì±)
                        const originalKeyParts = processedOriginal.split(' ').filter(part => 
                            part.length > 1 && !/^\d+$/.test(part)
                        );
                        const roadKeyParts = processedRoad.split(' ').filter(part => 
                            part.length > 1 && !/^\d+$/.test(part)
                        );
                        
                        // Ï£ºÏöî ÌÇ§ÏõåÎìúÍ∞Ä ÏùºÏπòÌïòÎäîÏßÄ ÌôïÏù∏ (2Í∞ú Ïù¥ÏÉÅ ÏùºÏπò)
                        const matchingParts = originalKeyParts.filter(part => 
                            roadKeyParts.some(rPart => rPart.includes(part) || part.includes(rPart))
                        );
                        if (matchingParts.length >= Math.min(2, originalKeyParts.length)) {
                            return true;
                        }
                    }
                    
                    // ÏßÄÎ≤à Ï£ºÏÜå Îß§Ïπ≠
                    if (resultAddress) {
                        const originalKeyParts = processedOriginal.split(' ').filter(part => 
                            part.length > 1 && !/^\d+$/.test(part)
                        );
                        const addressKeyParts = processedAddress.split(' ').filter(part => 
                            part.length > 1 && !/^\d+$/.test(part)
                        );
                        
                        const matchingParts = originalKeyParts.filter(part => 
                            addressKeyParts.some(aPart => aPart.includes(part) || part.includes(aPart))
                        );
                        if (matchingParts.length >= Math.min(2, originalKeyParts.length)) {
                            return true;
                        }
                    }
                    
                    return false;
                };
                
                // Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏûàÍ≥†, Ï≤´ Î≤àÏß∏ Í≤∞Í≥ºÍ∞Ä Îß§Ïû•Í≥º Ï†ïÌôïÌûà ÏùºÏπòÌïòÎäîÏßÄ ÌôïÏù∏
                if (searchResult.items && searchResult.items.length > 0) {
                    // Ï≤´ Î≤àÏß∏ Í≤∞Í≥ºÎ∂ÄÌÑ∞ ÌôïÏù∏ (Ïö∞ÏÑ†ÏàúÏúÑÍ∞Ä ÎÜíÏùÄ Í≤∞Í≥ºÎ∂ÄÌÑ∞)
                    for (const item of searchResult.items) {
                        const resultTitle = (item.title || '').replace(/<[^>]*>/g, '');
                        const resultCategory = (item.category || '').toLowerCase();
                        const resultDescription = (item.description || '').replace(/<[^>]*>/g, '').toLowerCase();
                        const resultAddress = (item.address || '').replace(/<[^>]*>/g, '');
                        const resultRoadAddress = (item.roadAddress || '').replace(/<[^>]*>/g, '');
                        
                        // 1. Îß§Ïû• Ïù¥Î¶ÑÏù¥ Í≤ÄÏÉâ Í≤∞Í≥º Ï†úÎ™©Ïóê Ï†ïÌôïÌûà Ìè¨Ìï®ÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏
                        const nameMatches = resultTitle.includes(place.name) || place.name.includes(resultTitle.split(' ')[0]);
                        
                        // 2. Ï£ºÏÜå Îß§Ïπ≠ ÌôïÏù∏ (Í∞ïÌôîÎêú Í≤ÄÏ¶ù)
                        const addressMatches = checkAddressMatch(resultAddress, resultRoadAddress, address);
                        
                        // 3. Î©îÎâ¥Î≥Ñ Ïπ¥ÌÖåÍ≥†Î¶¨ ÌôïÏù∏
                        const isValidCategory = checkCategory(resultTitle, resultCategory, resultDescription);
                        
                        // Î™®Îì† Ï°∞Í±¥Ïù¥ Ï∂©Ï°±ÎêòÏñ¥Ïïº Í≤ÄÏÉâ Í∞ÄÎä•ÏúºÎ°ú ÌåêÎã®
                        if (nameMatches && addressMatches && isValidCategory) {
                            isSearchable = true;
                            // Ï∏µ Ï†ïÎ≥¥Í∞Ä ÏóÜÏúºÎ©¥ Ï∂îÏ∂ú
                            if (!floorInfo) {
                                const floorFromTitle = extractFloorInfo(resultTitle);
                                const floorFromAddress = extractFloorInfo(resultAddress + ' ' + resultRoadAddress);
                                floorInfo = floorFromTitle || floorFromAddress || '';
                            }
                            break; // ÏùºÏπòÌïòÎäî Í≤∞Í≥ºÎ•º Ï∞æÏïòÏúºÎ©¥ Ï§ëÎã®
                        }
                    }
                }
                
                // 1Ï∞® Í≤ÄÏÉâ Ïã§Ìå® Ïãú 2Ï∞® Í≤ÄÏÉâ: Îß§Ïû•Î™ÖÏπ≠Îßå (Ï£ºÏÜå ÏóÜÏù¥ Í≤ÄÏÉâ)
                // Ï£ºÏùò: Îß§Ïû•Î™ÖÏπ≠ÎßåÏúºÎ°ú Í≤ÄÏÉâÌï† ÎïåÎäî Ï£ºÏÜå Îß§Ïπ≠Ïù¥ Ïñ¥Î†µÍ∏∞ ÎïåÎ¨∏Ïóê Îçî ÏóÑÍ≤©Ìïú Ïù¥Î¶Ñ Îß§Ïπ≠ Ï†ÅÏö©
                if (!isSearchable && address) {
                    // Ï£ºÏÜåÍ∞Ä ÏûàÏùÑ ÎïåÎßå Îß§Ïû•Î™ÖÏπ≠ÎßåÏúºÎ°ú 2Ï∞® Í≤ÄÏÉâ ÏãúÎèÑ
                    const searchResultNameOnly = await callNaverAPI('local', {
                        query: place.name,
                        display: 10, // Îçî ÎßéÏùÄ Í≤∞Í≥º ÌôïÏù∏
                        sort: 'random'
                    });
                    
                    // Îß§Ïû•Î™ÖÏπ≠ÎßåÏúºÎ°ú Í≤ÄÏÉâ Í≤∞Í≥º ÌôïÏù∏ (Ï£ºÏÜå Îß§Ïπ≠ ÌïÑÏàò)
                    if (searchResultNameOnly.items && searchResultNameOnly.items.length > 0) {
                        for (const item of searchResultNameOnly.items) {
                            const resultTitle = (item.title || '').replace(/<[^>]*>/g, '');
                            const resultCategory = (item.category || '').toLowerCase();
                            const resultDescription = (item.description || '').replace(/<[^>]*>/g, '').toLowerCase();
                            const resultAddress = (item.address || '').replace(/<[^>]*>/g, '');
                            const resultRoadAddress = (item.roadAddress || '').replace(/<[^>]*>/g, '');
                            
                            // 1. Îß§Ïû• Ïù¥Î¶ÑÏù¥ Í≤ÄÏÉâ Í≤∞Í≥º Ï†úÎ™©Ïóê Ï†ïÌôïÌûà Ìè¨Ìï®ÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏ (Îçî ÏóÑÍ≤©)
                            const nameMatches = resultTitle.includes(place.name) || place.name.includes(resultTitle.split(' ')[0]);
                            
                            // 2. Ï£ºÏÜå Îß§Ïπ≠ ÌôïÏù∏ (Îß§Ïû•Î™ÖÎßå Í≤ÄÏÉâÏù¥ÎØÄÎ°ú Ï£ºÏÜå Îß§Ïπ≠ ÌïÑÏàò)
                            const addressMatches = checkAddressMatch(resultAddress, resultRoadAddress, address);
                            
                            // 3. Î©îÎâ¥Î≥Ñ Ïπ¥ÌÖåÍ≥†Î¶¨ ÌôïÏù∏
                            const isValidCategory = checkCategory(resultTitle, resultCategory, resultDescription);
                            
                            // Î™®Îì† Ï°∞Í±¥Ïù¥ Ï∂©Ï°±ÎêòÏñ¥Ïïº Í≤ÄÏÉâ Í∞ÄÎä•ÏúºÎ°ú ÌåêÎã®
                            if (nameMatches && addressMatches && isValidCategory) {
                                isSearchable = true;
                                // Ï∏µ Ï†ïÎ≥¥Í∞Ä ÏóÜÏúºÎ©¥ Ï∂îÏ∂ú
                                if (!floorInfo) {
                                    const floorFromTitle = extractFloorInfo(resultTitle);
                                    const floorFromAddress = extractFloorInfo(resultAddress + ' ' + resultRoadAddress);
                                    floorInfo = floorFromTitle || floorFromAddress || '';
                                }
                                break; // ÏùºÏπòÌïòÎäî Í≤∞Í≥ºÎ•º Ï∞æÏïòÏúºÎ©¥ Ï§ëÎã®
                            }
                        }
                    }
                }
                
                return { isSearchable, floorInfo };
            } catch (error) {
                console.warn('ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ Ï†ïÎ≥¥ Ï°∞Ìöå Ïã§Ìå®:', place.name, error);
                // ÏóêÎü¨ Î∞úÏÉù Ïãú Í≤ÄÏÉâ Í∞ÄÎä•Ìïú Í≤ÉÏúºÎ°ú Í∞ÑÏ£ºÌïòÏßÄ ÏïäÏùå
                return { isSearchable: false, floorInfo: place.floor || '' };
            }
        }
        
        // ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ Î∞è ÌïÑÌÑ∞ÎßÅ Í≥µÌÜµ Ìï®Ïàò (5Îã®Í≥Ñ)
        async function processNaverSearchAndFilter(placesWithAddress, isFromNaverSearch = false) {
            const placesSearchable = [];
            const placesExcluded = []; // Íµ≠Î∞•Ïùò Í≤ΩÏö∞ Ï†úÏô∏Îêú Îß§Ïû•Îì§ Ï†ÄÏû•
            const batchSize = 5;
            const totalBatches = Math.ceil(placesWithAddress.length / batchSize);
            const needExcludedList = hasSupplementLogic(); // Íµ≠Î∞•Ïùò Í≤ΩÏö∞ true
            
            // ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâÏúºÎ°ú ÏÑ†Ï†ïÎêú Îß§Ïû•Ïù∏ Í≤ΩÏö∞ Í≤ÄÏ¶ù Í∞ÑÏÜåÌôî
            if (isFromNaverSearch) {
                // Ïù¥ÎØ∏ ÎÑ§Ïù¥Î≤ÑÎßµÏóê ÏûàÎäî Îß§Ïû•Ïù¥ÎØÄÎ°ú, Ïπ¥ÌÖåÍ≥†Î¶¨ ÌôïÏù∏Îßå ÏàòÌñâ
                for (const place of placesWithAddress) {
                    const categorySelect = document.getElementById('categorySelect');
                    const selectedMenu = categorySelect?.value || 'Ïπ¥Ìéò';
                    
                    // ÏäàÌçºÌå®Ïä§ ÌÇ§ÏõåÎìú ÌôïÏù∏
                    if (hasSuperpassKeyword(place.name)) {
                        placesSearchable.push(place);
                        continue;
                    }
                    
                    // Ïπ¥Ïπ¥Ïò§ Í≤ÄÏÉâ Í≤∞Í≥ºÎäî Ïù¥ÎØ∏ processSearchResultsÏóêÏÑú ÌïÑÌÑ∞ÎßÅÎêòÏóàÏúºÎØÄÎ°ú
                    // ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ Ïö∞ÏÑ† Î™®ÎìúÏóêÏÑúÎäî Ïπ¥ÌÖåÍ≥†Î¶¨ ÌôïÏù∏ÏùÑ Îçî Í¥ÄÎåÄÌïòÍ≤å ÏàòÌñâ
                    if (place._fromKakao) {
                        // Ïπ¥Ïπ¥Ïò§ Í≤ÄÏÉâ Í≤∞Í≥ºÎäî Ïù¥ÎØ∏ Ïπ¥ÌÖåÍ≥†Î¶¨ ÌïÑÌÑ∞ÎßÅÏùÑ Î∞õÏïòÏúºÎØÄÎ°ú Ìè¨Ìï®
                        placesSearchable.push(place);
                        continue;
                    }
                    
                    // ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ Í≤∞Í≥ºÎßå Ïπ¥ÌÖåÍ≥†Î¶¨ ÌôïÏù∏
                    const categoryName = place.category_name || '';
                    const checkCategory = (categoryName) => {
                        const category = (categoryName || '').toLowerCase();
                        
                        if (selectedMenu === 'Ïπ¥Ìéò') {
                            return category.includes('Ïπ¥Ìéò') || category.includes('cafe') || category.startsWith('Ïπ¥Ìéò');
                        } else if (selectedMenu === 'ÎßàÎùºÌÉï') {
                            return category.includes('ÎßàÎùºÌÉï') || category.includes('malatang');
                        } else if (selectedMenu === 'Îπµ') {
                            const bakeryKeywords = ['Î≤†Ïù¥Ïª§Î¶¨', 'bakery', 'ÎπµÏßë', 'Ï†úÍ≥º', 'Ï†úÎπµ', 'Îπµ', 'bread', 'ÌååÌã∞Ïä§Î¶¨', 'patisserie'];
                            const hasBakeryKeyword = bakeryKeywords.some(keyword => category.includes(keyword));
                            const excludedKeywords = ['Î†àÏä§ÌÜ†Îûë', 'restaurant', 'ÏùåÏãùÏ†ê', 'Ïà†Ïßë', 'Î∞î', 'bar', 'ÏπòÌÇ®', 'chicken', 'ÌîºÏûê', 'pizza', 'ÌïúÏãù', 'Ï§ëÏãù', 'ÏùºÏãù', 'ÏñëÏãù', 'ÎßàÎùºÌÉï', 'malatang'];
                            const isExcluded = excludedKeywords.some(keyword => category.includes(keyword));
                            return hasBakeryKeyword && !isExcluded;
                        } else if (selectedMenu === 'Íµ≠Î∞•') {
                            // Íµ≠Î∞•ÏùÄ Ïπ¥ÌÖåÍ≥†Î¶¨ÎÇò Ïù¥Î¶ÑÏóê Íµ≠Î∞• Í¥ÄÎ†® ÌÇ§ÏõåÎìú ÌôïÏù∏
                            const soupKeywords = ['ÏàúÎåÄÍµ≠', 'ÏÑ§Î†ÅÌÉï', 'Í≥∞ÌÉï', 'Íµ≠Î∞•', 'ÏàúÎåìÍµ≠', 'Ìï¥Ïû•Íµ≠', 'Í∞êÏûêÌÉï', 'Ïú°Í∞úÏû•'];
                            const title = place.name.toLowerCase();
                            const desc = (place._naverData?.description || '').replace(/<[^>]*>/g, '').toLowerCase();
                            const menuText = `${title} ${desc} ${categoryName}`.toLowerCase();
                            return categoryName.includes('ÌïúÏãù') || categoryName.includes('korean') ||
                                   soupKeywords.some(keyword => menuText.includes(keyword.toLowerCase()));
                        } else if (selectedMenu === 'ÍπÄÎ∞•') {
                            // ÍπÄÎ∞•ÏùÄ Ïπ¥ÌÖåÍ≥†Î¶¨ÎÇò Ïù¥Î¶ÑÏóê ÍπÄÎ∞•/Î∂ÑÏãù Í¥ÄÎ†® ÌÇ§ÏõåÎìú ÌôïÏù∏
                            const kimbapKeywords = ['ÍπÄÎ∞•', 'kimbap', 'ÍπÄÎ∞•Ï≤úÍµ≠', 'ÍπÄÎ∞•Ïßë', 'Î∂ÑÏãù', 'Î∂ÑÏãùÏßë'];
                            const title = place.name.toLowerCase();
                            const desc = (place._naverData?.description || '').replace(/<[^>]*>/g, '').toLowerCase();
                            const menuText = `${title} ${desc} ${categoryName}`.toLowerCase();
                            return kimbapKeywords.some(keyword => 
                                categoryName.includes(keyword) || menuText.includes(keyword.toLowerCase())
                            );
                        }
                        return true;
                    };
                    
                    if (checkCategory(categoryName)) {
                        placesSearchable.push(place);
                    } else if (needExcludedList && selectedMenu === 'Íµ≠Î∞•') {
                        // Íµ≠Î∞•Ïùò Í≤ΩÏö∞ Ï∂îÍ∞Ä ÌôïÏù∏ ÌõÑ Ï†úÏô∏ Î™©Î°ùÏóê Ï∂îÍ∞Ä (Î≥¥ÏôÑ Î°úÏßÅÏóêÏÑú Ï≤òÎ¶¨)
                        placesExcluded.push(place);
                    }
                }
                
                // Íµ≠Î∞•Ïùò Í≤ΩÏö∞ Ï†úÏô∏Îêú Îß§Ïû• Î™©Î°ùÎèÑ Î∞òÌôò
                if (needExcludedList) {
                    return { placesSearchable, placesExcluded };
                }
                
                return placesSearchable;
            }
            
            for (let i = 0; i < placesWithAddress.length; i += batchSize) {
                const batch = placesWithAddress.slice(i, i + batchSize);
                const currentBatch = Math.floor(i / batchSize) + 1;
                
                // ÌîÑÎ°úÍ∑∏Î†àÏä§ ÏóÖÎç∞Ïù¥Ìä∏ (70% ~ 95%)
                const progressPercent = 70 + Math.floor((currentBatch / totalBatches) * 25);
                updateProgress(progressPercent, `ÏßÄÎèÑÏóêÏÑú Í≤ÄÏÉâ ÌôïÏù∏ Ï§ë... (${currentBatch}/${totalBatches})`);
                
                const batchResults = await Promise.all(
                    batch.map(async (place) => {
                        try {
                            // ÏäàÌçºÌå®Ïä§ ÌÇ§ÏõåÎìúÍ∞Ä ÏûàÏúºÎ©¥ ÌïÑÌÑ∞ÎßÅ Ïö∞Ìöå
                            if (hasSuperpassKeyword(place.name)) {
                                console.log(`ÏäàÌçºÌå®Ïä§ ÌÇ§ÏõåÎìú Îß§Ïû• - Î¶¨Ïä§ÌåÖ Ï†úÏô∏ ÌïÑÌÑ∞ Ïö∞Ìöå [${place.name}]`);
                                
                                // Ï∏µ Ï†ïÎ≥¥Í∞Ä ÏóÜÏúºÎ©¥ ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâÏúºÎ°ú Ï°∞Ìöå ÏãúÎèÑ
                                if (!place.floor) {
                                    try {
                                        const address = place.displayAddress || place.roadAddress || place.address || '';
                                        const searchQuery = address
                                            ? `${place.name} ${address.split(' ').slice(0, 2).join(' ')}`
                                            : place.name;
                                        
                                        const naverResult = await callNaverAPI('local', {
                                            query: searchQuery,
                                            display: 1,
                                            sort: 'random'
                                        });
                                        
                                        if (naverResult.items?.length > 0) {
                                            const item = naverResult.items[0];
                                            const title = (item.title || '').replace(/<[^>]*>/g, '');
                                            const resultAddress = (item.address || '').replace(/<[^>]*>/g, '');
                                            const resultRoadAddress = (item.roadAddress || '').replace(/<[^>]*>/g, '');
                                            
                                            const floorFromTitle = extractFloorInfo(title);
                                            const floorFromAddress = extractFloorInfo(resultAddress + ' ' + resultRoadAddress);
                                            place.floor = floorFromTitle || floorFromAddress || '';
                                        }
                                    } catch (error) {
                                        console.warn('ÏäàÌçºÌå®Ïä§ Îß§Ïû• Ï∏µ Ï†ïÎ≥¥ Ï°∞Ìöå Ïã§Ìå®:', place.name, error);
                                    }
                                }
                                
                                return { place, isSearchable: true };
                            }
                            
                            // ÏùºÎ∞ò ÌïÑÌÑ∞ÎßÅ Î°úÏßÅ ÏßÑÌñâ
                            const { isSearchable, floorInfo } = await getNaverSearchInfo(place);
                            
                            if (isSearchable) {
                                if (floorInfo) {
                                    place.floor = floorInfo;
                                }
                                console.log(`ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ Í∞ÄÎä• Î∞è Ïπ¥ÌÖåÍ≥†Î¶¨ ÌôïÏù∏ ÏôÑÎ£å [${place.name}]`);
                                return { place, isSearchable: true };
                            } else {
                                console.log(`ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ Î∂àÍ∞ÄÎä• ÎòêÎäî Ïπ¥ÌÖåÍ≥†Î¶¨Í∞Ä ÎßûÏßÄ ÏïäÏùå - Î¶¨Ïä§ÌåÖ Ï†úÏô∏ [${place.name}]`);
                                return { place, isSearchable: false };
                            }
                        } catch (error) {
                            console.warn('ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ Ï†ïÎ≥¥ Ï°∞Ìöå Ïã§Ìå®:', place.name, error);
                            return { place, isSearchable: false };
                        }
                    })
                );
                
                for (const result of batchResults) {
                    if (result.isSearchable) {
                        placesSearchable.push(result.place);
                    } else {
                        if (needExcludedList) {
                            placesExcluded.push(result.place);
                        }
                    }
                }
                
                if (i + batchSize < placesWithAddress.length) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }
            
            // Íµ≠Î∞•Ïùò Í≤ΩÏö∞ Ï†úÏô∏Îêú Îß§Ïû• Î™©Î°ùÎèÑ Î∞òÌôò
            if (needExcludedList) {
                return { placesSearchable, placesExcluded };
            }
            
            // ÏùºÎ∞òÏ†ÅÏù∏ Í≤ΩÏö∞ (Ïπ¥Ìéò, ÎßàÎùºÌÉï, ÎπµÏßë)
            return placesSearchable;
        }

        // ÌïúÏãù Îß§Ïû•ÏóêÏÑú Íµ≠Î∞• Î©îÎâ¥ ÌôïÏù∏ (Íµ≠Î∞• Ï†ÑÏö©)
        function checkKoreanRestaurantWithSoupMenu(item, restaurantName) {
            const resultTitle = (item.title || '').replace(/<[^>]*>/g, '');
            const resultCategory = (item.category || '').toLowerCase();
            const resultDescription = (item.description || '').replace(/<[^>]*>/g, '').toLowerCase();
            
            const nameMatches = resultTitle.includes(restaurantName) || restaurantName.includes(resultTitle.split(' ')[0]);
            const isKoreanFood = resultCategory.includes('ÌïúÏãù') || resultCategory.includes('korean');
            
            if (nameMatches && isKoreanFood) {
                const menuText = `${resultTitle} ${resultDescription}`.toLowerCase();
                const soupKeywords = ['ÏàúÎåÄÍµ≠', 'ÏÑ§Î†ÅÌÉï', 'Í≥∞ÌÉï', 'Íµ≠Î∞•', 'ÏàúÎåìÍµ≠', 'Ìï¥Ïû•Íµ≠', 'Í∞êÏûêÌÉï', 'Ïú°Í∞úÏû•'];
                const hasSoupMenu = soupKeywords.some(keyword => 
                    menuText.includes(keyword.toLowerCase())
                );
                
                if (hasSoupMenu) {
                    return {
                        isValid: true,
                        title: resultTitle,
                        address: (item.address || '').replace(/<[^>]*>/g, ''),
                        roadAddress: (item.roadAddress || '').replace(/<[^>]*>/g, '')
                    };
                }
            }
            return { isValid: false };
        }

        // Î¶¨Ïä§ÌåÖ Î≥¥ÏôÑ: ÌïúÏãù Îß§Ïû• Ï§ë Íµ≠Î∞• Î©îÎâ¥Í∞Ä ÏûàÎäî Îß§Ïû• Ï∂îÍ∞Ä (Íµ≠Î∞• Ï†ÑÏö©)
        async function supplementWithKoreanRestaurants(placesExcluded, baseX, baseY, radius = 750) {
            const supplementedPlaces = [];
            const batchSize = 5;
            
            for (let i = 0; i < placesExcluded.length; i += batchSize) {
                const batch = placesExcluded.slice(i, i + batchSize);
                
                const batchResults = await Promise.all(
                    batch.map(async (place) => {
                        try {
                            const address = place.displayAddress || place.roadAddress || place.address || '';
                            let searchQuery = place.name;
                            if (address) {
                                const addressParts = address.split(' ');
                                const simplifiedAddress = addressParts.slice(1).join(' ') || address;
                                searchQuery = `${place.name} ${simplifiedAddress}`;
                            }
                            
                            // 1Ï∞® Í≤ÄÏÉâ: Îß§Ïû•Î™Ö + Ï£ºÏÜå
                            const searchResult = await callNaverAPI('local', {
                                query: searchQuery,
                                display: 5,
                                sort: 'random'
                            });
                            
                            // 1Ï∞® Î∞è 2Ï∞® Í≤ÄÏÉâ Í≥µÌÜµ Ï≤òÎ¶¨ Ìï®Ïàò
                            const processSearchResults = (items) => {
                                if (!items?.length) return null;
                                for (const item of items) {
                                    const checkResult = checkKoreanRestaurantWithSoupMenu(item, place.name);
                                    if (checkResult.isValid) {
                                        if (!place.floor) {
                                            place.floor = extractFloorInfo(checkResult.title) || extractFloorInfo(checkResult.address + ' ' + checkResult.roadAddress) || '';
                                        }
                                        console.log(`ÌïúÏãù Îß§Ïû• Ï§ë Íµ≠Î∞• Î©îÎâ¥ ÌôïÏù∏ ÏôÑÎ£å - Î¶¨Ïä§ÌåÖ Î≥¥ÏôÑ [${place.name}]`);
                                        return place;
                                    }
                                }
                                return null;
                            };
                            
                            // 1Ï∞® Í≤ÄÏÉâ: Îß§Ïû•Î™Ö + Ï£ºÏÜå
                            const result1 = processSearchResults(searchResult.items);
                            if (result1) return result1;
                            
                            // 2Ï∞® Í≤ÄÏÉâ: Îß§Ïû•Î™ÖÎßå
                            const searchResultNameOnly = await callNaverAPI('local', {
                                query: place.name,
                                display: 5,
                                sort: 'random'
                            });
                            
                            const result2 = processSearchResults(searchResultNameOnly.items);
                            if (result2) return result2;
                            
                            return null;
                        } catch (error) {
                            console.warn('ÌïúÏãù Îß§Ïû• Î≥¥ÏôÑ Í≤ÄÏÉâ Ïã§Ìå®:', place.name, error);
                            return null;
                        }
                    })
                );
                
                for (const result of batchResults) {
                    if (result) {
                        supplementedPlaces.push(result);
                    }
                }
                
                if (i + batchSize < placesExcluded.length) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }
            
            return supplementedPlaces;
        }

        // ÎÑ§Ïù¥Î≤ÑÎßµÏúºÎ°ú Ïù¥Îèô
        function openNaverMap(cafe) {
            // Îß§Ïû•Î™ÖÍ≥º ÎèÑÎ°úÎ™Ö Ï£ºÏÜåÎ•º Ìï®Íªò ÏÇ¨Ïö©ÌïòÏó¨ Ï†ïÌôïÌïú ÏúÑÏπò Í≤ÄÏÉâ
            const placeName = cafe.name || '';
            
            // ÎèÑÎ°úÎ™Ö Ï£ºÏÜå Ïö∞ÏÑ† ÏÇ¨Ïö©
            let targetAddress = cafe.roadAddress || '';
            
            // ÎèÑÎ°úÎ™Ö Ï£ºÏÜåÍ∞Ä ÏóÜÏúºÎ©¥ displayAddress ÏÇ¨Ïö©
            if (!targetAddress) {
                targetAddress = cafe.displayAddress || '';
            }
            
            // ÎèÑÎ°úÎ™Ö Ï£ºÏÜåÏôÄ displayAddressÍ∞Ä Î™®Îëê ÏóÜÏúºÎ©¥ ÏßÄÎ≤à Ï£ºÏÜå ÏÇ¨Ïö©
            if (!targetAddress) {
                targetAddress = cafe.address || '';
            }
            
            let searchQuery;
            if (targetAddress && placeName) {
                // Ï£ºÏÜåÍ∞Ä ÏûàÏúºÎ©¥ Îß§Ïû•Î™Ö + ÎèÑÎ°úÎ™Ö Ï£ºÏÜåÎ°ú Í≤ÄÏÉâ
                // Ï£ºÏÜåÏùò Í±¥Î¨ºÎ≤àÌò∏ Ï†úÍ±∞ (ÎèÑÎ°úÎ™ÖÍπåÏßÄÎßå ÏÇ¨Ïö©)
                // Ïòà: "ÏÑúÏö∏ÌäπÎ≥ÑÏãú Í∞ïÎÇ®Íµ¨ ÌÖåÌó§ÎûÄÎ°ú 152" -> "ÏÑúÏö∏ÌäπÎ≥ÑÏãú Í∞ïÎÇ®Íµ¨ ÌÖåÌó§ÎûÄÎ°ú"
                let simplifiedAddress = targetAddress.replace(/\s+\d+(\s*Î≤àÏßÄ)?\s*$/, '').trim();
                
                // Îß§Ïû•Î™Ö + ÎèÑÎ°úÎ™Ö Ï£ºÏÜåÎ°ú Í≤ÄÏÉâ
                searchQuery = `${placeName} ${simplifiedAddress}`;
            } else if (placeName) {
                // Ï£ºÏÜåÍ∞Ä ÏóÜÏúºÎ©¥ Îß§Ïû•Î™ÖÎßåÏúºÎ°ú Í≤ÄÏÉâ
                searchQuery = placeName;
            } else {
                // Îß§Ïû•Î™ÖÎèÑ ÏóÜÏúºÎ©¥ Ï£ºÏÜåÎßå ÏÇ¨Ïö©
                searchQuery = targetAddress;
            }
            
            // Í≤ÄÏÉâÏñ¥ Ï†ïÎ¶¨: Í≥µÎ∞± Ï†ïÎ¶¨
            searchQuery = searchQuery.trim().replace(/\s+/g, ' ');
            
            // ÎÑ§Ïù¥Î≤ÑÎßµ Í≤ÄÏÉâ URL Íµ¨ÏÑ±
            // ÌòïÏãù: https://map.naver.com/v5/search/Í≤ÄÏÉâÏñ¥
            const encodedQuery = encodeURIComponent(searchQuery);
            const url = `https://map.naver.com/v5/search/${encodedQuery}`;
            
            // ÏÉà Ï∞ΩÏóêÏÑú Ïó¥Í∏∞
            window.open(url, '_blank');
        }

        // Í≤∞Í≥º ÏóÜÏùå ÌëúÏãú
        function showNoResults() {
            const resultsSection = document.getElementById('resultsSection');
            const cafeList = document.getElementById('cafeList');
            const categorySelect = document.getElementById('categorySelect');
            const selectedMenu = categorySelect?.value || 'Ïπ¥Ìéò';
            const menuNames = {
                'Ïπ¥Ìéò': 'Ïπ¥Ìéò',
                'ÎßàÎùºÌÉï': 'ÎßàÎùºÌÉï Îß§Ïû•',
                'Îπµ': 'ÎπµÏßë',
                'Íµ≠Î∞•': 'Íµ≠Î∞• Îß§Ïû•',
                'ÍπÄÎ∞•': 'ÍπÄÎ∞• Ïßë'
            };
            const menuName = menuNames[selectedMenu] || 'Îß§Ïû•';
            
            resultsSection.style.display = 'block';
            cafeList.innerHTML = `
                <li class="no-results">
                    <div class="no-results-title">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</div>
                    <div class="no-results-text">750m Ïù¥ÎÇ¥Ïóê ${menuName}ÏùÑ(Î•º) Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.</div>
                </li>
            `;
        }

        // Ï£ºÏÜå ÌõÑÎ≥¥ Í≤ÄÏÉâ Î∞è Î¶¨Ïä§ÌåÖ
        async function searchAddressCandidates(query) {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const resultsSection = document.getElementById('resultsSection');
            const cafeList = document.getElementById('cafeList');
            const resultsHeader = document.getElementById('resultsHeader');

            // UI Ï¥àÍ∏∞Ìôî
            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            resultsSection.style.display = 'none';
            cafeList.innerHTML = '';

            try {
                // Ïπ¥Ïπ¥Ïò§ APIÎ°ú Ï£ºÏÜå Í≤ÄÏÉâ (Ï†ïÌôïÌïú Ï£ºÏÜå Í≤ÄÏÉâ) + ÌÇ§ÏõåÎìú Í≤ÄÏÉâ (Ïû•ÏÜåÎ™Ö)
                const [addressData, keywordData] = await Promise.all([
                    callKakaoAPI('address', {
                        query: query,
                        size: 10
                    }).catch(() => ({ documents: [] })),
                    callKakaoAPI('keyword', {
                        query: query,
                        size: 10
                    }).catch(() => ({ documents: [] }))
                ]);

                const suggestions = [];
                const seenAddresses = new Set();

                // Ïπ¥Ïπ¥Ïò§ Ï£ºÏÜå Í≤ÄÏÉâ Í≤∞Í≥º Ï≤òÎ¶¨ (ÏÑ±Îä• ÏµúÏ†ÅÌôî: for...of ÏÇ¨Ïö©)
                if (addressData.documents && addressData.documents.length > 0) {
                    for (const doc of addressData.documents) {
                        const roadAddr = doc.road_address?.address_name || '';
                        const addr = doc.address_name || '';
                        
                        if (roadAddr || addr) {
                            const key = roadAddr || addr;
                            if (!seenAddresses.has(key) && suggestions.length < 15) {
                                seenAddresses.add(key);
                                suggestions.push({
                                    main: roadAddr || addr, // ÎèÑÎ°úÎ™Ö Ï£ºÏÜå Ïö∞ÏÑ†
                                    sub: roadAddr ? addr : '', // ÎèÑÎ°úÎ™ÖÏù¥ ÏûàÏúºÎ©¥ ÏßÄÎ≤àÏùÑ ÏÑúÎ∏åÎ°ú
                                    fullAddress: roadAddr || addr,
                                    roadAddress: roadAddr || '',
                                    x: doc.x,
                                    y: doc.y
                                });
                            }
                        }
                    }
                }

                // Ïπ¥Ïπ¥Ïò§ ÌÇ§ÏõåÎìú Í≤ÄÏÉâ Í≤∞Í≥º Ï≤òÎ¶¨ (Ïó≠, Í±¥Î¨ºÎ™Ö Îì±) (ÏÑ±Îä• ÏµúÏ†ÅÌôî: for...of ÏÇ¨Ïö©)
                if (keywordData.documents && keywordData.documents.length > 0) {
                    for (const doc of keywordData.documents) {
                        const roadAddr = doc.road_address?.address_name || '';
                        const addr = doc.address_name || '';
                        const placeName = doc.place_name || '';
                        
                        if (placeName || roadAddr || addr) {
                            const displayName = placeName || roadAddr || addr;
                            const key = placeName + '|' + (roadAddr || addr);
                            
                            if (!seenAddresses.has(key) && suggestions.length < 15) {
                                seenAddresses.add(key);
                                suggestions.push({
                                    main: displayName,
                                    sub: roadAddr || addr, // ÎèÑÎ°úÎ™Ö Ï£ºÏÜå Ïö∞ÏÑ†
                                    fullAddress: roadAddr || addr,
                                    roadAddress: roadAddr || '',
                                    x: doc.x,
                                    y: doc.y
                                });
                            }
                        }
                    }
                }

                loadingEl.style.display = 'none';

                if (suggestions.length === 0) {
                    errorEl.style.display = 'block';
                    errorEl.textContent = 'Ï£ºÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Îã§Î•∏ Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.';
                    return;
                }

                // Ï£ºÏÜå ÌõÑÎ≥¥ Î¶¨Ïä§ÌåÖ ÌëúÏãú
                displayAddressCandidates(suggestions);
            } catch (error) {
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                errorEl.textContent = 'Ï£ºÏÜå Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                console.error('Ï£ºÏÜå Í≤ÄÏÉâ Ïò§Î•ò:', error);
            }
        }

        // Ï£ºÏÜå ÌõÑÎ≥¥ Î™©Î°ù ÌëúÏãú
        function displayAddressCandidates(suggestions) {
            const resultsSection = document.getElementById('resultsSection');
            const cafeList = document.getElementById('cafeList');
            const resultsHeader = document.getElementById('resultsHeader');

            resultsHeader.textContent = `${suggestions.length}Í∞úÏùò Ï£ºÏÜåÎ•º Ï∞æÏïòÏäµÎãàÎã§. ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.`;
            resultsSection.style.display = 'block';
            cafeList.innerHTML = '';

            // ÏÑ±Îä• ÏµúÏ†ÅÌôî: DocumentFragment ÏÇ¨Ïö©
            const fragment = document.createDocumentFragment();
            
            for (const suggestion of suggestions) {
                const li = document.createElement('li');
                li.className = 'address-item';
                
                // ÎèÑÎ°úÎ™Ö Ï£ºÏÜåÎ•º Î©îÏù∏ÏúºÎ°ú ÌëúÏãú
                const displayMain = suggestion.roadAddress || suggestion.main;
                const displaySub = suggestion.roadAddress ? suggestion.sub : '';
                
                // ÌÖçÏä§Ìä∏Î•º spanÏúºÎ°ú Í∞êÏã∏ÏÑú ÌÖçÏä§Ìä∏ ÏÑ†ÌÉù Î∞©ÏßÄ
                const mainEl = document.createElement('div');
                mainEl.className = 'address-main';
                const mainText = document.createTextNode(displayMain);
                mainEl.appendChild(mainText);
                
                li.appendChild(mainEl);
                
                if (displaySub) {
                    const subEl = document.createElement('div');
                    subEl.className = 'address-sub';
                    const subText = document.createTextNode(displaySub);
                    subEl.appendChild(subText);
                    li.appendChild(subEl);
                }
                
                // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏Îäî li ÏöîÏÜåÏóêÎßå Î∞îÏù∏Îî©
                li.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    // ÏûÖÎ†•Ï∞ΩÏóê ÏÑ†ÌÉùÌïú Ï£ºÏÜå ÏóÖÎç∞Ïù¥Ìä∏
                    const addressInput = document.getElementById('addressInput');
                    if (addressInput) {
                        addressInput.value = displayMain;
                    }
                    // ÏÑ†ÌÉùÌïú Ï£ºÏÜåÎ°ú Ïπ¥Ìéò Í≤ÄÏÉâ
                    searchCafesByCoordinates(suggestion.x, suggestion.y, displayMain);
                };
                
                // ÎßàÏö∞Ïä§ Ïù¥Î≤§Ìä∏Î°úÎèÑ Ìè¨Ïù∏ÌÑ∞ Ïª§ÏÑú Í∞ïÏ†ú
                li.onmouseenter = () => {
                    li.style.cursor = 'pointer';
                };
                
                fragment.appendChild(li);
            }
            
            // Ìïú Î≤àÏóê DOMÏóê Ï∂îÍ∞Ä (Î¶¨ÌîåÎ°úÏö∞ ÏµúÏÜåÌôî)
            cafeList.appendChild(fragment);
        }

        // Ï¢åÌëúÎ°ú Ïπ¥Ìéò Í≤ÄÏÉâ
        async function searchCafesByCoordinates(x, y, addressName) {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const resultsSection = document.getElementById('resultsSection');
            const cafeList = document.getElementById('cafeList');
            const resultsHeader = document.getElementById('resultsHeader');

            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            resultsSection.style.display = 'none';
            resultsHeader.textContent = '';
            cafeList.innerHTML = '';
            updateProgress(0, 'Í≤ÄÏÉâ Ï§ÄÎπÑ Ï§ë...');

            try {
                const baseX = parseFloat(x);
                const baseY = parseFloat(y);
                const radius = 750;
                
                // Í≤ÄÏÉâ Í∏∞Ï§Ä Ï£ºÏÜå (ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâÏóê ÏÇ¨Ïö©)
                const searchBaseAddress = addressName || '';
                
                updateProgress(30, getSearchMessage());
                const cafesSearchable = await searchAndProcessPlaces(baseX, baseY, searchBaseAddress, radius);
                
                updateProgress(100, 'Í≤ÄÏÉâ ÏôÑÎ£å!');

                if (cafesSearchable.length === 0) {
                    loadingEl.style.display = 'none';
                    showNoResults();
                    return;
                }

                // Î®ºÏ†Ä Î°úÎî© Ïï†ÎãàÎ©îÏù¥ÏÖò Ïà®Í∏∞Í∏∞ (Í≤∞Í≥º ÌëúÏãú Ï†ÑÏóê)
                loadingEl.style.display = 'none';

                // Ïπ¥Ìéò Î™©Î°ù ÌëúÏãú (Í≥µÌÜµ Ìï®Ïàò ÏÇ¨Ïö©)
                renderCafeList(cafesSearchable, resultsHeader, resultsSection, cafeList);

            } catch (error) {
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                
                let errorMessage = 'Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                if (error.message) {
                    errorMessage = error.message.replace(/\n/g, '<br>');
                }
                
                errorEl.innerHTML = errorMessage;
                console.error('Í≤ÄÏÉâ Ïò§Î•ò:', error);
            }
        }

        // ÏûÖÎ†• ÌïÑÎìú Ïù¥Î≤§Ìä∏
        const addressInput = document.getElementById('addressInput');

        // ÌòÑÏúÑÏπò Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
        document.getElementById('locationButton').addEventListener('click', async () => {
            const locationButton = document.getElementById('locationButton');
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const resultsSection = document.getElementById('resultsSection');
            const cafeList = document.getElementById('cafeList');
            const resultsHeader = document.getElementById('resultsHeader');
            const addressInput = document.getElementById('addressInput');
            
            // Ï£ºÏÜå ÏûÖÎ†•Ï∞Ω Î®ºÏ†Ä reset
            if (addressInput) {
                addressInput.value = '';
            }
            
            // Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            locationButton.disabled = true;
            locationButton.textContent = '‚è≥';
            
            // UI Ï¥àÍ∏∞Ìôî - Í∏∞Ï°¥ Ïπ¥Ìéò Î™©Î°ù Ï†úÍ±∞
            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            resultsSection.style.display = 'none';
            cafeList.innerHTML = '';
            resultsHeader.textContent = '';
            updateProgress(0, 'ÌòÑÏúÑÏπò ÌôïÏù∏ Ï§ë...');
            
            try {
                // Geolocation APIÎ°ú ÌòÑÏû¨ ÏúÑÏπò Í∞ÄÏ†∏Ïò§Í∏∞
                if (!navigator.geolocation) {
                    throw new Error('ÌòÑÏû¨ Î∏åÎùºÏö∞Ï†ÄÏóêÏÑú ÏúÑÏπò ÏÑúÎπÑÏä§Î•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
                }
                
                const position = await new Promise((resolve, reject) => {
                    // Î®ºÏ†Ä ÏùºÎ∞ò Ï†ïÌôïÎèÑÎ°ú ÏãúÎèÑ (Îçî Îπ†Î•¥Í≥† ÏïàÏ†ïÏ†Å)
                    navigator.geolocation.getCurrentPosition(
                        resolve, 
                        (error) => {
                            console.warn('ÏùºÎ∞ò Ï†ïÌôïÎèÑ ÏúÑÏπò Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®, Í≥†Ï†ïÌôïÎèÑÎ°ú Ïû¨ÏãúÎèÑ:', error);
                            // Ïã§Ìå® Ïãú Í≥†Ï†ïÌôïÎèÑÎ°ú Ïû¨ÏãúÎèÑ
                            navigator.geolocation.getCurrentPosition(
                                resolve,
                                reject,
                                {
                                    enableHighAccuracy: true,
                                    timeout: 15000,
                                    maximumAge: 60000 // 1Î∂Ñ Ïù¥ÎÇ¥ Ï∫êÏãúÎêú ÏúÑÏπò ÌóàÏö©
                                }
                            );
                        },
                        {
                            enableHighAccuracy: false, // ÏùºÎ∞ò Ï†ïÌôïÎèÑÎ°ú Î®ºÏ†Ä ÏãúÎèÑ
                            timeout: 10000,
                            maximumAge: 60000 // 1Î∂Ñ Ïù¥ÎÇ¥ Ï∫êÏãúÎêú ÏúÑÏπò ÌóàÏö© (Îçî Îπ†Î•∏ ÏùëÎãµ)
                        }
                    );
                });
                
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;
                
                // Ï¢åÌëúÎ•º Ï£ºÏÜåÎ°ú Î≥ÄÌôò
                let address = '';
                try {
                    const coordData = await callKakaoAPI('coord2address', {
                        x: longitude,
                        y: latitude
                    });
                    
                    console.log('Ï£ºÏÜå Î≥ÄÌôò API ÏùëÎãµ:', coordData);
                    
                    if (coordData.documents && coordData.documents.length > 0) {
                        const doc = coordData.documents[0];
                        // ÎèÑÎ°úÎ™Ö Ï£ºÏÜå Ïö∞ÏÑ†, ÏóÜÏúºÎ©¥ ÏßÄÎ≤à Ï£ºÏÜå
                        const roadAddr = doc.road_address?.address_name || '';
                        const addr = doc.address?.address_name || doc.address_name || '';
                        address = roadAddr || addr;
                        
                        console.log('Ï∂îÏ∂úÎêú Ï£ºÏÜå:', { roadAddr, addr, final: address });
                    }
                    
                    // Ï£ºÏÜåÍ∞Ä ÏóÜÍ±∞ÎÇò Îπà Î¨∏ÏûêÏó¥Ïù¥Î©¥ Ï¢åÌëú Î¨∏ÏûêÏó¥ ÏÇ¨Ïö©
                    if (!address || address.trim() === '') {
                        console.warn('Ï£ºÏÜå Î≥ÄÌôò Í≤∞Í≥ºÍ∞Ä ÎπÑÏñ¥ÏûàÏùå, Ï¢åÌëú Î¨∏ÏûêÏó¥ ÏÇ¨Ïö©');
                        address = `ÏúÑÎèÑ ${latitude.toFixed(6)}, Í≤ΩÎèÑ ${longitude.toFixed(6)}`;
                    }
                } catch (error) {
                    console.error('Ï£ºÏÜå Î≥ÄÌôò Ïã§Ìå®:', error);
                    // Ï£ºÏÜå Î≥ÄÌôò Ïã§Ìå® Ïãú Ï¢åÌëú Î¨∏ÏûêÏó¥ ÏÇ¨Ïö©
                    address = `ÏúÑÎèÑ ${latitude.toFixed(6)}, Í≤ΩÎèÑ ${longitude.toFixed(6)}`;
                }
                
                // Ï£ºÏÜåÍ∞Ä ÏúÑÎèÑ/Í≤ΩÎèÑ ÌòïÏãùÏù¥Î©¥ Í≤ÄÏÉâÌïòÏßÄ ÏïäÍ≥† ÏóêÎü¨ ÌëúÏãú
                if (address.startsWith('ÏúÑÎèÑ')) {
                    loadingEl.style.display = 'none';
                    errorEl.style.display = 'block';
                    errorEl.textContent = 'Ï£ºÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Îã§Î•∏ Î∞©Î≤ïÏúºÎ°ú Í≤ÄÏÉâÌï¥Ï£ºÏÑ∏Ïöî.';
                    addressInput.value = '';
                    return;
                }
                
                // Ìï≠ÏÉÅ ÏûÖÎ†•Ï∞ΩÏóê Ï£ºÏÜå ÌëúÏãú
                addressInput.value = address;
                
                // Ìï¥Îãπ Ï£ºÏÜåÎ°ú Îß§Ïû• Í≤ÄÏÉâ (Ï£ºÏÜå Ï†ïÎ≥¥ Ï†ÑÎã¨)
                await searchCafesByCoordinates(longitude, latitude, address);
                
            } catch (error) {
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                
                let errorMessage = 'ÌòÑÏû¨ ÏúÑÏπòÎ•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.';
                if (error.code === 1) {
                    errorMessage = 'ÏúÑÏπò Í∂åÌïúÏù¥ Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§. Î∏åÎùºÏö∞Ï†Ä ÏÑ§Ï†ïÏóêÏÑú ÏúÑÏπò Í∂åÌïúÏùÑ ÌóàÏö©Ìï¥Ï£ºÏÑ∏Ïöî.';
                } else if (error.code === 2) {
                    errorMessage = 'ÏúÑÏπòÎ•º ÌôïÏù∏Ìï† Ïàò ÏóÜÏäµÎãàÎã§. Ïù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞Í≥º ÏúÑÏπò ÏÑúÎπÑÏä§Î•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî. (Ïã§ÎÇ¥ÏóêÏÑúÎäî Ï†ïÌôïÎèÑÍ∞Ä ÎÇÆÏùÑ Ïàò ÏûàÏäµÎãàÎã§)';
                } else if (error.code === 3) {
                    errorMessage = 'ÏúÑÏπò ÌôïÏù∏ ÏãúÍ∞ÑÏù¥ Ï¥àÍ≥ºÎêòÏóàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                errorEl.textContent = errorMessage;
                console.error('ÏúÑÏπò Í∞ÄÏ†∏Ïò§Í∏∞ Ïò§Î•ò:', error);
                console.error('ÏóêÎü¨ ÏÉÅÏÑ∏:', {
                    code: error.code,
                    message: error.message,
                    timestamp: new Date().toISOString()
                });
            } finally {
                // Î≤ÑÌäº ÌôúÏÑ±Ìôî
                locationButton.disabled = false;
                locationButton.textContent = 'üìç';
            }
        });

        // Í≤ÄÏÉâ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
        document.getElementById('searchButton').addEventListener('click', () => {
            const address = addressInput.value.trim();
            if (address) {
                // Ï£ºÏÜå ÌõÑÎ≥¥ Í≤ÄÏÉâ Î∞è Î¶¨Ïä§ÌåÖ
                searchAddressCandidates(address);
            }
        });

        // Enter ÌÇ§ Ïù¥Î≤§Ìä∏
        addressInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const address = addressInput.value.trim();
                if (address) {
                    // Ï£ºÏÜå ÌõÑÎ≥¥ Í≤ÄÏÉâ Î∞è Î¶¨Ïä§ÌåÖ
                    searchAddressCandidates(address);
                }
            }
        });

        // Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏ (ÌéòÏù¥ÏßÄ Ïù¥Îèô Ï†úÍ±∞, ÏÑ§Ï†ïÎßå Î≥ÄÍ≤Ω)
        const categorySelect = document.getElementById('categorySelect');
        categorySelect.addEventListener('change', (e) => {
            // Ï£ºÏÜå ÏûÖÎ†•Ï∞Ω Î®ºÏ†Ä reset
            if (addressInput) {
                addressInput.value = '';
            }
            
            // Î©îÎâ¥ Î≥ÄÍ≤Ω Ïãú Í≤ÄÏÉâ Í≤∞Í≥º Ï¥àÍ∏∞Ìôî
            const resultsSection = document.getElementById('resultsSection');
            const cafeList = document.getElementById('cafeList');
            const resultsHeader = document.getElementById('resultsHeader');
            const errorEl = document.getElementById('error');
            
            if (resultsSection) resultsSection.style.display = 'none';
            if (cafeList) cafeList.innerHTML = '';
            if (resultsHeader) resultsHeader.textContent = '';
            if (errorEl) errorEl.style.display = 'none';
            
            // ÏÑ§Ï†ïÏù¥ ÏûêÎèôÏúºÎ°ú Î≥ÄÍ≤ΩÎê® (getCurrentMenuConfig Ìï®Ïàò ÏÇ¨Ïö©)
            console.log('Î©îÎâ¥ Î≥ÄÍ≤Ω:', e.target.value);
        });
    </script>
</body>
</html>
