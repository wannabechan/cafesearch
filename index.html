<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ïπ¥Ìéò explorer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #ffffff;
            color: #202124;
            line-height: 1.6;
            min-height: 100vh;
        }

        .address-item::selection,
        .address-item *::selection {
            background: transparent;
        }

        .address-item::-moz-selection,
        .address-item *::-moz-selection {
            background: transparent;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        h1 {
            text-align: center;
            font-size: 48px;
            font-weight: 300;
            color: #202124;
            margin-bottom: 50px;
            letter-spacing: -0.5px;
        }

        .search-section {
            margin-bottom: 40px;
        }

        .search-box {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 600px;
            margin: 0 auto;
        }

        .search-input {
            width: 100%;
            padding: 16px 20px;
            font-size: 16px;
            border: 1px solid #dfe1e5;
            border-radius: 24px;
            outline: none;
            transition: all 0.2s;
        }

        .search-buttons {
            display: flex;
            gap: 12px;
            width: 100%;
            align-items: center;
        }

        .search-input:focus {
            border-color: #4285f4;
            box-shadow: 0 2px 5px 1px rgba(64, 60, 67, 0.16);
        }

        .search-button {
            flex: 1;
            padding: 12px 24px;
            font-size: 15px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
        }

        .search-button:hover {
            background-color: #357ae8;
        }

        .search-button:active {
            background-color: #2a5fcc;
        }

        .location-button {
            flex: 0 0 auto;
            padding: 12px 16px;
            font-size: 18px;
            background-color: #34a853;
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .category-select {
            flex: 0 0 auto;
            padding: 12px 16px;
            font-size: 15px;
            background-color: #ffffff;
            color: #202124;
            border: 1px solid #dfe1e5;
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            outline: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%235f6368' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        .category-select:hover {
            border-color: #4285f4;
            box-shadow: 0 2px 5px 1px rgba(64, 60, 67, 0.16);
        }

        .category-select:focus {
            border-color: #4285f4;
            box-shadow: 0 2px 5px 1px rgba(64, 60, 67, 0.16);
        }

        .location-button:hover {
            background-color: #2d8f47;
        }

        .location-button:active {
            background-color: #267d3e;
        }

        .location-button:disabled {
            background-color: #c0c0c0;
            cursor: not-allowed;
        }

        .results-section {
            margin-top: 40px;
        }

        .results-header {
            font-size: 14px;
            color: #5f6368;
            margin-bottom: 20px;
            text-align: center;
        }

        .cafe-list {
            list-style: none;
        }

        .cafe-item {
            padding: 20px;
            border-bottom: 1px solid #f1f3f4;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .cafe-item:hover {
            background-color: #f8f9fa;
        }

        .cafe-item:last-child {
            border-bottom: none;
        }

        .cafe-name {
            font-size: 18px;
            font-weight: 500;
            color: #1a73e8;
            margin-bottom: 8px;
        }

        .cafe-name:hover {
            text-decoration: underline;
        }

        .cafe-address {
            font-size: 14px;
            color: #5f6368;
            margin-bottom: 6px;
        }

        .cafe-distance {
            font-size: 13px;
            color: #80868b;
        }


        .cafe-keywords {
            display: flex;
            gap: 6px;
            margin-left: 12px;
            flex-wrap: wrap;
        }

        .cafe-keyword {
            font-size: 11px;
            color: #5f6368;
            background-color: #f1f3f4;
            padding: 3px 8px;
            border-radius: 12px;
            white-space: nowrap;
        }



        .loading {
            text-align: center;
            padding: 40px;
            color: #5f6368;
            font-size: 14px;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f1f3f4;
            border-top-color: #4285f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #ea4335;
            font-size: 14px;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #5f6368;
        }

        .no-results-title {
            font-size: 18px;
            margin-bottom: 8px;
            color: #202124;
        }

        .no-results-text {
            font-size: 14px;
        }

        .address-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dfe1e5;
            border-radius: 12px;
            margin-top: 8px;
        }

        .address-item {
            padding: 20px;
            border-bottom: 1px solid #f1f3f4;
            transition: background-color 0.2s;
            cursor: pointer !important;
            user-select: none !important;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            -webkit-touch-callout: none !important;
            -webkit-tap-highlight-color: transparent;
            background-color: #ffffff;
            display: block;
            width: 100%;
            text-align: left;
            border: none;
            outline: none;
        }

        .address-item:hover {
            background-color: #f8f9fa;
            cursor: pointer !important;
        }

        .address-item:active {
            background-color: #f1f3f4;
        }

        .address-item:last-child {
            border-bottom: none;
        }

        .address-item * {
            cursor: pointer !important;
            user-select: none !important;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            pointer-events: none !important;
            -webkit-touch-callout: none !important;
        }

        .address-main {
            font-size: 16px;
            color: #202124;
            margin-bottom: 4px;
            font-weight: 500;
            display: block;
        }

        .address-sub {
            font-size: 14px;
            color: #5f6368;
            display: block;
        }

        /* Î™®Î∞îÏùº ÏµúÏ†ÅÌôî */
        @media screen and (max-width: 768px) {
            .container {
                padding: 20px 16px;
            }

            h1 {
                font-size: 32px;
                margin-bottom: 30px;
            }

            .search-box {
                gap: 10px;
                max-width: 100%;
            }

            .search-buttons {
                flex-direction: row;
                gap: 8px;
            }

            .category-select {
                padding: 12px 14px;
                font-size: 14px;
                padding-right: 32px;
            }

            .search-input {
                padding: 14px 18px;
                font-size: 16px; /* iOS Ï§å Î∞©ÏßÄ */
                border-radius: 20px;
            }

            .search-button {
                flex: 1;
                padding: 12px 16px;
                font-size: 14px;
                border-radius: 20px;
                min-width: 0;
            }

            .location-button {
                padding: 12px 14px;
                font-size: 18px;
                border-radius: 20px;
                flex: 0 0 auto;
            }
            
            .category-select {
                flex: 0 0 auto;
                min-width: 70px;
            }

            .cafe-item {
                padding: 16px;
            }

            .cafe-name {
                font-size: 16px;
                margin-bottom: 6px;
            }

            .cafe-address {
                font-size: 13px;
                margin-bottom: 4px;
                line-height: 1.5;
            }

            .cafe-distance {
                font-size: 12px;
            }


            .cafe-keywords {
                margin-left: 0;
                margin-top: 8px;
                gap: 4px;
            }

            .cafe-keyword {
                font-size: 10px;
                padding: 2px 6px;
            }



            .results-header {
                font-size: 13px;
                margin-bottom: 16px;
            }

            .address-item {
                padding: 14px 16px;
            }

            .address-main {
                font-size: 15px;
            }

            .address-sub {
                font-size: 13px;
            }

            .loading {
                padding: 30px 20px;
                font-size: 13px;
            }

            .loading-container {
                padding: 40px 16px;
            }

            .error {
                padding: 30px 20px;
                font-size: 13px;
            }

            .no-results {
                padding: 40px 16px;
            }

            .no-results-title {
                font-size: 16px;
            }
        }

        /* ÏûëÏùÄ Î™®Î∞îÏùº ÌôîÎ©¥ (iPhone SE Îì±) */
        @media screen and (max-width: 375px) {
            .container {
                padding: 16px 12px;
            }

            h1 {
                font-size: 28px;
                margin-bottom: 24px;
            }

            .search-input {
                padding: 12px 16px;
            }

            .search-button {
                padding: 12px 14px;
                font-size: 13px;
            }

            .location-button {
                padding: 12px 12px;
                font-size: 16px;
            }

            .category-select {
                padding: 12px 12px;
                font-size: 13px;
                padding-right: 28px;
                min-width: 65px;
            }

            .cafe-item {
                padding: 14px;
            }

            .cafe-name {
                font-size: 15px;
            }

            .cafe-address {
                font-size: 12px;
            }
        }

        /* Í∞ÄÎ°ú Î™®Îìú ÏµúÏ†ÅÌôî */
        @media screen and (max-width: 768px) and (orientation: landscape) {
            .container {
                padding: 16px 20px;
            }

            h1 {
                font-size: 28px;
                margin-bottom: 20px;
            }

            .search-buttons {
                flex-direction: row;
                gap: 8px;
            }

            .search-button {
                flex: 1;
            }

            .location-button {
                flex: 0 0 auto;
                min-width: 80px;
            }

            .category-select {
                flex: 0 0 auto;
                min-width: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ïπ¥Ìéò explorer</h1>
        
        <div class="search-section">
            <div class="search-box">
                <input 
                    type="text" 
                    id="addressInput" 
                    class="search-input" 
                    placeholder="Ï£ºÏÜå ÏûÖÎ†•"
                    autocomplete="off"
                >
                <div class="search-buttons">
                    <button id="searchButton" class="search-button">Í≤ÄÏÉâ</button>
                    <button id="locationButton" class="location-button" title="ÌòÑÏúÑÏπò">üìç</button>
                    <select id="categorySelect" class="category-select" title="Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù">
                        <option value="Ïπ¥Ìéò" selected>Ïπ¥Ìéò</option>
                        <option value="ÎßàÎùºÌÉï">ÎßàÎùºÌÉï</option>
                        <option value="Îπµ">Îπµ</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="results-section" id="resultsSection" style="display: none;">
            <div class="results-header" id="resultsHeader"></div>
            <ul class="cafe-list" id="cafeList"></ul>
        </div>

        <div class="loading" id="loading" style="display: none;">
            <div class="loading-container">
                <div class="spinner"></div>
                <div>Í≤ÄÏÉâ Ï§ë...</div>
            </div>
        </div>
        <div class="error" id="error" style="display: none;"></div>
    </div>

    <script>
        // Ï†úÏô∏Ìï† ÌîÑÎûúÏ∞®Ïù¥Ï¶à Ïπ¥Ìéò Î™©Î°ù
        const EXCLUDED_CAFES = ['Ïä§ÌÉÄÎ≤ÖÏä§', 'Ïù¥ÎîîÏïº', 'Ïª¥Ìè¨Ï¶à', 'Î©îÍ∞Ä', 'MGC', 'Ïπ¥ÌéòÎ≤†ÎÑ§', 'Ìà¨Ïç∏', 'Îß§Î®∏Îìú', 'Ïª§ÌîºÏï≥ÏõçÏä§', 'Î∞±ÏñµÏª§Ìîº', 'Ìï†Î¶¨Ïä§', 'Ïª§ÌîºÎπà', 'ÎπΩÎã§Î∞©', 'Î∞©ÌÉàÏ∂ú', 'ÏöîÍ±∞Ìä∏', 'Í≥µÏ∞®', 'ÌÉêÏï§ÌÉêÏä§'];

        // API ÏóîÎìúÌè¨Ïù∏Ìä∏ (ÏÑúÎ≤ÑÎ¶¨Ïä§ Ìï®Ïàò ÏÇ¨Ïö©)
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:3000/api'
            : '/api';

        // ÎÑ§Ïù¥Î≤Ñ Ï¢åÌëúÍ≥ÑÎ•º WGS84Î°ú Î≥ÄÌôò
        function naverToWGS84(mapx, mapy) {
            // ÎÑ§Ïù¥Î≤Ñ Ï¢åÌëúÍ≥Ñ (EPSG:5179) -> WGS84 (EPSG:4326)
            // ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ APIÎäî Ïù¥ÎØ∏ WGS84 Ï¢åÌëúÎ•º Ï†úÍ≥µÌïòÎØÄÎ°ú Î≥ÄÌôò Î∂àÌïÑÏöî
            // ÌïòÏßÄÎßå mapx, mapyÍ∞Ä ÎÑ§Ïù¥Î≤Ñ Ï¢åÌëúÍ≥ÑÏùº Ïàò ÏûàÏúºÎØÄÎ°ú Î≥ÄÌôò
            const x = parseFloat(mapx);
            const y = parseFloat(mapy);
            
            // ÎÑ§Ïù¥Î≤Ñ Ï¢åÌëúÎ•º WGS84Î°ú Î≥ÄÌôò (Í∞ÑÎã®Ìïú ÏÑ†Ìòï Î≥ÄÌôò)
            // ÎÑ§Ïù¥Î≤Ñ Ï¢åÌëúÍ≥ÑÎäî ÌïúÍµ≠ Ï†ÑÏö© Ï¢åÌëúÍ≥Ñ
            // ÎåÄÎûµÏ†ÅÏù∏ Î≥ÄÌôò: ÎÑ§Ïù¥Î≤Ñ Ï¢åÌëúÎ•º 10000000ÏúºÎ°ú ÎÇòÎàÑÍ≥† Í∏∞Ï§ÄÏ†ê ÎçîÌïòÍ∏∞
            const lon = (x / 10000000) + 126.9784;
            const lat = (y / 10000000) + 37.5665;
            
            return { lon, lat };
        }

        // Ïπ¥Ïπ¥Ïò§ API Ìò∏Ï∂ú (ÏÑúÎ≤ÑÎ¶¨Ïä§ Ìï®ÏàòÎ•º ÌÜµÌï¥) - Ï£ºÏÜå Í≤ÄÏÉâÏö©
        async function callKakaoAPI(endpoint, params) {
            try {
                const queryParams = new URLSearchParams({
                    endpoint: endpoint,
                    ...params
                });
                
                const response = await fetch(`${API_BASE_URL}/kakao?${queryParams}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'API Ìò∏Ï∂ú Ïã§Ìå®');
                }

                return await response.json();
            } catch (error) {
                console.error('Kakao API Ìò∏Ï∂ú Ïò§Î•ò:', error);
                throw error;
            }
        }

        // ÎÑ§Ïù¥Î≤Ñ API Ìò∏Ï∂ú (ÏÑúÎ≤ÑÎ¶¨Ïä§ Ìï®ÏàòÎ•º ÌÜµÌï¥) - Ïπ¥Ìéò Í≤ÄÏÉâÏö©
        async function callNaverAPI(endpoint, params) {
            try {
                const queryParams = new URLSearchParams({
                    endpoint: endpoint,
                    ...params
                });
                
                const response = await fetch(`${API_BASE_URL}/naver?${queryParams}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'API Ìò∏Ï∂ú Ïã§Ìå®');
                }

                return await response.json();
            } catch (error) {
                console.error('Naver API Ìò∏Ï∂ú Ïò§Î•ò:', error);
                throw error;
            }
        }


        // Îëê Ï¢åÌëú Í∞ÑÏùò Í±∞Î¶¨ Í≥ÑÏÇ∞ (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // ÏßÄÍµ¨ Î∞òÏßÄÎ¶Ñ (ÎØ∏ÌÑ∞)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // ÎØ∏ÌÑ∞ Îã®ÏúÑ Í±∞Î¶¨
        }

        // ÌîÑÎûúÏ∞®Ïù¥Ï¶à Ïπ¥ÌéòÏù∏ÏßÄ ÌôïÏù∏
        function isExcludedCafe(cafeName) {
            if (!cafeName) return false;
            const name = cafeName.toLowerCase();
            return EXCLUDED_CAFES.some(excluded => name.includes(excluded.toLowerCase()));
        }

        // Ïπ¥Ìéò Ïπ¥ÌÖåÍ≥†Î¶¨Ïù∏ÏßÄ ÌôïÏù∏ (Î∏åÎü∞Ïπò, Î†àÏä§ÌÜ†Îûë, ÏùåÏãùÏ†ê, Ïà†Ïßë Ï†úÏô∏)
        function isCafeCategory(categoryName) {
            // Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†ïÎ≥¥Í∞Ä ÏóÜÏúºÎ©¥ ÌóàÏö© (Í∏∞Î≥∏Ï†ÅÏúºÎ°ú Ïπ¥Ìéò Í≤ÄÏÉâ Í≤∞Í≥ºÏù¥ÎØÄÎ°ú)
            if (!categoryName) return true;
            
            const category = categoryName.toLowerCase();
            
            // Ï†úÏô∏Ìï† Ïπ¥ÌÖåÍ≥†Î¶¨Îßå Ï≤¥ÌÅ¨ (Î™ÖÌôïÌûà Ï†úÏô∏Ìï† Í≤ÉÎì§Îßå)
            const excludedKeywords = ['Î∏åÎü∞Ïπò', 'brunch', 'Î†àÏä§ÌÜ†Îûë', 'restaurant', 'Ïà†Ïßë', 'Î∞î', 'bar', 'ÌéúÏÖò', 'Ìò∏ÌÖî', 'hotel', 'ÏπòÌÇ®', 'chicken', 'ÌîºÏûê', 'pizza', 'ÌïúÏãù', 'Ï§ëÏãù', 'ÏùºÏãù', 'ÏñëÏãù'];
            const isExcluded = excludedKeywords.some(keyword => category.includes(keyword));
            
            // Ï†úÏô∏ ÌÇ§ÏõåÎìúÍ∞Ä ÏóÜÏúºÎ©¥ ÌóàÏö© (Ïπ¥Ìéò Í≤ÄÏÉâ Í≤∞Í≥ºÏù¥ÎØÄÎ°ú ÎåÄÎ∂ÄÎ∂Ñ Ïπ¥ÌéòÏùº Í≤É)
            return !isExcluded;
        }

        // Ï∏µ Ï†ïÎ≥¥ Ìå®ÌÑ¥Îì§ (ÎØ∏Î¶¨ Ïª¥ÌååÏùºÌïòÏó¨ ÏÑ±Îä• ÏµúÏ†ÅÌôî)
        const FLOOR_PATTERNS = [
            /(\d+)Ï∏µ/g,           // "2Ï∏µ", "3Ï∏µ"
            /(\d+)F/g,            // "2F", "3F"
            /(\d+)f/g,            // "2f", "3f"
            /B(\d+)/g,            // "B1", "B2" (ÏßÄÌïò)
            /ÏßÄÌïò\s*(\d+)/g,      // "ÏßÄÌïò 1", "ÏßÄÌïò 2"
            /\((\d+)Ï∏µ\)/g,       // "(2Ï∏µ)"
            /\((\d+)F\)/g,        // "(2F)"
            /\[(\d+)Ï∏µ\]/g,       // "[2Ï∏µ]"
            /(\d+)\.(\d+)Ï∏µ/g     // "2.5Ï∏µ" Í∞ôÏùÄ Í≤ΩÏö∞Îäî Ï†úÏô∏ÌïòÍ≥† Ï†ïÏàòÎßå
        ];
        const NUMBER_PATTERN = /\d+/;

        // Ïû•ÏÜåÎ™ÖÏóêÏÑú Ï∏µ Ï†ïÎ≥¥ Ï∂îÏ∂ú
        function extractFloorInfo(placeName) {
            if (!placeName) return '';
            
            let floorInfo = '';
            let foundFloor = null;
            
            // Í∞Å Ìå®ÌÑ¥ÏúºÎ°ú Ï∏µ Ï†ïÎ≥¥ Ï∞æÍ∏∞
            for (const pattern of FLOOR_PATTERNS) {
                const matches = placeName.match(pattern);
                if (matches && matches.length > 0) {
                    // ÎßàÏßÄÎßâ Îß§Ïπ≠Îêú Ï∏µ Ï†ïÎ≥¥ ÏÇ¨Ïö© (Í∞ÄÏû• Ï†ïÌôïÌïú Í≤É)
                    const lastMatch = matches[matches.length - 1];
                    const numberMatch = lastMatch.match(NUMBER_PATTERN);
                    if (numberMatch) {
                        foundFloor = numberMatch[0];
                        
                        // ÏßÄÌïò Ïó¨Î∂Ä ÌôïÏù∏
                        if (lastMatch.includes('B') || lastMatch.includes('ÏßÄÌïò')) {
                            floorInfo = `B${foundFloor}`;
                        } else {
                            floorInfo = `${foundFloor}Ï∏µ`;
                        }
                        break;
                    }
                }
            }
            
            return floorInfo;
        }

        // Ïπ¥Ìéò Î™©Î°ù Î†åÎçîÎßÅ Í≥µÌÜµ Ìï®Ïàò (ÏÑ±Îä• ÏµúÏ†ÅÌôî: DocumentFragment ÏÇ¨Ïö©)
        function renderCafeList(cafes, resultsHeader, resultsSection, cafeList) {
            resultsHeader.textContent = `Ï£ºÎ≥ÄÏùò ${cafes.length}Í∞ú Ïπ¥ÌéòÏûÖÎãàÎã§. (ÌîÑÎûúÏ∞®Ïù¥Ï¶à Ï†úÏô∏)`;
            resultsSection.style.display = 'block';
            
            // DocumentFragment ÏÇ¨Ïö©ÏúºÎ°ú DOM Î¶¨ÌîåÎ°úÏö∞ ÏµúÏÜåÌôî
            const fragment = document.createDocumentFragment();
            
            for (const cafe of cafes) {
                const li = document.createElement('li');
                li.className = 'cafe-item';
                
                const nameEl = document.createElement('div');
                nameEl.className = 'cafe-name';
                nameEl.onclick = () => openNaverMap(cafe);
                nameEl.textContent = cafe.name;
                
                const addressEl = document.createElement('div');
                addressEl.className = 'cafe-address';
                let addressText = cafe.displayAddress || cafe.roadAddress || cafe.address;
                if (cafe.floor) {
                    addressText += ` ${cafe.floor}`;
                }
                addressEl.textContent = addressText;
                
                const distanceEl = document.createElement('div');
                distanceEl.className = 'cafe-distance';
                distanceEl.textContent = `${Math.round(cafe.distance)}m`;
                
                // ÌÇ§ÏõåÎìú ÌëúÏãú
                const keywords = cafe.keywords || [];
                const keywordsContainer = document.createElement('div');
                keywordsContainer.className = 'cafe-keywords';
                
                // ÏÑ±Îä• ÏµúÏ†ÅÌôî: for...of ÏÇ¨Ïö©
                for (const keyword of keywords) {
                    const keywordEl = document.createElement('span');
                    keywordEl.className = 'cafe-keyword';
                    keywordEl.textContent = keyword;
                    keywordsContainer.appendChild(keywordEl);
                }
                
                const distanceContainer = document.createElement('div');
                distanceContainer.style.display = 'flex';
                distanceContainer.style.alignItems = 'center';
                distanceContainer.appendChild(distanceEl);
                if (keywords.length > 0) {
                    distanceContainer.appendChild(keywordsContainer);
                }
                
                li.appendChild(nameEl);
                li.appendChild(addressEl);
                li.appendChild(distanceContainer);
                
                fragment.appendChild(li);
            }
            
            // Ìïú Î≤àÏóê DOMÏóê Ï∂îÍ∞Ä (Î¶¨ÌîåÎ°úÏö∞ ÏµúÏÜåÌôî)
            cafeList.appendChild(fragment);
        }

        // Ïπ¥Ìéò ÌäπÏßï ÌÇ§ÏõåÎìú Ï∂îÏ∂ú (ÎÑ§Ïù¥Î≤Ñ Î∏îÎ°úÍ∑∏ Î¶¨Î∑∞ÏóêÏÑú Ïã§Ï†ú ÌÖçÏä§Ìä∏ Î∂ÑÏÑù, ÏµúÏÜå 1Í∞ú ~ ÏµúÎåÄ 3Í∞ú)
        async function extractCafeKeywords(cafeName, cafeAddress) {
            try {
                // Ïπ¥Ìéò Ïù¥Î¶ÑÍ≥º Ï£ºÏÜåÎ•º Ï°∞Ìï©ÌïòÏó¨ Í≤ÄÏÉâÏñ¥ ÏÉùÏÑ±
                const searchQuery = cafeAddress 
                    ? `${cafeName} ${cafeAddress.split(' ').slice(0, 3).join(' ')}`
                    : cafeName;
                
                // ÎÑ§Ïù¥Î≤Ñ Î∏îÎ°úÍ∑∏ Í≤ÄÏÉâ API Ìò∏Ï∂ú
                const blogData = await callNaverAPI('blog', {
                    query: searchQuery,
                    display: 30, // Îçî ÎßéÏùÄ Î∏îÎ°úÍ∑∏ Ìè¨Ïä§Ìä∏ Í≤ÄÏÉâ
                    sort: 'sim'  // Í¥ÄÎ†®ÎèÑÏàú Ï†ïÎ†¨
                });

                if (!blogData.items || blogData.items.length === 0) {
                    // Î∏îÎ°úÍ∑∏ Í≤ÄÏÉâ Ïã§Ìå® Ïãú Ïπ¥Ìéò Ïù¥Î¶ÑÏóêÏÑú ÌÇ§ÏõåÎìú Ï∂îÏ∂ú ÏãúÎèÑ
                    console.warn('Î∏îÎ°úÍ∑∏ Í≤ÄÏÉâ Í≤∞Í≥º ÏóÜÏùå, Ïπ¥Ìéò Ïù¥Î¶ÑÏóêÏÑú ÌÇ§ÏõåÎìú Ï∂îÏ∂ú ÏãúÎèÑ:', cafeName);
                    return extractKeywordsFromName(cafeName);
                }

                // Î™®Îì† Î∏îÎ°úÍ∑∏ Ìè¨Ïä§Ìä∏Ïùò Ï†úÎ™©Í≥º ÏÑ§Î™ÖÏùÑ Ìï©Ï≥êÏÑú ÌÖçÏä§Ìä∏ Î∂ÑÏÑù
                const allText = blogData.items
                    .map(item => {
                        // HTML ÌÉúÍ∑∏ Ï†úÍ±∞
                        const title = (item.title || '').replace(/<[^>]*>/g, ' ');
                        const description = (item.description || '').replace(/<[^>]*>/g, ' ');
                        return `${title} ${description}`;
                    })
                    .join(' ');

                // Î©îÎâ¥ Í¥ÄÎ†® ÌÇ§ÏõåÎìú Ìå®ÌÑ¥ (Í∞ÑÎã®ÌïòÍ≥† Ïú†Ïó∞Ìïú Ìå®ÌÑ¥ÏúºÎ°ú Î≥ÄÍ≤Ω)
                // Îã®Ïñ¥ Í≤ΩÍ≥Ñ ÏóÜÏù¥ Îã®ÏàúÌïòÍ≤å Îß§Ïπ≠
                const menuPatterns = [
                    // ÎîîÏ†ÄÌä∏/ÏºÄÏù¥ÌÅ¨ Í¥ÄÎ†®
                    { pattern: /ÏºÄÏù¥ÌÅ¨/gi, keyword: 'ÏºÄÏù¥ÌÅ¨' },
                    { pattern: /ÎßàÏπ¥Î°±/gi, keyword: 'ÎßàÏπ¥Î°±' },
                    { pattern: /Î∏åÎùºÏö∞Îãà/gi, keyword: 'Î∏åÎùºÏö∞Îãà' },
                    { pattern: /Ïø†ÌÇ§/gi, keyword: 'Ïø†ÌÇ§' },
                    { pattern: /ÌååÏö¥ÎìúÏºÄÏù¥ÌÅ¨|ÌååÏö¥Îìú/gi, keyword: 'ÌååÏö¥ÎìúÏºÄÏù¥ÌÅ¨' },
                    { pattern: /ÎîîÏ†ÄÌä∏/gi, keyword: 'ÎîîÏ†ÄÌä∏' },
                    { pattern: /ÌÉÄÎ•¥Ìä∏/gi, keyword: 'ÌÉÄÎ•¥Ìä∏' },
                    { pattern: /Ìã∞ÎùºÎØ∏Ïàò/gi, keyword: 'Ìã∞ÎùºÎØ∏Ïàò' },
                    { pattern: /Ï¥àÏΩúÎ¶ø/gi, keyword: 'Ï¥àÏΩúÎ¶ø' },
                    { pattern: /ÏôÄÌîå/gi, keyword: 'ÏôÄÌîå' },
                    
                    // Ïª§Ìîº/ÏõêÎëê Í¥ÄÎ†®
                    { pattern: /ÏõêÎëê/gi, keyword: 'ÏõêÎëê' },
                    { pattern: /Î°úÏä§ÌåÖ/gi, keyword: 'Î°úÏä§ÌåÖ' },
                    { pattern: /ÎìúÎ¶ΩÏª§Ìîº|Ìï∏ÎìúÎìúÎ¶Ω|ÎìúÎ¶Ω/gi, keyword: 'ÎìúÎ¶Ω' },
                    { pattern: /ÏóêÏä§ÌîÑÎ†àÏÜå/gi, keyword: 'ÏóêÏä§ÌîÑÎ†àÏÜå' },
                    { pattern: /Ïπ¥ÌéòÎùºÎñº|ÎùºÎñº/gi, keyword: 'ÎùºÎñº' },
                    { pattern: /ÏïÑÎ©îÎ¶¨Ïπ¥ÎÖ∏/gi, keyword: 'ÏïÑÎ©îÎ¶¨Ïπ¥ÎÖ∏' },
                    { pattern: /ÏΩúÎìúÎ∏åÎ£®/gi, keyword: 'ÏΩúÎìúÎ∏åÎ£®' },
                    { pattern: /Ïπ¥Ìë∏ÏπòÎÖ∏/gi, keyword: 'Ïπ¥Ìë∏ÏπòÎÖ∏' },
                    { pattern: /Î∞îÎãêÎùºÎùºÎñº|Î∞îÎãêÎùº/gi, keyword: 'Î∞îÎãêÎùºÎùºÎñº' },
                    
                    // Îπµ/Î≤†Ïù¥Ïª§Î¶¨ Í¥ÄÎ†®
                    { pattern: /Î≤†Ïù¥Ïª§Î¶¨/gi, keyword: 'Î≤†Ïù¥Ïª§Î¶¨' },
                    { pattern: /Î≤†Ïù¥Í∏Ä/gi, keyword: 'Î≤†Ïù¥Í∏Ä' },
                    { pattern: /ÌÅ¨Î£®ÏïÑÏÉÅ/gi, keyword: 'ÌÅ¨Î£®ÏïÑÏÉÅ' },
                    { pattern: /Î∞îÍ≤åÌä∏/gi, keyword: 'Î∞îÍ≤åÌä∏' },
                    { pattern: /Î∏åÎ†àÎìú/gi, keyword: 'Î∏åÎ†àÎìú' },
                    // "Îπµ"ÏùÄ ÎÑàÎ¨¥ ÏùºÎ∞òÏ†ÅÏù¥Ïñ¥ÏÑú Ï†úÏô∏
                    
                    // Î∏åÎü∞Ïπò Í¥ÄÎ†®
                    { pattern: /Î∏åÎü∞Ïπò/gi, keyword: 'Î∏åÎü∞Ïπò' },
                    { pattern: /ÏóêÍ∑∏Î≤†ÎÑ§ÎîïÌä∏|Î≤†ÎÑ§ÎîïÌä∏/gi, keyword: 'ÏóêÍ∑∏Î≤†ÎÑ§ÎîïÌä∏' },
                    { pattern: /ÏÉêÎü¨Îìú/gi, keyword: 'ÏÉêÎü¨Îìú' },
                    { pattern: /ÌååÎãàÎãà/gi, keyword: 'ÌååÎãàÎãà' },
                    { pattern: /ÌÜ†Ïä§Ìä∏/gi, keyword: 'ÌÜ†Ïä§Ìä∏' },
                    
                    // Ï∞®/Ìã∞ Í¥ÄÎ†® (ÏùºÎ∞òÏ†ÅÏù∏ Îã®Ïñ¥ Ï†úÏô∏, Íµ¨Ï≤¥Ï†ÅÏù∏ Í≤ÉÎßå)
                    { pattern: /ÌóàÎ∏åÌã∞/gi, keyword: 'ÌóàÎ∏åÌã∞' },
                    { pattern: /ÎÖπÏ∞®/gi, keyword: 'ÎÖπÏ∞®' },
                    { pattern: /ÌôçÏ∞®/gi, keyword: 'ÌôçÏ∞®' },
                    { pattern: /Ïö∞Î°±Ï∞®/gi, keyword: 'Ïö∞Î°±Ï∞®' },
                    { pattern: /Î∞ÄÌÅ¨Ìã∞/gi, keyword: 'Î∞ÄÌÅ¨Ìã∞' },
                    // "Ìã∞"ÏôÄ "Ï∞®"Îäî ÎÑàÎ¨¥ ÏùºÎ∞òÏ†ÅÏù¥Ïñ¥ÏÑú Ï†úÏô∏
                    
                    // ÌäπÏàò Ïπ¥Ìéò Ïú†Ìòï
                    { pattern: /Ìé´Ïπ¥Ìéò|Ìé´ Ïπ¥Ìéò/gi, keyword: 'Ìé´Ïπ¥Ìéò' },
                    { pattern: /Î∂ÅÏπ¥Ìéò|Î∂Å Ïπ¥Ìéò/gi, keyword: 'Î∂ÅÏπ¥Ìéò' }
                ];

                // Í∞Å Î©îÎâ¥ ÌÇ§ÏõåÎìúÏùò Ï∂úÌòÑ ÎπàÎèÑ Í≥ÑÏÇ∞ (ÏÑ±Îä• ÏµúÏ†ÅÌôî: for...of ÏÇ¨Ïö©)
                const keywordScores = {};
                for (const { pattern, keyword } of menuPatterns) {
                    const matches = allText.match(pattern);
                    if (matches && matches.length > 0) {
                        // Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎ©¥ ÎπàÎèÑ Ï∂îÍ∞Ä, ÏóÜÏúºÎ©¥ ÏÉàÎ°ú Ï∂îÍ∞Ä
                        keywordScores[keyword] = (keywordScores[keyword] || 0) + matches.length;
                    }
                }

                // ÎîîÎ≤ÑÍπÖ: ÌÇ§ÏõåÎìú Ï∂îÏ∂ú Í≤∞Í≥º ÌôïÏù∏
                console.log('ÌÇ§ÏõåÎìú Ï∂îÏ∂ú Í≤∞Í≥º:', {
                    cafeName,
                    searchQuery,
                    blogItemsCount: blogData.items?.length || 0,
                    allTextLength: allText.length,
                    allTextSample: allText.substring(0, 200), // Ï≤òÏùå 200ÏûêÎßå ÏÉòÌîå
                    keywordScores,
                    sortedKeywords: Object.entries(keywordScores).sort((a, b) => b[1] - a[1]).slice(0, 3)
                });

                // ÎπàÎèÑ ÏàúÏúºÎ°ú Ï†ïÎ†¨ÌïòÍ≥† ÏÉÅÏúÑ 3Í∞ú ÏÑ†ÌÉù (ÏµúÎåÄ 3Í∞ú)
                const sortedKeywords = Object.entries(keywordScores)
                    .sort((a, b) => b[1] - a[1]) // ÎπàÎèÑ ÎÇ¥Î¶ºÏ∞®Ïàú
                    .slice(0, 3) // ÏµúÎåÄ 3Í∞ú
                    .map(([keyword]) => keyword);

                // ÏµúÏÜå 1Í∞ú Ïù¥ÏÉÅÏù¥Î©¥ Î∞òÌôò, ÏóÜÏúºÎ©¥ Îπà Î∞∞Ïó¥ (Í∞ïÏ†ú Î≥¥Ï∂© Í∏àÏßÄ)
                return sortedKeywords.length > 0 ? sortedKeywords : [];
            } catch (error) {
                console.error('ÌÇ§ÏõåÎìú Ï∂îÏ∂ú Ïã§Ìå®:', error);
                // ÏóêÎü¨ Î∞úÏÉù Ïãú Ïπ¥Ìéò Ïù¥Î¶ÑÏóêÏÑú ÌÇ§ÏõåÎìú Ï∂îÏ∂ú ÏãúÎèÑ
                return extractKeywordsFromName(cafeName);
            }
        }

        // Ïπ¥Ìéò ÏöîÏïΩ ÏÑ§Î™Ö ÏÉùÏÑ± (ÎÑ§Ïù¥Î≤Ñ Î∏îÎ°úÍ∑∏ Î¶¨Î∑∞ÏóêÏÑú 50-70Ïûê ÏöîÏïΩ)
        async function extractCafeSummary(cafeName, cafeAddress) {
            try {
                // Ïπ¥Ìéò Ïù¥Î¶ÑÍ≥º Ï£ºÏÜåÎ•º Ï°∞Ìï©ÌïòÏó¨ Í≤ÄÏÉâÏñ¥ ÏÉùÏÑ±
                const searchQuery = cafeAddress 
                    ? `${cafeName} ${cafeAddress.split(' ').slice(0, 3).join(' ')}`
                    : cafeName;
                
                // ÎÑ§Ïù¥Î≤Ñ Î∏îÎ°úÍ∑∏ Í≤ÄÏÉâ API Ìò∏Ï∂ú
                const blogData = await callNaverAPI('blog', {
                    query: searchQuery,
                    display: 20, // ÏöîÏïΩÏùÑ ÏúÑÌï¥ Ï∂©Î∂ÑÌïú Î¶¨Î∑∞ ÏàòÏßë
                    sort: 'sim'  // Í¥ÄÎ†®ÎèÑÏàú Ï†ïÎ†¨
                });

                if (!blogData.items || blogData.items.length === 0) {
                    return '';
                }

                // Î™®Îì† Î∏îÎ°úÍ∑∏ Ìè¨Ïä§Ìä∏Ïùò Ï†úÎ™©Í≥º ÏÑ§Î™ÖÏùÑ Ìï©Ï≥êÏÑú ÌÖçÏä§Ìä∏ Î∂ÑÏÑù
                const allText = blogData.items
                    .map(item => {
                        // HTML ÌÉúÍ∑∏ Ï†úÍ±∞
                        const title = (item.title || '').replace(/<[^>]*>/g, ' ');
                        const description = (item.description || '').replace(/<[^>]*>/g, ' ');
                        return `${title} ${description}`;
                    })
                    .join(' ');

                // Ï£ºÏöî ÌäπÏßï Ìå®ÌÑ¥ Î∂ÑÏÑù
                const features = {
                    Î∂ÑÏúÑÍ∏∞: [],
                    Î©îÎâ¥: [],
                    ÌäπÏßï: []
                };

                // Î∂ÑÏúÑÍ∏∞ Í¥ÄÎ†® ÌÇ§ÏõåÎìú
                const atmospherePatterns = [
                    { pattern: /ÏïÑÎäë|Ìé∏Ïïà|Ï°∞Ïö©|Ï∞®Î∂Ñ|ÌûêÎßÅ|Ïó¨Ïú†/gi, keyword: 'ÏïÑÎäëÌïú' },
                    { pattern: /ÎÑì|Í≥µÍ∞Ñ|Ïó¨Ïú†|Ïó¨Ïú†Î°úÏö¥/gi, keyword: 'ÎÑìÏùÄ' },
                    { pattern: /ÏòàÏÅú|ÏòàÏà†|Ïù∏ÌÖåÎ¶¨Ïñ¥|ÎîîÏûêÏù∏|ÍπîÎÅî/gi, keyword: 'ÏòàÏÅú' },
                    { pattern: /Î°úÎß®Ìã±|Îç∞Ïù¥Ìä∏|Ïª§Ìîå/gi, keyword: 'Î°úÎß®Ìã±Ìïú' },
                    { pattern: /Ïä§ÌÑ∞Îîî|Í≥µÎ∂Ä|Ï°∞Ïö©|ÏßëÏ§ë/gi, keyword: 'Ïä§ÌÑ∞ÎîîÌïòÍ∏∞ Ï¢ãÏùÄ' }
                ];

                // Î©îÎâ¥ Í¥ÄÎ†® ÌÇ§ÏõåÎìú
                const menuPatterns = [
                    { pattern: /ÏºÄÏù¥ÌÅ¨|ÎßàÏπ¥Î°±|ÎîîÏ†ÄÌä∏/gi, keyword: 'ÎîîÏ†ÄÌä∏' },
                    { pattern: /ÏõêÎëê|Î°úÏä§ÌåÖ|ÎìúÎ¶Ω/gi, keyword: 'ÏõêÎëê' },
                    { pattern: /Î∏åÎü∞Ïπò|ÏÉêÎü¨Îìú|ÌÜ†Ïä§Ìä∏/gi, keyword: 'Î∏åÎü∞Ïπò' },
                    { pattern: /Î≤†Ïù¥Ïª§Î¶¨|Îπµ|Î≤†Ïù¥Í∏Ä/gi, keyword: 'Î≤†Ïù¥Ïª§Î¶¨' }
                ];

                // ÌäπÏßï Í¥ÄÎ†® ÌÇ§ÏõåÎìú (Ï£ºÏ∞® Ï†úÏô∏)
                const specialPatterns = [
                    { pattern: /Ìé´|Î∞òÎ†§ÎèôÎ¨º|Í∞ïÏïÑÏßÄ|Í≥†ÏñëÏù¥/gi, keyword: 'Ìé´Ïπ¥Ìéò' },
                    { pattern: /Î∂Å|Ï±Ö|ÎèÖÏÑú/gi, keyword: 'Î∂ÅÏπ¥Ìéò' },
                    { pattern: /ÌÖåÎùºÏä§|ÏïºÏô∏|Î£®ÌîÑÌÉë/gi, keyword: 'ÏïºÏô∏ÏÑù' }
                ];

                // Ìå®ÌÑ¥ Îß§Ïπ≠ Î∞è ÎπàÎèÑ Í≥ÑÏÇ∞ (ÏÑ±Îä• ÏµúÏ†ÅÌôî: for...of ÏÇ¨Ïö©)
                for (const { pattern, keyword } of atmospherePatterns) {
                    const matches = allText.match(pattern);
                    if (matches && matches.length > 0) {
                        features.Î∂ÑÏúÑÍ∏∞.push({ keyword, count: matches.length });
                    }
                }

                for (const { pattern, keyword } of menuPatterns) {
                    const matches = allText.match(pattern);
                    if (matches && matches.length > 0) {
                        features.Î©îÎâ¥.push({ keyword, count: matches.length });
                    }
                }

                for (const { pattern, keyword } of specialPatterns) {
                    const matches = allText.match(pattern);
                    if (matches && matches.length > 0) {
                        features.ÌäπÏßï.push({ keyword, count: matches.length });
                    }
                }

                // ÎπàÎèÑÏàúÏúºÎ°ú Ï†ïÎ†¨
                features.Î∂ÑÏúÑÍ∏∞.sort((a, b) => b.count - a.count);
                features.Î©îÎâ¥.sort((a, b) => b.count - a.count);
                features.ÌäπÏßï.sort((a, b) => b.count - a.count);

                // ÏöîÏïΩ Î¨∏Ïû• ÏÉùÏÑ±
                const summaryParts = [];

                // Î∂ÑÏúÑÍ∏∞ Ï∂îÍ∞Ä
                if (features.Î∂ÑÏúÑÍ∏∞.length > 0) {
                    summaryParts.push(features.Î∂ÑÏúÑÍ∏∞[0].keyword);
                }

                // Î©îÎâ¥ Ï∂îÍ∞Ä
                if (features.Î©îÎâ¥.length > 0) {
                    summaryParts.push(features.Î©îÎâ¥[0].keyword);
                }

                // ÌäπÏßï Ï∂îÍ∞Ä
                if (features.ÌäπÏßï.length > 0) {
                    summaryParts.push(features.ÌäπÏßï[0].keyword);
                }

                // Î¶¨Î∑∞ ÌÖçÏä§Ìä∏ÏóêÏÑú Ïã§Ï†ú ÌëúÌòÑ Ï∂îÏ∂ú (ÌïòÎìú ÏΩîÎî© Î¨∏Íµ¨ Ï†úÍ±∞)
                // Î¶¨Î∑∞ Î¨∏Ïû•Îì§ÏùÑ Î∂ÑÏÑùÌïòÏó¨ ÏûêÏó∞Ïä§Îü¨Ïö¥ ÌëúÌòÑ Ï∂îÏ∂ú
                const sentences = allText.split(/[\.!?„ÄÇÔºÅÔºü]/).filter(s => s.trim().length > 5);
                
                // Ïπ¥Ìéò ÌäπÏßïÍ≥º Í¥ÄÎ†®Îêú Î¨∏Ïû• Ï∂îÏ∂ú
                const relevantSentences = sentences.filter(sentence => {
                    const lowerSentence = sentence.toLowerCase();
                    return /Î∂ÑÏúÑÍ∏∞|Îßõ|Î©îÎâ¥|Ïª§Ìîº|ÎîîÏ†ÄÌä∏|Ïù∏ÌÖåÎ¶¨Ïñ¥|Í≥µÍ∞Ñ|Ìé∏Ïïà|Ï¢ã|Ï∂îÏ≤ú|Ïù∏Í∏∞|ÌäπÎ≥Ñ/.test(lowerSentence) &&
                           !/Ï£ºÏ∞®|Ï£ºÏ∞®Ïû•|ÌååÌÇπ/.test(lowerSentence); // Ï£ºÏ∞® Ïñ∏Í∏â Ï†úÏô∏
                });

                // ÏöîÏïΩ Î¨∏Ïû• ÏÉùÏÑ± (50-70Ïûê, Ïã§ÏãúÍ∞Ñ Î¶¨Î∑∞ Î∂ÑÏÑù)
                let summary = '';
                
                if (relevantSentences.length > 0) {
                    // Î¶¨Î∑∞ÏóêÏÑú Ïã§Ï†ú ÏÇ¨Ïö©Îêú ÌëúÌòÑ Ï∂îÏ∂ú
                    const atmosphere = features.Î∂ÑÏúÑÍ∏∞.length > 0 ? features.Î∂ÑÏúÑÍ∏∞[0].keyword : '';
                    const menu = features.Î©îÎâ¥.length > 0 ? features.Î©îÎâ¥[0].keyword : '';
                    const special = features.ÌäπÏßï.length > 0 ? features.ÌäπÏßï[0].keyword : '';
                    
                    // Î¶¨Î∑∞ÏóêÏÑú Ïã§Ï†ú ÌëúÌòÑ Ìå®ÌÑ¥ Ï∞æÍ∏∞
                    const expressionPatterns = [
                        { pattern: /([^\.!?]{10,30})(?:Ïù¥|Í∞Ä|ÏùÑ|Î•º|ÏùÄ|Îäî|Ïóê|ÏóêÏÑú|ÏúºÎ°ú|Î°ú|ÏôÄ|Í≥º|Ïùò|Ïù¥Îã§|ÏûÖÎãàÎã§|Ìï¥Ïöî|ÌñàÏñ¥Ïöî|ÌñàÏñ¥|Ìï¥|ÌïúÎã§|ÌïúÎã§Í≥†|ÌïúÎã§Îäî)/g, type: 'descriptive' },
                        { pattern: /([^\.!?]{8,25})(?:Ï¢ã|Ï∂îÏ≤ú|Ïù∏Í∏∞|ÎßõÏûà|ÌäπÎ≥Ñ|ÏòàÏÅú|ÍπîÎÅî|Ìé∏Ïïà)/g, type: 'positive' }
                    ];
                    
                    const extractedPhrases = [];
                    // ÏÑ±Îä• ÏµúÏ†ÅÌôî: for...of ÏÇ¨Ïö©
                    for (const sentence of relevantSentences) {
                        for (const { pattern, type } of expressionPatterns) {
                            const matches = sentence.match(pattern);
                            if (matches) {
                                for (const match of matches) {
                                    const cleanMatch = match.trim().replace(/[\.!?„ÄÇÔºÅÔºü]$/, '');
                                    if (cleanMatch.length >= 8 && cleanMatch.length <= 30) {
                                        extractedPhrases.push(cleanMatch);
                                    }
                                }
                            }
                        }
                    }
                    
                    // Ï∂îÏ∂úÎêú ÌëúÌòÑÎì§ÏùÑ Ï°∞Ìï©ÌïòÏó¨ ÏûêÏó∞Ïä§Îü¨Ïö¥ Î¨∏Ïû• ÏÉùÏÑ±
                    if (atmosphere && menu && special) {
                        // Î¶¨Î∑∞ÏóêÏÑú Ïã§Ï†ú ÌëúÌòÑ Ï∞æÍ∏∞
                        const atmospherePhrase = extractedPhrases.find(p => 
                            new RegExp(atmosphere.replace(/Ìïú|Ìïú$/, ''), 'i').test(p)
                        ) || `${atmosphere} Î∂ÑÏúÑÍ∏∞`;
                        
                        summary = `${atmospherePhrase}Î°ú ${menu}ÏôÄ ${special}Í∞Ä ÌäπÏßïÏù∏ Ïπ¥ÌéòÏûÖÎãàÎã§.`;
                    } else if (atmosphere && menu) {
                        const atmospherePhrase = extractedPhrases.find(p => 
                            new RegExp(atmosphere.replace(/Ìïú|Ìïú$/, ''), 'i').test(p)
                        ) || `${atmosphere} Î∂ÑÏúÑÍ∏∞`;
                        
                        summary = `${atmospherePhrase}ÏôÄ ${menu}Í∞Ä Ïú†Î™ÖÌïú Ïπ¥ÌéòÏûÖÎãàÎã§.`;
                    } else if (atmosphere && special) {
                        const atmospherePhrase = extractedPhrases.find(p => 
                            new RegExp(atmosphere.replace(/Ìïú|Ìïú$/, ''), 'i').test(p)
                        ) || `${atmosphere} Î∂ÑÏúÑÍ∏∞`;
                        
                        summary = `${atmospherePhrase}ÏôÄ ${special}Í∞Ä ÌäπÏßïÏù∏ Ïπ¥ÌéòÏûÖÎãàÎã§.`;
                    } else if (menu && special) {
                        summary = `${menu}ÏôÄ ${special}Í∞Ä ÌäπÎ≥ÑÌïú Ïπ¥ÌéòÏûÖÎãàÎã§.`;
                    } else if (atmosphere) {
                        const atmospherePhrase = extractedPhrases.find(p => 
                            new RegExp(atmosphere.replace(/Ìïú|Ìïú$/, ''), 'i').test(p)
                        ) || `${atmosphere} Î∂ÑÏúÑÍ∏∞`;
                        
                        summary = `${atmospherePhrase}Í∞Ä Îß§Î†•Ï†ÅÏù∏ Ïπ¥ÌéòÏûÖÎãàÎã§.`;
                    } else if (menu) {
                        summary = `${menu}Í∞Ä ÌäπÌûà Ïù∏Í∏∞ ÏûàÎäî Ïπ¥ÌéòÏûÖÎãàÎã§.`;
                    } else if (special) {
                        summary = `${special}Í∞Ä ÌäπÏßïÏù∏ Ïπ¥ÌéòÏûÖÎãàÎã§.`;
                    } else if (extractedPhrases.length > 0) {
                        // Ï∂îÏ∂úÎêú ÌëúÌòÑ ÏÇ¨Ïö©
                        const firstPhrase = extractedPhrases[0];
                        summary = `${firstPhrase} Ïπ¥ÌéòÏûÖÎãàÎã§.`;
                    } else {
                        // Î¶¨Î∑∞ÏóêÏÑú ÏßÅÏ†ë Î¨∏Ïû• Ï∂îÏ∂ú
                        const shortSentences = relevantSentences.filter(s => s.length >= 20 && s.length <= 50);
                        if (shortSentences.length > 0) {
                            summary = shortSentences[0].trim();
                        }
                    }
                } else {
                    // Í¥ÄÎ†® Î¨∏Ïû•Ïù¥ ÏóÜÏúºÎ©¥ ÌäπÏßï ÌÇ§ÏõåÎìúÎ°úÎßå Íµ¨ÏÑ±
                    const atmosphere = features.Î∂ÑÏúÑÍ∏∞.length > 0 ? features.Î∂ÑÏúÑÍ∏∞[0].keyword : '';
                    const menu = features.Î©îÎâ¥.length > 0 ? features.Î©îÎâ¥[0].keyword : '';
                    const special = features.ÌäπÏßï.length > 0 ? features.ÌäπÏßï[0].keyword : '';
                    
                    if (atmosphere && menu) {
                        summary = `${atmosphere} Î∂ÑÏúÑÍ∏∞ÏôÄ ${menu}Í∞Ä Ïú†Î™ÖÌïú Ïπ¥ÌéòÏûÖÎãàÎã§.`;
                    } else if (atmosphere) {
                        summary = `${atmosphere} Î∂ÑÏúÑÍ∏∞Ïùò Ïπ¥ÌéòÏûÖÎãàÎã§.`;
                    } else if (menu) {
                        summary = `${menu}Í∞Ä Ïù∏Í∏∞Ïù∏ Ïπ¥ÌéòÏûÖÎãàÎã§.`;
                    } else if (special) {
                        summary = `${special}Í∞Ä ÌäπÏßïÏù∏ Ïπ¥ÌéòÏûÖÎãàÎã§.`;
                    }
                }

                // ÏµúÏ¢Ö Í∏∏Ïù¥ ÌôïÏù∏ Î∞è Ï°∞Ï†ï (50-70Ïûê)
                if (summary.length < 50) {
                    // Î¶¨Î∑∞ÏóêÏÑú Ï∂îÍ∞Ä ÌëúÌòÑ Ï∞æÍ∏∞
                    const additionalPhrases = sentences
                        .filter(s => s.length >= 15 && s.length <= 40)
                        .filter(s => !/Ï£ºÏ∞®|Ï£ºÏ∞®Ïû•|ÌååÌÇπ/.test(s))
                        .slice(0, 3);
                    
                    if (additionalPhrases.length > 0) {
                        const additional = additionalPhrases[0].trim();
                        if (summary.length + additional.length <= 70) {
                            summary = summary.replace('ÏûÖÎãàÎã§.', ` ${additional}ÏûÖÎãàÎã§.`);
                        }
                    }
                    
                    // Ïó¨Ï†ÑÌûà ÏßßÏúºÎ©¥ Î¶¨Î∑∞ÏóêÏÑú ÏßÅÏ†ë Ï∂îÏ∂ú
                    if (summary.length < 50) {
                        const reviewSentences = sentences
                            .filter(s => s.length >= 25 && s.length <= 45)
                            .filter(s => !/Ï£ºÏ∞®|Ï£ºÏ∞®Ïû•|ÌååÌÇπ/.test(s));
                        
                        if (reviewSentences.length > 0) {
                            summary = reviewSentences[0].trim();
                        }
                    }
                }
                
                if (summary.length > 70) {
                    // ÎÑàÎ¨¥ Í∏∏Î©¥ ÏûêÏó∞Ïä§ÎüΩÍ≤å Ï∂ïÏïΩ
                    const sentences = summary.split(/[\.!?„ÄÇÔºÅÔºü]/).filter(s => s.trim().length > 0);
                    if (sentences.length > 1) {
                        summary = sentences[0].trim() + 'ÏûÖÎãàÎã§.';
                        if (summary.length > 70) {
                            summary = summary.substring(0, 67) + '...';
                        }
                    } else {
                        // Î¨∏Ïû•Ïù¥ ÌïòÎÇòÎ©¥ Ï§ëÍ∞Ñ Î∂ÄÎ∂Ñ Ï†úÍ±∞
                        if (summary.length > 70) {
                            const midPoint = Math.floor(summary.length / 2);
                            summary = summary.substring(0, midPoint - 5) + '...' + summary.substring(midPoint + 5);
                            if (summary.length > 70) {
                                summary = summary.substring(0, 67) + '...';
                            }
                        }
                    }
                }

                // ÏµúÏÜå 50Ïûê Î≥¥Ïû•
                if (summary.length < 50 && summary.length > 0) {
                    // Î¶¨Î∑∞ÏóêÏÑú Î≥¥Ï∂© Î¨∏Ïû• Ï∞æÍ∏∞
                    const supplementSentences = sentences
                        .filter(s => s.length >= 20 && s.length <= 30)
                        .filter(s => !/Ï£ºÏ∞®|Ï£ºÏ∞®Ïû•|ÌååÌÇπ/.test(s));
                    
                    if (supplementSentences.length > 0) {
                        const supplement = supplementSentences[0].trim();
                        if (summary.length + supplement.length <= 70) {
                            summary = summary + ' ' + supplement;
                        }
                    }
                }

                return summary.substring(0, 70); // ÏµúÎåÄ 70Ïûê
            } catch (error) {
                console.error('ÏöîÏïΩ ÏÉùÏÑ± Ïã§Ìå®:', error);
                return '';
            }
        }

        // Ïπ¥Ìéò Ïù¥Î¶ÑÏóêÏÑú ÌÇ§ÏõåÎìú Ï∂îÏ∂ú (Ìè¥Î∞±)
        function extractKeywordsFromName(cafeName) {
            const keywords = [];
            const name = (cafeName || '').toLowerCase();
            
            const namePatterns = [
                { pattern: /ÏºÄÏù¥ÌÅ¨|cake/gi, keyword: 'ÏºÄÏù¥ÌÅ¨' },
                { pattern: /ÎßàÏπ¥Î°±|macaron/gi, keyword: 'ÎßàÏπ¥Î°±' },
                { pattern: /Î∏åÎùºÏö∞Îãà|brownie/gi, keyword: 'Î∏åÎùºÏö∞Îãà' },
                { pattern: /ÎîîÏ†ÄÌä∏|dessert/gi, keyword: 'ÎîîÏ†ÄÌä∏' },
                { pattern: /ÏõêÎëê|bean/gi, keyword: 'ÏõêÎëê' },
                { pattern: /Î°úÏä§ÌåÖ|roasting/gi, keyword: 'Î°úÏä§ÌåÖ' },
                { pattern: /ÎìúÎ¶Ω|drip/gi, keyword: 'ÎìúÎ¶Ω' },
                { pattern: /ÏóêÏä§ÌîÑÎ†àÏÜå|espresso/gi, keyword: 'ÏóêÏä§ÌîÑÎ†àÏÜå' },
                { pattern: /ÎùºÎñº|latte/gi, keyword: 'ÎùºÎñº' },
                { pattern: /ÏïÑÎ©îÎ¶¨Ïπ¥ÎÖ∏|americano/gi, keyword: 'ÏïÑÎ©îÎ¶¨Ïπ¥ÎÖ∏' },
                { pattern: /ÏΩúÎìúÎ∏åÎ£®|coldbrew/gi, keyword: 'ÏΩúÎìúÎ∏åÎ£®' },
                { pattern: /Î≤†Ïù¥Ïª§Î¶¨|bakery/gi, keyword: 'Î≤†Ïù¥Ïª§Î¶¨' },
                { pattern: /Î∏åÎü∞Ïπò|brunch/gi, keyword: 'Î∏åÎü∞Ïπò' },
                { pattern: /ÌóàÎ∏åÌã∞|herbtea/gi, keyword: 'ÌóàÎ∏åÌã∞' },
                { pattern: /Ìé´|pet/gi, keyword: 'Ìé´Ïπ¥Ìéò' },
                { pattern: /Î∂Å|book/gi, keyword: 'Î∂ÅÏπ¥Ìéò' }
            ];
            
            // ÏÑ±Îä• ÏµúÏ†ÅÌôî: for...of ÏÇ¨Ïö©
            for (const { pattern, keyword } of namePatterns) {
                if (pattern.test(name) && keywords.length < 3 && !keywords.includes(keyword)) {
                    keywords.push(keyword);
                }
            }
            
            return keywords;
        }

        // Ïπ¥Ìéò Í≤ÄÏÉâ
        async function searchCafes(address) {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const resultsSection = document.getElementById('resultsSection');
            const cafeList = document.getElementById('cafeList');
            const resultsHeader = document.getElementById('resultsHeader');

            // UI Ï¥àÍ∏∞Ìôî
            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            resultsSection.style.display = 'none';
            cafeList.innerHTML = '';

            try {
                // 1Îã®Í≥Ñ: Ïπ¥Ïπ¥Ïò§ APIÎ°ú Ï£ºÏÜåÎ•º Ï¢åÌëúÎ°ú Î≥ÄÌôò (Ï†ïÌôïÌïú Ï£ºÏÜå Í≤ÄÏÉâ)
                const addressData = await callKakaoAPI('address', {
                    query: address,
                    size: 1
                });

                if (!addressData.documents || addressData.documents.length === 0) {
                    throw new Error('Ï£ºÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Ï£ºÏÜå ÌòïÏãùÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
                }

                const location = addressData.documents[0];
                const baseX = parseFloat(location.x); // Í≤ΩÎèÑ
                const baseY = parseFloat(location.y); // ÏúÑÎèÑ

                // 2Îã®Í≥Ñ: Ïπ¥Ïπ¥Ïò§ APIÎ°ú 500m Î∞òÍ≤Ω ÎÇ¥ Ïû•ÏÜå Í≤ÄÏÉâ (Î∞òÍ≤Ω Í≤ÄÏÉâ ÏßÄÏõê)
                const radius = 500; // 500m
                const categorySelect = document.getElementById('categorySelect');
                const selectedCategory = categorySelect.value; // ÏÑ†ÌÉùÎêú Ïπ¥ÌÖåÍ≥†Î¶¨
                const cafeData = await callKakaoAPI('keyword', {
                    query: selectedCategory,
                    x: baseX,
                    y: baseY,
                    radius: radius,
                    size: 15
                });

                if (!cafeData.documents || cafeData.documents.length === 0) {
                    loadingEl.style.display = 'none';
                    showNoResults();
                    return;
                }

                // 3Îã®Í≥Ñ: Ïπ¥Ìéò Ïπ¥ÌÖåÍ≥†Î¶¨ ÌïÑÌÑ∞ÎßÅ, ÌîÑÎûúÏ∞®Ïù¥Ï¶à Ï†úÏô∏ Î∞è Í±∞Î¶¨ Í≥ÑÏÇ∞
                const cafes = cafeData.documents
                    .filter(doc => {
                        // Ïπ¥ÌÖåÍ≥†Î¶¨ ÌïÑÌÑ∞ÎßÅ: Ïπ¥ÌéòÎßå ÌóàÏö©
                        const categoryName = doc.category_name || '';
                        if (!isCafeCategory(categoryName)) {
                            return false;
                        }
                        // ÌîÑÎûúÏ∞®Ïù¥Ï¶à Ï†úÏô∏
                        const cafeName = doc.place_name || '';
                        return !isExcludedCafe(cafeName);
                    })
                    .map(doc => {
                        const cafeX = parseFloat(doc.x);
                        const cafeY = parseFloat(doc.y);
                        const distance = calculateDistance(baseY, baseX, cafeY, cafeX);
                        
                        // Ïπ¥Ïπ¥Ïò§ API ÏùëÎãµ Íµ¨Ï°∞: road_address Í∞ùÏ≤¥ ÏïàÏóê address_nameÏù¥ ÏûàÏùå
                        const roadAddr = (doc.road_address && doc.road_address.address_name) 
                            ? doc.road_address.address_name 
                            : '';
                        const addr = doc.address_name || '';
                        const placeName = doc.place_name || '';
                        
                        // Ïû•ÏÜåÎ™ÖÏóêÏÑú Ï∏µ Ï†ïÎ≥¥ Ï∂îÏ∂ú
                        const floorInfo = extractFloorInfo(placeName);
                        
                        return {
                            name: placeName,
                            address: addr, // ÏßÄÎ≤à Ï£ºÏÜå
                            roadAddress: roadAddr, // ÎèÑÎ°úÎ™Ö Ï£ºÏÜå
                            displayAddress: roadAddr || addr, // ÌëúÏãúÏö© (ÎèÑÎ°úÎ™Ö Ïö∞ÏÑ†)
                            floor: floorInfo, // Ï∏µ Ï†ïÎ≥¥
                            x: cafeX,
                            y: cafeY,
                            distance: distance,
                            categoryName: doc.category_name || '',
                            doc: doc // Ï£ºÏÜå Ïû¨Ï°∞ÌöåÏö©
                        };
                    })
                    .filter(cafe => cafe.distance <= 500) // 500m Ïù¥ÎÇ¥Îßå
                    .sort((a, b) => a.distance - b.distance); // Í±∞Î¶¨Ïàú Ï†ïÎ†¨

                if (cafes.length === 0) {
                    loadingEl.style.display = 'none';
                    showNoResults();
                    return;
                }

                // ÎèÑÎ°úÎ™Ö Ï£ºÏÜåÍ∞Ä ÏóÜÎäî Ïπ¥ÌéòÎì§Ïùò Ï¢åÌëúÎ°ú Ï£ºÏÜå Ïû¨Ï°∞Ìöå Î∞è Ï∏µ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                // Î°úÎî© Ïï†ÎãàÎ©îÏù¥ÏÖòÏùÄ Ïù¥ ÏûëÏóÖÏù¥ ÏôÑÎ£åÎê† ÎïåÍπåÏßÄ Ïú†ÏßÄ
                const cafesWithAddress = await Promise.all(cafes.map(async (cafe) => {
                    // ÎèÑÎ°úÎ™Ö Ï£ºÏÜåÍ∞Ä ÏóÜÏúºÎ©¥ Ï¢åÌëúÎ°ú Ï£ºÏÜå Ï°∞Ìöå
                    if (!cafe.roadAddress && cafe.x && cafe.y) {
                        try {
                            const coordData = await callKakaoAPI('coord2address', {
                                x: cafe.x,
                                y: cafe.y
                            });
                            
                            if (coordData.documents && coordData.documents.length > 0) {
                                const doc = coordData.documents[0];
                                const roadAddr = (doc.road_address && doc.road_address.address_name) 
                                    ? doc.road_address.address_name 
                                    : '';
                                if (roadAddr) {
                                    cafe.roadAddress = roadAddr;
                                    cafe.displayAddress = roadAddr;
                                }
                            }
                        } catch (error) {
                            console.warn('Ï£ºÏÜå Ïû¨Ï°∞Ìöå Ïã§Ìå®:', cafe.name, error);
                        }
                    }
                    
                    // Ï∏µ Ï†ïÎ≥¥Í∞Ä ÏóÜÏúºÎ©¥ ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ APIÎ°ú Ï∏µ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                    if (!cafe.floor) {
                        try {
                            const searchQuery = cafe.displayAddress || cafe.roadAddress || cafe.address
                                ? `${cafe.name} ${(cafe.displayAddress || cafe.roadAddress || cafe.address).split(' ').slice(0, 2).join(' ')}`
                                : cafe.name;
                            
                            const naverResult = await callNaverAPI('local', {
                                query: searchQuery,
                                display: 1,
                                sort: 'random'
                            });
                            
                            if (naverResult.items && naverResult.items.length > 0) {
                                const item = naverResult.items[0];
                                const title = (item.title || '').replace(/<[^>]*>/g, '');
                                const address = (item.address || '').replace(/<[^>]*>/g, '');
                                const roadAddress = (item.roadAddress || '').replace(/<[^>]*>/g, '');
                                
                                // Ï†úÎ™©, Ï£ºÏÜåÏóêÏÑú Ï∏µ Ï†ïÎ≥¥ Ï∂îÏ∂ú
                                const floorFromTitle = extractFloorInfo(title);
                                const floorFromAddress = extractFloorInfo(address + ' ' + roadAddress);
                                cafe.floor = floorFromTitle || floorFromAddress || '';
                            }
                        } catch (error) {
                            console.warn('Ï∏µ Ï†ïÎ≥¥ Ï°∞Ìöå Ïã§Ìå®:', cafe.name, error);
                            cafe.floor = cafe.floor || '';
                        }
                    }
                    
                    return cafe;
                }));

                // ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ Í∞ÄÎä• Ïó¨Î∂Ä ÌôïÏù∏ Î∞è Ïπ¥ÌÖåÍ≥†Î¶¨ ÌôïÏù∏ (Ïπ¥ÌéòÎßå ÌïÑÌÑ∞ÎßÅ)
                const cafesSearchable = [];
                for (let i = 0; i < cafesWithAddress.length; i++) {
                    const cafe = cafesWithAddress[i];
                    // API Ìò∏Ï∂ú Ï†úÌïúÏùÑ ÏúÑÌï¥ ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ Ï∂îÍ∞Ä (Ï¥àÎãπ 5Í∞ú Ï†úÌïú Í≥†Î†§)
                    if (i > 0 && i % 5 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                    
                    try {
                        const isSearchable = await isSearchableOnNaver(cafe);
                        if (isSearchable) {
                            cafesSearchable.push(cafe);
                            console.log(`ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ Í∞ÄÎä• Î∞è Ïπ¥ÌÖåÍ≥†Î¶¨ "Ïπ¥Ìéò" ÌôïÏù∏ ÏôÑÎ£å [${cafe.name}]`);
                        } else {
                            console.log(`ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ Î∂àÍ∞ÄÎä• ÎòêÎäî Ïπ¥ÌÖåÍ≥†Î¶¨Í∞Ä "Ïπ¥Ìéò"Í∞Ä ÏïÑÎãò - Î¶¨Ïä§ÌåÖ Ï†úÏô∏ [${cafe.name}]`);
                        }
                    } catch (error) {
                        console.warn('ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ Í∞ÄÎä• Ïó¨Î∂Ä ÌôïÏù∏ Ïã§Ìå®:', cafe.name, error);
                        // ÏóêÎü¨ Î∞úÏÉù Ïãú Í≤ÄÏÉâ Í∞ÄÎä•Ìïú Í≤ÉÏúºÎ°ú Í∞ÑÏ£ºÌïòÏßÄ ÏïäÏùå (Ïπ¥ÌÖåÍ≥†Î¶¨ ÌôïÏù∏ Ïã§Ìå® Ïãú Ï†úÏô∏)
                        console.log(`ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ ÌôïÏù∏ Ïã§Ìå®Î°ú Ïù∏Ìïú Î¶¨Ïä§ÌåÖ Ï†úÏô∏ [${cafe.name}]`);
                    }
                }

                // Í∞Å Ïπ¥ÌéòÏóê ÎåÄÌï¥ ÌÇ§ÏõåÎìú Ï∂îÏ∂ú (Î∞∞Ïπò Ï≤òÎ¶¨Î°ú ÏÑ±Îä• Í∞úÏÑ†)
                const cafesWithKeywords = [];
                const keywordBatchSize = 5;
                
                for (let i = 0; i < cafesSearchable.length; i += keywordBatchSize) {
                    const batch = cafesSearchable.slice(i, i + keywordBatchSize);
                    
                    // Î∞∞Ïπò ÎÇ¥ÏóêÏÑú Î≥ëÎ†¨ Ï≤òÎ¶¨
                    const batchResults = await Promise.all(
                        batch.map(async (cafe) => {
                            try {
                                const keywords = await extractCafeKeywords(
                                    cafe.name,
                                    cafe.displayAddress || cafe.roadAddress || cafe.address
                                );
                                console.log(`ÌÇ§ÏõåÎìú Ï∂îÏ∂ú ÏôÑÎ£å [${cafe.name}]:`, keywords);
                                return { ...cafe, keywords: keywords || [] };
                            } catch (error) {
                                console.error('ÌÇ§ÏõåÎìú Ï∂îÏ∂ú Ïã§Ìå®:', cafe.name, error);
                                return { ...cafe, keywords: [] };
                            }
                        })
                    );
                    
                    cafesWithKeywords.push(...batchResults);
                    
                    // Î∞∞Ïπò Í∞Ñ ÏßÄÏó∞ (API Ï†úÌïú Í≥†Î†§, ÎßàÏßÄÎßâ Î∞∞ÏπòÎäî ÏßÄÏó∞ Î∂àÌïÑÏöî)
                    if (i + keywordBatchSize < cafesSearchable.length) {
                        await new Promise(resolve => setTimeout(resolve, 200)); // 200msÎ°ú Îã®Ï∂ï
                    }
                }

                // Î®ºÏ†Ä Î°úÎî© Ïï†ÎãàÎ©îÏù¥ÏÖò Ïà®Í∏∞Í∏∞ (Í≤∞Í≥º ÌëúÏãú Ï†ÑÏóê)
                loadingEl.style.display = 'none';

                // Ïπ¥Ìéò Î™©Î°ù ÌëúÏãú (Í≥µÌÜµ Ìï®Ïàò ÏÇ¨Ïö©)
                renderCafeList(cafesWithKeywords, resultsHeader, resultsSection, cafeList);

            } catch (error) {
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                
                // Îçî Î™ÖÌôïÌïú ÏóêÎü¨ Î©îÏãúÏßÄ
                let errorMessage = 'Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                
                if (error.message && error.message.includes('Failed to fetch')) {
                    errorMessage = 'ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§. Î°úÏª¨ ÌÖåÏä§Ìä∏Î•º ÏúÑÌï¥ÏÑúÎäî Vercel CLIÎ•º ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî.\n\nÌÑ∞ÎØ∏ÎÑêÏóêÏÑú Îã§Ïùå Î™ÖÎ†πÏñ¥Î•º Ïã§ÌñâÌïòÏÑ∏Ïöî:\n1. npm i -g vercel\n2. vercel dev';
                } else if (error.message && error.message.includes('Ï£ºÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§')) {
                    errorMessage = error.message;
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                // Ï§ÑÎ∞îÍøàÏùÑ HTMLÎ°ú Î≥ÄÌôò
                errorMessage = errorMessage.replace(/\n/g, '<br>');
                errorEl.innerHTML = errorMessage;
                console.error('Í≤ÄÏÉâ Ïò§Î•ò:', error);
            }
        }

        // ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ Í≤∞Í≥º Í∞ÄÏ†∏Ïò§Í∏∞ (Ï∏µ Ï†ïÎ≥¥, Í≤ÄÏÉâ Í∞ÄÎä• Ïó¨Î∂Ä, Ïπ¥ÌÖåÍ≥†Î¶¨ ÌôïÏù∏ ÌÜµÌï©)
        async function getNaverSearchInfo(cafe) {
            try {
                const address = cafe.displayAddress || cafe.roadAddress || cafe.address || '';
                
                // 1Ï∞® Í≤ÄÏÉâ: Îß§Ïû•Î™ÖÏπ≠ + Ï£ºÏÜå
                let searchQueryWithAddress = cafe.name;
                if (address) {
                    const addressParts = address.split(' ');
                    const simplifiedAddress = addressParts.slice(1).join(' ') || address;
                    searchQueryWithAddress = `${cafe.name} ${simplifiedAddress}`;
                }
                
                // ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ APIÎ°ú 1Ï∞® Í≤ÄÏÉâ Í≤∞Í≥º ÌôïÏù∏
                const searchResult = await callNaverAPI('local', {
                    query: searchQueryWithAddress,
                    display: 5,
                    sort: 'random'
                });
                
                let floorInfo = cafe.floor || '';
                let isSearchable = false;
                
                // Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏûàÍ≥†, Ï≤´ Î≤àÏß∏ Í≤∞Í≥ºÏùò Ïù¥Î¶ÑÏù¥ Ïπ¥Ìéò Ïù¥Î¶ÑÍ≥º Ïú†ÏÇ¨ÌïúÏßÄ ÌôïÏù∏
                if (searchResult.items && searchResult.items.length > 0) {
                    // Ïó¨Îü¨ Í≤∞Í≥º Ï§ëÏóêÏÑú Ïπ¥Ìéò Ïù¥Î¶ÑÍ≥º ÏùºÏπòÌïòÎäî Í≤ÉÏùÑ Ï∞æÍ∏∞
                    for (const item of searchResult.items) {
                        const resultTitle = (item.title || '').replace(/<[^>]*>/g, '');
                        const resultCategory = (item.category || '').toLowerCase();
                        const resultAddress = (item.address || '').replace(/<[^>]*>/g, '');
                        const resultRoadAddress = (item.roadAddress || '').replace(/<[^>]*>/g, '');
                        
                        // Ïπ¥Ìéò Ïù¥Î¶ÑÏù¥ Í≤ÄÏÉâ Í≤∞Í≥º Ï†úÎ™©Ïóê Ìè¨Ìï®ÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏
                        const nameMatches = resultTitle.includes(cafe.name) || cafe.name.includes(resultTitle.split(' ')[0]);
                        
                        // Ïπ¥ÌÖåÍ≥†Î¶¨Í∞Ä "Ïπ¥Ìéò"Ïù∏ÏßÄ ÌôïÏù∏
                        const isCafeCategory = resultCategory && (resultCategory.includes('Ïπ¥Ìéò') || resultCategory.includes('cafe') || resultCategory.startsWith('Ïπ¥Ìéò'));
                        
                        if (nameMatches && isCafeCategory) {
                            isSearchable = true;
                            // Ï∏µ Ï†ïÎ≥¥Í∞Ä ÏóÜÏúºÎ©¥ Ï∂îÏ∂ú
                            if (!floorInfo) {
                                const floorFromTitle = extractFloorInfo(resultTitle);
                                const floorFromAddress = extractFloorInfo(resultAddress + ' ' + resultRoadAddress);
                                floorInfo = floorFromTitle || floorFromAddress || '';
                            }
                            break; // ÏùºÏπòÌïòÎäî Í≤∞Í≥ºÎ•º Ï∞æÏïòÏúºÎ©¥ Ï§ëÎã®
                        }
                    }
                }
                
                // 1Ï∞® Í≤ÄÏÉâ Ïã§Ìå® Ïãú 2Ï∞® Í≤ÄÏÉâ: Îß§Ïû•Î™ÖÏπ≠Îßå
                if (!isSearchable) {
                    const searchResultNameOnly = await callNaverAPI('local', {
                        query: cafe.name,
                        display: 5,
                        sort: 'random'
                    });
                    
                    // Îß§Ïû•Î™ÖÏπ≠ÎßåÏúºÎ°ú Í≤ÄÏÉâ Í≤∞Í≥º ÌôïÏù∏
                    if (searchResultNameOnly.items && searchResultNameOnly.items.length > 0) {
                        for (const item of searchResultNameOnly.items) {
                            const resultTitle = (item.title || '').replace(/<[^>]*>/g, '');
                            const resultCategory = (item.category || '').toLowerCase();
                            const resultAddress = (item.address || '').replace(/<[^>]*>/g, '');
                            const resultRoadAddress = (item.roadAddress || '').replace(/<[^>]*>/g, '');
                            
                            // Ïπ¥Ìéò Ïù¥Î¶ÑÏù¥ Í≤ÄÏÉâ Í≤∞Í≥º Ï†úÎ™©Ïóê Ìè¨Ìï®ÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏
                            const nameMatches = resultTitle.includes(cafe.name) || cafe.name.includes(resultTitle.split(' ')[0]);
                            
                            // Ïπ¥ÌÖåÍ≥†Î¶¨Í∞Ä "Ïπ¥Ìéò"Ïù∏ÏßÄ ÌôïÏù∏
                            const isCafeCategory = resultCategory && (resultCategory.includes('Ïπ¥Ìéò') || resultCategory.includes('cafe') || resultCategory.startsWith('Ïπ¥Ìéò'));
                            
                            if (nameMatches && isCafeCategory) {
                                isSearchable = true;
                                // Ï∏µ Ï†ïÎ≥¥Í∞Ä ÏóÜÏúºÎ©¥ Ï∂îÏ∂ú
                                if (!floorInfo) {
                                    const floorFromTitle = extractFloorInfo(resultTitle);
                                    const floorFromAddress = extractFloorInfo(resultAddress + ' ' + resultRoadAddress);
                                    floorInfo = floorFromTitle || floorFromAddress || '';
                                }
                                break; // ÏùºÏπòÌïòÎäî Í≤∞Í≥ºÎ•º Ï∞æÏïòÏúºÎ©¥ Ï§ëÎã®
                            }
                        }
                    }
                }
                
                return { isSearchable, floorInfo };
            } catch (error) {
                console.warn('ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ Ï†ïÎ≥¥ Ï°∞Ìöå Ïã§Ìå®:', cafe.name, error);
                // ÏóêÎü¨ Î∞úÏÉù Ïãú Í≤ÄÏÉâ Í∞ÄÎä•Ìïú Í≤ÉÏúºÎ°ú Í∞ÑÏ£ºÌïòÏßÄ ÏïäÏùå
                return { isSearchable: false, floorInfo: cafe.floor || '' };
            }
        }

        // ÎÑ§Ïù¥Î≤ÑÎßµÏúºÎ°ú Ïù¥Îèô
        async function openNaverMap(cafe) {
            // Ïπ¥Ìéò Ïù¥Î¶ÑÍ≥º Ï£ºÏÜåÎ•º Ìï®Íªò ÏÇ¨Ïö©ÌïòÏó¨ Ï†ïÌôïÌïú ÏúÑÏπò Í≤ÄÏÉâ
            // ÎèÑÎ°úÎ™Ö Ï£ºÏÜå Ïö∞ÏÑ†, ÏóÜÏúºÎ©¥ ÏßÄÎ≤à Ï£ºÏÜå ÏÇ¨Ïö©
            const address = cafe.displayAddress || cafe.roadAddress || cafe.address || '';
            
            // 1Ï∞® Í≤ÄÏÉâ: Îß§Ïû•Î™ÖÏπ≠ + Ï£ºÏÜå
            let searchQueryWithAddress = cafe.name;
            if (address) {
                // Ï£ºÏÜåÏùò ÌïµÏã¨ Î∂ÄÎ∂ÑÎßå ÏÇ¨Ïö© (Ïòà: "ÏÑúÏö∏Ïãú Í∞ïÎÇ®Íµ¨ ÌÖåÌó§ÎûÄÎ°ú 152" -> "Í∞ïÎÇ®Íµ¨ ÌÖåÌó§ÎûÄÎ°ú 152")
                const addressParts = address.split(' ');
                // Ïãú/ÎèÑ Ï†úÍ±∞ÌïòÍ≥† Íµ¨/Îèô/Î°ú/Í∏∏ Ìè¨Ìï®
                const simplifiedAddress = addressParts.slice(1).join(' ') || address;
                searchQueryWithAddress = `${cafe.name} ${simplifiedAddress}`;
            }
            
            // ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ APIÎ°ú 1Ï∞® Í≤ÄÏÉâ Í≤∞Í≥º ÌôïÏù∏
            try {
                const searchResult = await callNaverAPI('local', {
                    query: searchQueryWithAddress,
                    display: 5,
                    sort: 'random'
                });
                
                // Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏûàÍ≥†, Ï≤´ Î≤àÏß∏ Í≤∞Í≥ºÏùò Ïù¥Î¶ÑÏù¥ Ïπ¥Ìéò Ïù¥Î¶ÑÍ≥º Ïú†ÏÇ¨ÌïúÏßÄ ÌôïÏù∏
                let searchSuccess = false;
                if (searchResult.items && searchResult.items.length > 0) {
                    const firstResult = searchResult.items[0];
                    const resultTitle = (firstResult.title || '').replace(/<[^>]*>/g, '');
                    // Ïπ¥Ìéò Ïù¥Î¶ÑÏù¥ Í≤ÄÏÉâ Í≤∞Í≥º Ï†úÎ™©Ïóê Ìè¨Ìï®ÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏
                    if (resultTitle.includes(cafe.name) || cafe.name.includes(resultTitle.split(' ')[0])) {
                        searchSuccess = true;
                    }
                }
                
                if (searchSuccess) {
                    // 1Ï∞® Í≤ÄÏÉâ ÏÑ±Í≥µ: Îß§Ïû•Î™ÖÏπ≠ + Ï£ºÏÜåÎ°ú ÎÑ§Ïù¥Î≤ÑÎßµ Ïó¥Í∏∞
                    const urlWithAddress = `https://map.naver.com/v5/search/${encodeURIComponent(searchQueryWithAddress)}`;
                    window.open(urlWithAddress, '_blank');
                } else {
                    // 1Ï∞® Í≤ÄÏÉâ Ïã§Ìå®: Îß§Ïû•Î™ÖÏπ≠ÎßåÏúºÎ°ú ÎÑ§Ïù¥Î≤ÑÎßµ Ïó¥Í∏∞
                    const urlNameOnly = `https://map.naver.com/v5/search/${encodeURIComponent(cafe.name)}`;
                    window.open(urlNameOnly, '_blank');
                }
            } catch (error) {
                // API Ìò∏Ï∂ú Ïã§Ìå® ÏãúÏóêÎèÑ 1Ï∞® Í≤ÄÏÉâ(Îß§Ïû•Î™ÖÏπ≠ + Ï£ºÏÜå) ÏãúÎèÑ
                console.warn('ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ API Ìò∏Ï∂ú Ïã§Ìå®, 1Ï∞® Í≤ÄÏÉâÏúºÎ°ú ÏßÑÌñâ:', error);
                const urlWithAddress = `https://map.naver.com/v5/search/${encodeURIComponent(searchQueryWithAddress)}`;
                window.open(urlWithAddress, '_blank');
            }
        }

        // Í≤∞Í≥º ÏóÜÏùå ÌëúÏãú
        function showNoResults() {
            const resultsSection = document.getElementById('resultsSection');
            const cafeList = document.getElementById('cafeList');
            
            resultsSection.style.display = 'block';
            cafeList.innerHTML = `
                <li class="no-results">
                    <div class="no-results-title">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</div>
                    <div class="no-results-text">500m Ïù¥ÎÇ¥Ïóê Ïπ¥ÌéòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.</div>
                </li>
            `;
        }

        // Ï£ºÏÜå ÌõÑÎ≥¥ Í≤ÄÏÉâ Î∞è Î¶¨Ïä§ÌåÖ
        async function searchAddressCandidates(query) {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const resultsSection = document.getElementById('resultsSection');
            const cafeList = document.getElementById('cafeList');
            const resultsHeader = document.getElementById('resultsHeader');

            // UI Ï¥àÍ∏∞Ìôî
            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            resultsSection.style.display = 'none';
            cafeList.innerHTML = '';

            try {
                // Ïπ¥Ïπ¥Ïò§ APIÎ°ú Ï£ºÏÜå Í≤ÄÏÉâ (Ï†ïÌôïÌïú Ï£ºÏÜå Í≤ÄÏÉâ) + ÌÇ§ÏõåÎìú Í≤ÄÏÉâ (Ïû•ÏÜåÎ™Ö)
                const [addressData, keywordData] = await Promise.all([
                    callKakaoAPI('address', {
                        query: query,
                        size: 10
                    }).catch(() => ({ documents: [] })),
                    callKakaoAPI('keyword', {
                        query: query,
                        size: 10
                    }).catch(() => ({ documents: [] }))
                ]);

                const suggestions = [];
                const seenAddresses = new Set();

                // Ïπ¥Ïπ¥Ïò§ Ï£ºÏÜå Í≤ÄÏÉâ Í≤∞Í≥º Ï≤òÎ¶¨ (ÏÑ±Îä• ÏµúÏ†ÅÌôî: for...of ÏÇ¨Ïö©)
                if (addressData.documents && addressData.documents.length > 0) {
                    for (const doc of addressData.documents) {
                        const roadAddr = doc.road_address?.address_name || '';
                        const addr = doc.address_name || '';
                        
                        if (roadAddr || addr) {
                            const key = roadAddr || addr;
                            if (!seenAddresses.has(key) && suggestions.length < 15) {
                                seenAddresses.add(key);
                                suggestions.push({
                                    main: roadAddr || addr, // ÎèÑÎ°úÎ™Ö Ï£ºÏÜå Ïö∞ÏÑ†
                                    sub: roadAddr ? addr : '', // ÎèÑÎ°úÎ™ÖÏù¥ ÏûàÏúºÎ©¥ ÏßÄÎ≤àÏùÑ ÏÑúÎ∏åÎ°ú
                                    fullAddress: roadAddr || addr,
                                    roadAddress: roadAddr || '',
                                    x: doc.x,
                                    y: doc.y
                                });
                            }
                        }
                    }
                }

                // Ïπ¥Ïπ¥Ïò§ ÌÇ§ÏõåÎìú Í≤ÄÏÉâ Í≤∞Í≥º Ï≤òÎ¶¨ (Ïó≠, Í±¥Î¨ºÎ™Ö Îì±) (ÏÑ±Îä• ÏµúÏ†ÅÌôî: for...of ÏÇ¨Ïö©)
                if (keywordData.documents && keywordData.documents.length > 0) {
                    for (const doc of keywordData.documents) {
                        const roadAddr = doc.road_address?.address_name || '';
                        const addr = doc.address_name || '';
                        const placeName = doc.place_name || '';
                        
                        if (placeName || roadAddr || addr) {
                            const displayName = placeName || roadAddr || addr;
                            const key = placeName + '|' + (roadAddr || addr);
                            
                            if (!seenAddresses.has(key) && suggestions.length < 15) {
                                seenAddresses.add(key);
                                suggestions.push({
                                    main: displayName,
                                    sub: roadAddr || addr, // ÎèÑÎ°úÎ™Ö Ï£ºÏÜå Ïö∞ÏÑ†
                                    fullAddress: roadAddr || addr,
                                    roadAddress: roadAddr || '',
                                    x: doc.x,
                                    y: doc.y
                                });
                            }
                        }
                    }
                }

                loadingEl.style.display = 'none';

                if (suggestions.length === 0) {
                    errorEl.style.display = 'block';
                    errorEl.textContent = 'Ï£ºÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Îã§Î•∏ Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.';
                    return;
                }

                // Ï£ºÏÜå ÌõÑÎ≥¥ Î¶¨Ïä§ÌåÖ ÌëúÏãú
                displayAddressCandidates(suggestions);
            } catch (error) {
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                errorEl.textContent = 'Ï£ºÏÜå Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                console.error('Ï£ºÏÜå Í≤ÄÏÉâ Ïò§Î•ò:', error);
            }
        }

        // Ï£ºÏÜå ÌõÑÎ≥¥ Î™©Î°ù ÌëúÏãú
        function displayAddressCandidates(suggestions) {
            const resultsSection = document.getElementById('resultsSection');
            const cafeList = document.getElementById('cafeList');
            const resultsHeader = document.getElementById('resultsHeader');

            resultsHeader.textContent = `${suggestions.length}Í∞úÏùò Ï£ºÏÜåÎ•º Ï∞æÏïòÏäµÎãàÎã§. ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.`;
            resultsSection.style.display = 'block';
            cafeList.innerHTML = '';

            // ÏÑ±Îä• ÏµúÏ†ÅÌôî: DocumentFragment ÏÇ¨Ïö©
            const fragment = document.createDocumentFragment();
            
            for (const suggestion of suggestions) {
                const li = document.createElement('li');
                li.className = 'address-item';
                
                // ÎèÑÎ°úÎ™Ö Ï£ºÏÜåÎ•º Î©îÏù∏ÏúºÎ°ú ÌëúÏãú
                const displayMain = suggestion.roadAddress || suggestion.main;
                const displaySub = suggestion.roadAddress ? suggestion.sub : '';
                
                // ÌÖçÏä§Ìä∏Î•º spanÏúºÎ°ú Í∞êÏã∏ÏÑú ÌÖçÏä§Ìä∏ ÏÑ†ÌÉù Î∞©ÏßÄ
                const mainEl = document.createElement('div');
                mainEl.className = 'address-main';
                const mainText = document.createTextNode(displayMain);
                mainEl.appendChild(mainText);
                
                li.appendChild(mainEl);
                
                if (displaySub) {
                    const subEl = document.createElement('div');
                    subEl.className = 'address-sub';
                    const subText = document.createTextNode(displaySub);
                    subEl.appendChild(subText);
                    li.appendChild(subEl);
                }
                
                // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏Îäî li ÏöîÏÜåÏóêÎßå Î∞îÏù∏Îî©
                li.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    // ÏûÖÎ†•Ï∞ΩÏóê ÏÑ†ÌÉùÌïú Ï£ºÏÜå ÏóÖÎç∞Ïù¥Ìä∏
                    const addressInput = document.getElementById('addressInput');
                    if (addressInput) {
                        addressInput.value = displayMain;
                    }
                    // ÏÑ†ÌÉùÌïú Ï£ºÏÜåÎ°ú Ïπ¥Ìéò Í≤ÄÏÉâ
                    searchCafesByCoordinates(suggestion.x, suggestion.y, displayMain);
                };
                
                // ÎßàÏö∞Ïä§ Ïù¥Î≤§Ìä∏Î°úÎèÑ Ìè¨Ïù∏ÌÑ∞ Ïª§ÏÑú Í∞ïÏ†ú
                li.onmouseenter = () => {
                    li.style.cursor = 'pointer';
                };
                
                fragment.appendChild(li);
            }
            
            // Ìïú Î≤àÏóê DOMÏóê Ï∂îÍ∞Ä (Î¶¨ÌîåÎ°úÏö∞ ÏµúÏÜåÌôî)
            cafeList.appendChild(fragment);
        }

        // Ï¢åÌëúÎ°ú Ïπ¥Ìéò Í≤ÄÏÉâ
        async function searchCafesByCoordinates(x, y, addressName) {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const resultsSection = document.getElementById('resultsSection');
            const cafeList = document.getElementById('cafeList');
            const resultsHeader = document.getElementById('resultsHeader');

            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            resultsSection.style.display = 'none';
            resultsHeader.textContent = ''; // Ï£ºÏÜå ÌõÑÎ≥¥ Î¨∏Íµ¨ Ï†úÍ±∞
            cafeList.innerHTML = '';

            try {
                const baseX = parseFloat(x);
                const baseY = parseFloat(y);

                // Ïπ¥Ïπ¥Ïò§ APIÎ°ú 500m Î∞òÍ≤Ω ÎÇ¥ Ïû•ÏÜå Í≤ÄÏÉâ (Î∞òÍ≤Ω Í≤ÄÏÉâ ÏßÄÏõê)
                const radius = 500;
                const categorySelect = document.getElementById('categorySelect');
                const selectedCategory = categorySelect.value; // ÏÑ†ÌÉùÎêú Ïπ¥ÌÖåÍ≥†Î¶¨
                const cafeData = await callKakaoAPI('keyword', {
                    query: selectedCategory,
                    x: baseX,
                    y: baseY,
                    radius: radius,
                    size: 15
                });

                if (!cafeData.documents || cafeData.documents.length === 0) {
                    loadingEl.style.display = 'none';
                    showNoResults();
                    return;
                }

                // Ïπ¥Ìéò Ïπ¥ÌÖåÍ≥†Î¶¨ ÌïÑÌÑ∞ÎßÅ, ÌîÑÎûúÏ∞®Ïù¥Ï¶à Ï†úÏô∏ Î∞è Í±∞Î¶¨ Í≥ÑÏÇ∞
                const cafes = cafeData.documents
                    .filter(doc => {
                        // Ïπ¥ÌÖåÍ≥†Î¶¨ ÌïÑÌÑ∞ÎßÅ: Ïπ¥ÌéòÎßå ÌóàÏö©
                        const categoryName = doc.category_name || '';
                        if (!isCafeCategory(categoryName)) {
                            return false;
                        }
                        // ÌîÑÎûúÏ∞®Ïù¥Ï¶à Ï†úÏô∏
                        const cafeName = doc.place_name || '';
                        return !isExcludedCafe(cafeName);
                    })
                    .map(doc => {
                        const cafeX = parseFloat(doc.x);
                        const cafeY = parseFloat(doc.y);
                        const distance = calculateDistance(baseY, baseX, cafeY, cafeX);
                        
                        // Ïπ¥Ïπ¥Ïò§ API ÏùëÎãµ Íµ¨Ï°∞
                        const roadAddr = (doc.road_address && doc.road_address.address_name) 
                            ? doc.road_address.address_name 
                            : '';
                        const addr = doc.address_name || '';
                        const placeName = doc.place_name || '';
                        
                        // Ïû•ÏÜåÎ™ÖÏóêÏÑú Ï∏µ Ï†ïÎ≥¥ Ï∂îÏ∂ú
                        const floorInfo = extractFloorInfo(placeName);
                        
                        return {
                            name: placeName,
                            address: addr, // ÏßÄÎ≤à Ï£ºÏÜå
                            roadAddress: roadAddr, // ÎèÑÎ°úÎ™Ö Ï£ºÏÜå
                            displayAddress: roadAddr || addr, // ÌëúÏãúÏö© (ÎèÑÎ°úÎ™Ö Ïö∞ÏÑ†)
                            floor: floorInfo, // Ï∏µ Ï†ïÎ≥¥
                            x: cafeX,
                            y: cafeY,
                            distance: distance,
                            categoryName: doc.category_name || '',
                            doc: doc // Ï£ºÏÜå Ïû¨Ï°∞ÌöåÏö©
                        };
                    })
                    .filter(cafe => cafe.distance <= 500)
                    .sort((a, b) => a.distance - b.distance);

                if (cafes.length === 0) {
                    loadingEl.style.display = 'none';
                    showNoResults();
                    return;
                }

                // ÎèÑÎ°úÎ™Ö Ï£ºÏÜåÍ∞Ä ÏóÜÎäî Ïπ¥ÌéòÎì§Ïùò Ï¢åÌëúÎ°ú Ï£ºÏÜå Ïû¨Ï°∞Ìöå
                // Î°úÎî© Ïï†ÎãàÎ©îÏù¥ÏÖòÏùÄ Ïù¥ ÏûëÏóÖÏù¥ ÏôÑÎ£åÎê† ÎïåÍπåÏßÄ Ïú†ÏßÄ
                const cafesWithAddress = await Promise.all(cafes.map(async (cafe) => {
                    // ÎèÑÎ°úÎ™Ö Ï£ºÏÜåÍ∞Ä ÏóÜÏúºÎ©¥ Ï¢åÌëúÎ°ú Ï£ºÏÜå Ï°∞Ìöå
                    if (!cafe.roadAddress && cafe.x && cafe.y) {
                        try {
                            const coordData = await callKakaoAPI('coord2address', {
                                x: cafe.x,
                                y: cafe.y
                            });
                            
                            if (coordData.documents && coordData.documents.length > 0) {
                                const doc = coordData.documents[0];
                                const roadAddr = (doc.road_address && doc.road_address.address_name) 
                                    ? doc.road_address.address_name 
                                    : '';
                                if (roadAddr) {
                                    cafe.roadAddress = roadAddr;
                                    cafe.displayAddress = roadAddr;
                                }
                            }
                        } catch (error) {
                            console.warn('Ï£ºÏÜå Ïû¨Ï°∞Ìöå Ïã§Ìå®:', cafe.name, error);
                        }
                    }
                    
                    return cafe;
                }));

                // ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ Ï†ïÎ≥¥ Ï°∞Ìöå Î∞è ÌïÑÌÑ∞ÎßÅ (Ï∏µ Ï†ïÎ≥¥ + Í≤ÄÏÉâ Í∞ÄÎä• Ïó¨Î∂Ä + Ïπ¥ÌÖåÍ≥†Î¶¨ ÌôïÏù∏ ÌÜµÌï©)
                // Î∞∞Ïπò Ï≤òÎ¶¨Î°ú ÏÑ±Îä• Í∞úÏÑ† (5Í∞úÏî© Î¨∂Ïñ¥ÏÑú Î≥ëÎ†¨ Ï≤òÎ¶¨)
                const cafesSearchable = [];
                const batchSize = 5;
                
                for (let i = 0; i < cafesWithAddress.length; i += batchSize) {
                    const batch = cafesWithAddress.slice(i, i + batchSize);
                    
                    // Î∞∞Ïπò ÎÇ¥ÏóêÏÑú Î≥ëÎ†¨ Ï≤òÎ¶¨
                    const batchResults = await Promise.all(
                        batch.map(async (cafe) => {
                            try {
                                const { isSearchable, floorInfo } = await getNaverSearchInfo(cafe);
                                
                                if (isSearchable) {
                                    // Ï∏µ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                                    if (floorInfo) {
                                        cafe.floor = floorInfo;
                                    }
                                    console.log(`ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ Í∞ÄÎä• Î∞è Ïπ¥ÌÖåÍ≥†Î¶¨ "Ïπ¥Ìéò" ÌôïÏù∏ ÏôÑÎ£å [${cafe.name}]`);
                                    return cafe;
                                } else {
                                    console.log(`ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ Î∂àÍ∞ÄÎä• ÎòêÎäî Ïπ¥ÌÖåÍ≥†Î¶¨Í∞Ä "Ïπ¥Ìéò"Í∞Ä ÏïÑÎãò - Î¶¨Ïä§ÌåÖ Ï†úÏô∏ [${cafe.name}]`);
                                    return null;
                                }
                            } catch (error) {
                                console.warn('ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ Ï†ïÎ≥¥ Ï°∞Ìöå Ïã§Ìå®:', cafe.name, error);
                                console.log(`ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ ÌôïÏù∏ Ïã§Ìå®Î°ú Ïù∏Ìïú Î¶¨Ïä§ÌåÖ Ï†úÏô∏ [${cafe.name}]`);
                                return null;
                            }
                        })
                    );
                    
                    // nullÏù¥ ÏïÑÎãå Í≤∞Í≥ºÎßå Ï∂îÍ∞Ä (ÏÑ±Îä• ÏµúÏ†ÅÌôî: for...of ÏÇ¨Ïö©)
                    for (const result of batchResults) {
                        if (result) {
                            cafesSearchable.push(result);
                        }
                    }
                    
                    // Î∞∞Ïπò Í∞Ñ ÏßÄÏó∞ (API Ï†úÌïú Í≥†Î†§, ÎßàÏßÄÎßâ Î∞∞ÏπòÎäî ÏßÄÏó∞ Î∂àÌïÑÏöî)
                    if (i + batchSize < cafesWithAddress.length) {
                        await new Promise(resolve => setTimeout(resolve, 200)); // 200msÎ°ú Îã®Ï∂ï
                    }
                }

                // Í∞Å Ïπ¥ÌéòÏóê ÎåÄÌï¥ ÌÇ§ÏõåÎìú Ï∂îÏ∂ú (Î∞∞Ïπò Ï≤òÎ¶¨Î°ú ÏÑ±Îä• Í∞úÏÑ†)
                const cafesWithKeywords = [];
                const keywordBatchSize = 5;
                
                for (let i = 0; i < cafesSearchable.length; i += keywordBatchSize) {
                    const batch = cafesSearchable.slice(i, i + keywordBatchSize);
                    
                    // Î∞∞Ïπò ÎÇ¥ÏóêÏÑú Î≥ëÎ†¨ Ï≤òÎ¶¨
                    const batchResults = await Promise.all(
                        batch.map(async (cafe) => {
                            try {
                                const keywords = await extractCafeKeywords(
                                    cafe.name,
                                    cafe.displayAddress || cafe.roadAddress || cafe.address
                                );
                                console.log(`ÌÇ§ÏõåÎìú Ï∂îÏ∂ú ÏôÑÎ£å [${cafe.name}]:`, keywords);
                                return { ...cafe, keywords: keywords || [] };
                            } catch (error) {
                                console.error('ÌÇ§ÏõåÎìú Ï∂îÏ∂ú Ïã§Ìå®:', cafe.name, error);
                                return { ...cafe, keywords: [] };
                            }
                        })
                    );
                    
                    cafesWithKeywords.push(...batchResults);
                    
                    // Î∞∞Ïπò Í∞Ñ ÏßÄÏó∞ (API Ï†úÌïú Í≥†Î†§, ÎßàÏßÄÎßâ Î∞∞ÏπòÎäî ÏßÄÏó∞ Î∂àÌïÑÏöî)
                    if (i + keywordBatchSize < cafesSearchable.length) {
                        await new Promise(resolve => setTimeout(resolve, 200)); // 200msÎ°ú Îã®Ï∂ï
                    }
                }

                // Î®ºÏ†Ä Î°úÎî© Ïï†ÎãàÎ©îÏù¥ÏÖò Ïà®Í∏∞Í∏∞ (Í≤∞Í≥º ÌëúÏãú Ï†ÑÏóê)
                loadingEl.style.display = 'none';

                // Ïπ¥Ìéò Î™©Î°ù ÌëúÏãú (Í≥µÌÜµ Ìï®Ïàò ÏÇ¨Ïö©)
                renderCafeList(cafesWithKeywords, resultsHeader, resultsSection, cafeList);

            } catch (error) {
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                
                let errorMessage = 'Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                if (error.message) {
                    errorMessage = error.message.replace(/\n/g, '<br>');
                }
                
                errorEl.innerHTML = errorMessage;
                console.error('Í≤ÄÏÉâ Ïò§Î•ò:', error);
            }
        }

        // ÏûÖÎ†• ÌïÑÎìú Ïù¥Î≤§Ìä∏
        const addressInput = document.getElementById('addressInput');

        // ÌòÑÏúÑÏπò Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
        document.getElementById('locationButton').addEventListener('click', async () => {
            const locationButton = document.getElementById('locationButton');
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const resultsSection = document.getElementById('resultsSection');
            const cafeList = document.getElementById('cafeList');
            const resultsHeader = document.getElementById('resultsHeader');
            
            // Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            locationButton.disabled = true;
            locationButton.textContent = '‚è≥';
            
            // UI Ï¥àÍ∏∞Ìôî - Í∏∞Ï°¥ Ïπ¥Ìéò Î™©Î°ù Ï†úÍ±∞
            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            resultsSection.style.display = 'none';
            cafeList.innerHTML = '';
            resultsHeader.textContent = '';
            
            try {
                // Geolocation APIÎ°ú ÌòÑÏû¨ ÏúÑÏπò Í∞ÄÏ†∏Ïò§Í∏∞
                if (!navigator.geolocation) {
                    throw new Error('ÌòÑÏû¨ Î∏åÎùºÏö∞Ï†ÄÏóêÏÑú ÏúÑÏπò ÏÑúÎπÑÏä§Î•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
                }
                
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });
                
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;
                
                // Ï¢åÌëúÎ•º Ï£ºÏÜåÎ°ú Î≥ÄÌôò
                let address = '';
                try {
                    const coordData = await callKakaoAPI('coord2address', {
                        x: longitude,
                        y: latitude
                    });
                    
                    if (coordData.documents && coordData.documents.length > 0) {
                        const doc = coordData.documents[0];
                        const roadAddr = (doc.road_address && doc.road_address.address_name) 
                            ? doc.road_address.address_name 
                            : '';
                        const addr = doc.address_name || '';
                        address = roadAddr || addr;
                    }
                    
                    // Ï£ºÏÜåÍ∞Ä ÏóÜÏúºÎ©¥ Ï¢åÌëú Î¨∏ÏûêÏó¥ ÏÇ¨Ïö©
                    if (!address) {
                        address = `ÏúÑÎèÑ ${latitude.toFixed(6)}, Í≤ΩÎèÑ ${longitude.toFixed(6)}`;
                    }
                } catch (error) {
                    console.warn('Ï£ºÏÜå Î≥ÄÌôò Ïã§Ìå®, Ï¢åÌëúÎ°ú ÏßÅÏ†ë Í≤ÄÏÉâ:', error);
                    // Ï£ºÏÜå Î≥ÄÌôò Ïã§Ìå® Ïãú Ï¢åÌëú Î¨∏ÏûêÏó¥ ÏÇ¨Ïö©
                    address = `ÏúÑÎèÑ ${latitude.toFixed(6)}, Í≤ΩÎèÑ ${longitude.toFixed(6)}`;
                }
                
                // Ìï≠ÏÉÅ ÏûÖÎ†•Ï∞ΩÏóê Ï£ºÏÜå ÌëúÏãú
                addressInput.value = address;
                
                // Ìï¥Îãπ Ï£ºÏÜåÎ°ú Ïπ¥Ìéò Í≤ÄÏÉâ
                await searchCafesByCoordinates(longitude, latitude, address);
                
            } catch (error) {
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                
                let errorMessage = 'ÌòÑÏû¨ ÏúÑÏπòÎ•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.';
                if (error.code === 1) {
                    errorMessage = 'ÏúÑÏπò Í∂åÌïúÏù¥ Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§. Î∏åÎùºÏö∞Ï†Ä ÏÑ§Ï†ïÏóêÏÑú ÏúÑÏπò Í∂åÌïúÏùÑ ÌóàÏö©Ìï¥Ï£ºÏÑ∏Ïöî.';
                } else if (error.code === 2) {
                    errorMessage = 'ÏúÑÏπòÎ•º ÌôïÏù∏Ìï† Ïàò ÏóÜÏäµÎãàÎã§. GPS Ïã†Ìò∏Î•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.';
                } else if (error.code === 3) {
                    errorMessage = 'ÏúÑÏπò ÌôïÏù∏ ÏãúÍ∞ÑÏù¥ Ï¥àÍ≥ºÎêòÏóàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                errorEl.textContent = errorMessage;
                console.error('ÏúÑÏπò Í∞ÄÏ†∏Ïò§Í∏∞ Ïò§Î•ò:', error);
            } finally {
                // Î≤ÑÌäº ÌôúÏÑ±Ìôî
                locationButton.disabled = false;
                locationButton.textContent = 'üìç';
            }
        });

        // Í≤ÄÏÉâ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
        document.getElementById('searchButton').addEventListener('click', () => {
            const address = addressInput.value.trim();
            if (address) {
                // Ï£ºÏÜå ÌõÑÎ≥¥ Í≤ÄÏÉâ Î∞è Î¶¨Ïä§ÌåÖ
                searchAddressCandidates(address);
            }
        });

        // Enter ÌÇ§ Ïù¥Î≤§Ìä∏
        addressInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const address = addressInput.value.trim();
                if (address) {
                    // Ï£ºÏÜå ÌõÑÎ≥¥ Í≤ÄÏÉâ Î∞è Î¶¨Ïä§ÌåÖ
                    searchAddressCandidates(address);
                }
            }
        });

        // Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏
        const categorySelect = document.getElementById('categorySelect');
        categorySelect.addEventListener('change', (e) => {
            const selectedCategory = e.target.value;
            if (selectedCategory === 'ÎßàÎùºÌÉï') {
                // ÎßàÎùºÌÉï ÏÑ†ÌÉù Ïãú index2.htmlÎ°ú Ïù¥Îèô
                window.location.href = 'index2.html';
            } else if (selectedCategory === 'Îπµ') {
                // Îπµ ÏÑ†ÌÉù Ïãú index3.htmlÎ°ú Ïù¥Îèô
                window.location.href = 'index3.html';
            }
            // Ïπ¥Ìéò ÏÑ†ÌÉù ÏãúÏóêÎäî ÌòÑÏû¨ ÌéòÏù¥ÏßÄ Ïú†ÏßÄ (Í∏∞Î≥∏ ÎèôÏûë)
        });
    </script>
</body>
</html>
