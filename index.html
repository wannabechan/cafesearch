<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>cafÃ© explorer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #ffffff;
            color: #202124;
            line-height: 1.6;
            min-height: 100vh;
        }

        .address-item::selection,
        .address-item *::selection {
            background: transparent;
        }

        .address-item::-moz-selection,
        .address-item *::-moz-selection {
            background: transparent;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        h1 {
            text-align: center;
            font-size: 48px;
            font-weight: 300;
            color: #202124;
            margin-bottom: 50px;
            letter-spacing: -0.5px;
        }

        .search-section {
            margin-bottom: 40px;
        }

        .search-box {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 600px;
            margin: 0 auto;
        }

        .search-input {
            width: 100%;
            padding: 16px 20px;
            font-size: 16px;
            border: 1px solid #dfe1e5;
            border-radius: 24px;
            outline: none;
            transition: all 0.2s;
        }

        .search-buttons {
            display: flex;
            gap: 12px;
            width: 100%;
        }

        .search-input:focus {
            border-color: #4285f4;
            box-shadow: 0 2px 5px 1px rgba(64, 60, 67, 0.16);
        }

        .search-button {
            flex: 1;
            padding: 16px 32px;
            font-size: 16px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
        }

        .search-button:hover {
            background-color: #357ae8;
        }

        .search-button:active {
            background-color: #2a5fcc;
        }

        .location-button {
            flex: 0 0 auto;
            padding: 16px 20px;
            font-size: 20px;
            background-color: #34a853;
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .location-button:hover {
            background-color: #2d8f47;
        }

        .location-button:active {
            background-color: #267d3e;
        }

        .location-button:disabled {
            background-color: #c0c0c0;
            cursor: not-allowed;
        }

        .results-section {
            margin-top: 40px;
        }

        .results-header {
            font-size: 14px;
            color: #5f6368;
            margin-bottom: 20px;
            text-align: center;
        }

        .cafe-list {
            list-style: none;
        }

        .cafe-item {
            padding: 20px;
            border-bottom: 1px solid #f1f3f4;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .cafe-item:hover {
            background-color: #f8f9fa;
        }

        .cafe-item:last-child {
            border-bottom: none;
        }

        .cafe-name {
            font-size: 18px;
            font-weight: 500;
            color: #1a73e8;
            margin-bottom: 8px;
        }

        .cafe-name:hover {
            text-decoration: underline;
        }

        .cafe-address {
            font-size: 14px;
            color: #5f6368;
            margin-bottom: 6px;
        }

        .cafe-distance {
            font-size: 13px;
            color: #80868b;
        }

        .cafe-keywords {
            display: flex;
            gap: 6px;
            margin-left: 12px;
            flex-wrap: wrap;
        }

        .cafe-keyword {
            font-size: 11px;
            color: #5f6368;
            background-color: #f1f3f4;
            padding: 3px 8px;
            border-radius: 12px;
            white-space: nowrap;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #5f6368;
            font-size: 14px;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f1f3f4;
            border-top-color: #4285f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #ea4335;
            font-size: 14px;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #5f6368;
        }

        .no-results-title {
            font-size: 18px;
            margin-bottom: 8px;
            color: #202124;
        }

        .no-results-text {
            font-size: 14px;
        }

        .address-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dfe1e5;
            border-radius: 12px;
            margin-top: 8px;
        .address-item {
            padding: 20px;
            border-bottom: 1px solid #f1f3f4;
            transition: background-color 0.2s;
            cursor: pointer !important;
            user-select: none !important;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            -webkit-touch-callout: none !important;
            -webkit-tap-highlight-color: transparent;
            background-color: #ffffff;
            display: block;
            width: 100%;
            text-align: left;
            border: none;
            outline: none;
        }

        .address-item:hover {
            background-color: #f8f9fa;
            cursor: pointer !important;
        }

        .address-item:active {
            background-color: #f1f3f4;
        }

        .address-item:last-child {
            border-bottom: none;
        }

        .address-item * {
            cursor: pointer !important;
            user-select: none !important;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            pointer-events: none !important;
            -webkit-touch-callout: none !important;
        }

        .address-main {
            font-size: 16px;
            color: #202124;
            margin-bottom: 4px;
            font-weight: 500;
            display: block;
        }

        .address-sub {
            font-size: 14px;
            color: #5f6368;
            display: block;
        }

        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media screen and (max-width: 768px) {
            .container {
                padding: 20px 16px;
            }

            h1 {
                font-size: 32px;
                margin-bottom: 30px;
            }

            .search-box {
                gap: 10px;
                max-width: 100%;
            }

            .search-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .search-input {
                padding: 14px 18px;
                font-size: 16px; /* iOS ì¤Œ ë°©ì§€ */
                border-radius: 20px;
            }

            .search-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .search-button {
                padding: 14px 24px;
                font-size: 16px;
                border-radius: 20px;
                width: 100%;
            }

            .location-button {
                padding: 14px 18px;
                font-size: 20px;
                border-radius: 20px;
                width: 100%;
            }

            .cafe-item {
                padding: 16px;
            }

            .cafe-name {
                font-size: 16px;
                margin-bottom: 6px;
            }

            .cafe-address {
                font-size: 13px;
                margin-bottom: 4px;
                line-height: 1.5;
            }

            .cafe-distance {
                font-size: 12px;
            }

            .cafe-keywords {
                margin-left: 0;
                margin-top: 8px;
                gap: 4px;
            }

            .cafe-keyword {
                font-size: 10px;
                padding: 2px 6px;
            }

            .results-header {
                font-size: 13px;
                margin-bottom: 16px;
            }

            .address-item {
                padding: 14px 16px;
            }

            .address-main {
                font-size: 15px;
            }

            .address-sub {
                font-size: 13px;
            }

            .loading {
                padding: 30px 20px;
                font-size: 13px;
            }

            .loading-container {
                padding: 40px 16px;
            }

            .error {
                padding: 30px 20px;
                font-size: 13px;
            }

            .no-results {
                padding: 40px 16px;
            }

            .no-results-title {
                font-size: 16px;
            }
        }

        /* ì‘ì€ ëª¨ë°”ì¼ í™”ë©´ (iPhone SE ë“±) */
        @media screen and (max-width: 375px) {
            .container {
                padding: 16px 12px;
            }

            h1 {
                font-size: 28px;
                margin-bottom: 24px;
            }

            .search-input {
                padding: 12px 16px;
            }

            .search-button {
                padding: 12px 20px;
            }

            .location-button {
                padding: 12px 16px;
            }

            .cafe-item {
                padding: 14px;
            }

            .cafe-name {
                font-size: 15px;
            }

            .cafe-address {
                font-size: 12px;
            }
        }

        /* ê°€ë¡œ ëª¨ë“œ ìµœì í™” */
        @media screen and (max-width: 768px) and (orientation: landscape) {
            .container {
                padding: 16px 20px;
            }

            h1 {
                font-size: 28px;
                margin-bottom: 20px;
            }

            .search-buttons {
                flex-direction: row;
                gap: 8px;
            }

            .search-button {
                flex: 1;
            }

            .location-button {
                flex: 0 0 auto;
                min-width: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>cafÃ© explorer</h1>
        
        <div class="search-section">
            <div class="search-box">
                <input 
                    type="text" 
                    id="addressInput" 
                    class="search-input" 
                    placeholder="ì£¼ì†Œ ì…ë ¥"
                    autocomplete="off"
                >
                <div class="search-buttons">
                    <button id="searchButton" class="search-button">ê²€ìƒ‰</button>
                    <button id="locationButton" class="location-button" title="í˜„ìœ„ì¹˜">ğŸ“</button>
                </div>
            </div>
        </div>

        <div class="results-section" id="resultsSection" style="display: none;">
            <div class="results-header" id="resultsHeader"></div>
            <ul class="cafe-list" id="cafeList"></ul>
        </div>

        <div class="loading" id="loading" style="display: none;">
            <div class="loading-container">
                <div class="spinner"></div>
                <div>ê²€ìƒ‰ ì¤‘...</div>
            </div>
        </div>
        <div class="error" id="error" style="display: none;"></div>
    </div>

    <script>
        // ì œì™¸í•  í”„ëœì°¨ì´ì¦ˆ ì¹´í˜ ëª©ë¡
        const EXCLUDED_CAFES = ['ìŠ¤íƒ€ë²…ìŠ¤', 'ì´ë””ì•¼', 'ì»´í¬ì¦ˆ', 'ë©”ê°€', 'MGC', 'ì¹´í˜ë² ë„¤', 'íˆ¬ì¸', 'ë§¤ë¨¸ë“œ', 'ì»¤í”¼ì•³ì›ìŠ¤', 'ë°±ì–µì»¤í”¼', 'í• ë¦¬ìŠ¤', 'ì»¤í”¼ë¹ˆ', 'ë¹½ë‹¤ë°©', 'ë°©íƒˆì¶œ', 'ìš”ê±°íŠ¸'];

        // API ì—”ë“œí¬ì¸íŠ¸ (ì„œë²„ë¦¬ìŠ¤ í•¨ìˆ˜ ì‚¬ìš©)
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:3000/api'
            : '/api';

        // ë„¤ì´ë²„ ì¢Œí‘œê³„ë¥¼ WGS84ë¡œ ë³€í™˜
        function naverToWGS84(mapx, mapy) {
            // ë„¤ì´ë²„ ì¢Œí‘œê³„ (EPSG:5179) -> WGS84 (EPSG:4326)
            // ë„¤ì´ë²„ ê²€ìƒ‰ APIëŠ” ì´ë¯¸ WGS84 ì¢Œí‘œë¥¼ ì œê³µí•˜ë¯€ë¡œ ë³€í™˜ ë¶ˆí•„ìš”
            // í•˜ì§€ë§Œ mapx, mapyê°€ ë„¤ì´ë²„ ì¢Œí‘œê³„ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë³€í™˜
            const x = parseFloat(mapx);
            const y = parseFloat(mapy);
            
            // ë„¤ì´ë²„ ì¢Œí‘œë¥¼ WGS84ë¡œ ë³€í™˜ (ê°„ë‹¨í•œ ì„ í˜• ë³€í™˜)
            // ë„¤ì´ë²„ ì¢Œí‘œê³„ëŠ” í•œêµ­ ì „ìš© ì¢Œí‘œê³„
            // ëŒ€ëµì ì¸ ë³€í™˜: ë„¤ì´ë²„ ì¢Œí‘œë¥¼ 10000000ìœ¼ë¡œ ë‚˜ëˆ„ê³  ê¸°ì¤€ì  ë”í•˜ê¸°
            const lon = (x / 10000000) + 126.9784;
            const lat = (y / 10000000) + 37.5665;
            
            return { lon, lat };
        }

        // ì¹´ì¹´ì˜¤ API í˜¸ì¶œ (ì„œë²„ë¦¬ìŠ¤ í•¨ìˆ˜ë¥¼ í†µí•´) - ì£¼ì†Œ ê²€ìƒ‰ìš©
        async function callKakaoAPI(endpoint, params) {
            try {
                const queryParams = new URLSearchParams({
                    endpoint: endpoint,
                    ...params
                });
                
                const response = await fetch(`${API_BASE_URL}/kakao?${queryParams}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'API í˜¸ì¶œ ì‹¤íŒ¨');
                }

                return await response.json();
            } catch (error) {
                console.error('Kakao API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                throw error;
            }
        }

        // ë„¤ì´ë²„ API í˜¸ì¶œ (ì„œë²„ë¦¬ìŠ¤ í•¨ìˆ˜ë¥¼ í†µí•´) - ì¹´í˜ ê²€ìƒ‰ìš©
        async function callNaverAPI(endpoint, params) {
            try {
                const queryParams = new URLSearchParams({
                    endpoint: endpoint,
                    ...params
                });
                
                const response = await fetch(`${API_BASE_URL}/naver?${queryParams}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'API í˜¸ì¶œ ì‹¤íŒ¨');
                }

                return await response.json();
            } catch (error) {
                console.error('Naver API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                throw error;
            }
        }

        // ë‘ ì¢Œí‘œ ê°„ì˜ ê±°ë¦¬ ê³„ì‚° (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // ì§€êµ¬ ë°˜ì§€ë¦„ (ë¯¸í„°)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // ë¯¸í„° ë‹¨ìœ„ ê±°ë¦¬
        }

        // í”„ëœì°¨ì´ì¦ˆ ì¹´í˜ì¸ì§€ í™•ì¸
        function isExcludedCafe(cafeName) {
            if (!cafeName) return false;
            const name = cafeName.toLowerCase();
            return EXCLUDED_CAFES.some(excluded => name.includes(excluded.toLowerCase()));
        }

        // ì¹´í˜ ì¹´í…Œê³ ë¦¬ì¸ì§€ í™•ì¸ (ë¸ŒëŸ°ì¹˜, ë ˆìŠ¤í† ë‘, ìŒì‹ì , ìˆ ì§‘ ì œì™¸)
        function isCafeCategory(categoryName) {
            // ì¹´í…Œê³ ë¦¬ ì •ë³´ê°€ ì—†ìœ¼ë©´ í—ˆìš© (ê¸°ë³¸ì ìœ¼ë¡œ ì¹´í˜ ê²€ìƒ‰ ê²°ê³¼ì´ë¯€ë¡œ)
            if (!categoryName) return true;
            
            const category = categoryName.toLowerCase();
            
            // ì œì™¸í•  ì¹´í…Œê³ ë¦¬ë§Œ ì²´í¬ (ëª…í™•íˆ ì œì™¸í•  ê²ƒë“¤ë§Œ)
            const excludedKeywords = ['ë¸ŒëŸ°ì¹˜', 'brunch', 'ë ˆìŠ¤í† ë‘', 'restaurant', 'ìˆ ì§‘', 'ë°”', 'bar', 'íœì…˜', 'í˜¸í…”', 'hotel', 'ì¹˜í‚¨', 'chicken', 'í”¼ì', 'pizza', 'í•œì‹', 'ì¤‘ì‹', 'ì¼ì‹', 'ì–‘ì‹'];
            const isExcluded = excludedKeywords.some(keyword => category.includes(keyword));
            
            // ì œì™¸ í‚¤ì›Œë“œê°€ ì—†ìœ¼ë©´ í—ˆìš© (ì¹´í˜ ê²€ìƒ‰ ê²°ê³¼ì´ë¯€ë¡œ ëŒ€ë¶€ë¶„ ì¹´í˜ì¼ ê²ƒ)
            return !isExcluded;
        }

        // ì¥ì†Œëª…ì—ì„œ ì¸µ ì •ë³´ ì¶”ì¶œ
        function extractFloorInfo(placeName) {
            if (!placeName) return '';
            
            // ì¸µ ì •ë³´ íŒ¨í„´ë“¤
            const floorPatterns = [
                /(\d+)ì¸µ/g,           // "2ì¸µ", "3ì¸µ"
                /(\d+)F/g,            // "2F", "3F"
                /(\d+)f/g,            // "2f", "3f"
                /B(\d+)/g,            // "B1", "B2" (ì§€í•˜)
                /ì§€í•˜\s*(\d+)/g,      // "ì§€í•˜ 1", "ì§€í•˜ 2"
                /\((\d+)ì¸µ\)/g,       // "(2ì¸µ)"
                /\((\d+)F\)/g,        // "(2F)"
                /\[(\d+)ì¸µ\]/g,       // "[2ì¸µ]"
                /(\d+)\.(\d+)ì¸µ/g     // "2.5ì¸µ" ê°™ì€ ê²½ìš°ëŠ” ì œì™¸í•˜ê³  ì •ìˆ˜ë§Œ
            ];
            
            let floorInfo = '';
            let foundFloor = null;
            
            // ê° íŒ¨í„´ìœ¼ë¡œ ì¸µ ì •ë³´ ì°¾ê¸°
            for (const pattern of floorPatterns) {
                const matches = placeName.match(pattern);
                if (matches && matches.length > 0) {
                    // ë§ˆì§€ë§‰ ë§¤ì¹­ëœ ì¸µ ì •ë³´ ì‚¬ìš© (ê°€ì¥ ì •í™•í•œ ê²ƒ)
                    const lastMatch = matches[matches.length - 1];
                    const numberMatch = lastMatch.match(/\d+/);
                    if (numberMatch) {
                        foundFloor = numberMatch[0];
                        
                        // ì§€í•˜ ì—¬ë¶€ í™•ì¸
                        if (lastMatch.includes('B') || lastMatch.includes('ì§€í•˜')) {
                            floorInfo = `B${foundFloor}`;
                        } else {
                            floorInfo = `${foundFloor}ì¸µ`;
                        }
                        break;
                    }
                }
            }
            
            return floorInfo;
        }

        // ì¹´í˜ íŠ¹ì§• í‚¤ì›Œë“œ ì¶”ì¶œ (ë„¤ì´ë²„ ë¸”ë¡œê·¸ ë¦¬ë·°ì—ì„œ ì‹¤ì œ í…ìŠ¤íŠ¸ ë¶„ì„, ìµœì†Œ 1ê°œ ~ ìµœëŒ€ 3ê°œ)
        async function extractCafeKeywords(cafeName, cafeAddress) {
            try {
                // ì¹´í˜ ì´ë¦„ê³¼ ì£¼ì†Œë¥¼ ì¡°í•©í•˜ì—¬ ê²€ìƒ‰ì–´ ìƒì„±
                const searchQuery = cafeAddress 
                    ? `${cafeName} ${cafeAddress.split(' ').slice(0, 3).join(' ')}`
                    : cafeName;
                
                // ë„¤ì´ë²„ ë¸”ë¡œê·¸ ê²€ìƒ‰ API í˜¸ì¶œ
                const blogData = await callNaverAPI('blog', {
                    query: searchQuery,
                    display: 30, // ë” ë§ì€ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ê²€ìƒ‰
                    sort: 'sim'  // ê´€ë ¨ë„ìˆœ ì •ë ¬
                });

                if (!blogData.items || blogData.items.length === 0) {
                    // ë¸”ë¡œê·¸ ê²€ìƒ‰ ì‹¤íŒ¨ ì‹œ ì¹´í˜ ì´ë¦„ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ ì‹œë„
                    console.warn('ë¸”ë¡œê·¸ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ, ì¹´í˜ ì´ë¦„ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ ì‹œë„:', cafeName);
                    return extractKeywordsFromName(cafeName);
                }

                // ëª¨ë“  ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ì˜ ì œëª©ê³¼ ì„¤ëª…ì„ í•©ì³ì„œ í…ìŠ¤íŠ¸ ë¶„ì„
                const allText = blogData.items
                    .map(item => {
                        // HTML íƒœê·¸ ì œê±°
                        const title = (item.title || '').replace(/<[^>]*>/g, ' ');
                        const description = (item.description || '').replace(/<[^>]*>/g, ' ');
                        return `${title} ${description}`;
                    })
                    .join(' ');

                // ë©”ë‰´ ê´€ë ¨ í‚¤ì›Œë“œ íŒ¨í„´ (ê°„ë‹¨í•˜ê³  ìœ ì—°í•œ íŒ¨í„´ìœ¼ë¡œ ë³€ê²½)
                // ë‹¨ì–´ ê²½ê³„ ì—†ì´ ë‹¨ìˆœí•˜ê²Œ ë§¤ì¹­
                const menuPatterns = [
                    // ë””ì €íŠ¸/ì¼€ì´í¬ ê´€ë ¨
                    { pattern: /ì¼€ì´í¬/gi, keyword: 'ì¼€ì´í¬' },
                    { pattern: /ë§ˆì¹´ë¡±/gi, keyword: 'ë§ˆì¹´ë¡±' },
                    { pattern: /ë¸Œë¼ìš°ë‹ˆ/gi, keyword: 'ë¸Œë¼ìš°ë‹ˆ' },
                    { pattern: /ì¿ í‚¤/gi, keyword: 'ì¿ í‚¤' },
                    { pattern: /íŒŒìš´ë“œì¼€ì´í¬|íŒŒìš´ë“œ/gi, keyword: 'íŒŒìš´ë“œì¼€ì´í¬' },
                    { pattern: /ë””ì €íŠ¸/gi, keyword: 'ë””ì €íŠ¸' },
                    { pattern: /íƒ€ë¥´íŠ¸/gi, keyword: 'íƒ€ë¥´íŠ¸' },
                    { pattern: /í‹°ë¼ë¯¸ìˆ˜/gi, keyword: 'í‹°ë¼ë¯¸ìˆ˜' },
                    { pattern: /ì´ˆì½œë¦¿/gi, keyword: 'ì´ˆì½œë¦¿' },
                    { pattern: /ì™€í”Œ/gi, keyword: 'ì™€í”Œ' },
                    
                    // ì»¤í”¼/ì›ë‘ ê´€ë ¨
                    { pattern: /ì›ë‘/gi, keyword: 'ì›ë‘' },
                    { pattern: /ë¡œìŠ¤íŒ…/gi, keyword: 'ë¡œìŠ¤íŒ…' },
                    { pattern: /ë“œë¦½ì»¤í”¼|í•¸ë“œë“œë¦½|ë“œë¦½/gi, keyword: 'ë“œë¦½' },
                    { pattern: /ì—ìŠ¤í”„ë ˆì†Œ/gi, keyword: 'ì—ìŠ¤í”„ë ˆì†Œ' },
                    { pattern: /ì¹´í˜ë¼ë–¼|ë¼ë–¼/gi, keyword: 'ë¼ë–¼' },
                    { pattern: /ì•„ë©”ë¦¬ì¹´ë…¸/gi, keyword: 'ì•„ë©”ë¦¬ì¹´ë…¸' },
                    { pattern: /ì½œë“œë¸Œë£¨/gi, keyword: 'ì½œë“œë¸Œë£¨' },
                    { pattern: /ì¹´í‘¸ì¹˜ë…¸/gi, keyword: 'ì¹´í‘¸ì¹˜ë…¸' },
                    { pattern: /ë°”ë‹ë¼ë¼ë–¼|ë°”ë‹ë¼/gi, keyword: 'ë°”ë‹ë¼ë¼ë–¼' },
                    
                    // ë¹µ/ë² ì´ì»¤ë¦¬ ê´€ë ¨
                    { pattern: /ë² ì´ì»¤ë¦¬/gi, keyword: 'ë² ì´ì»¤ë¦¬' },
                    { pattern: /ë² ì´ê¸€/gi, keyword: 'ë² ì´ê¸€' },
                    { pattern: /í¬ë£¨ì•„ìƒ/gi, keyword: 'í¬ë£¨ì•„ìƒ' },
                    { pattern: /ë°”ê²ŒíŠ¸/gi, keyword: 'ë°”ê²ŒíŠ¸' },
                    { pattern: /ë¸Œë ˆë“œ/gi, keyword: 'ë¸Œë ˆë“œ' },
                    // "ë¹µ"ì€ ë„ˆë¬´ ì¼ë°˜ì ì´ì–´ì„œ ì œì™¸
                    
                    // ë¸ŒëŸ°ì¹˜ ê´€ë ¨
                    { pattern: /ë¸ŒëŸ°ì¹˜/gi, keyword: 'ë¸ŒëŸ°ì¹˜' },
                    { pattern: /ì—ê·¸ë² ë„¤ë”•íŠ¸|ë² ë„¤ë”•íŠ¸/gi, keyword: 'ì—ê·¸ë² ë„¤ë”•íŠ¸' },
                    { pattern: /ìƒëŸ¬ë“œ/gi, keyword: 'ìƒëŸ¬ë“œ' },
                    { pattern: /íŒŒë‹ˆë‹ˆ/gi, keyword: 'íŒŒë‹ˆë‹ˆ' },
                    { pattern: /í† ìŠ¤íŠ¸/gi, keyword: 'í† ìŠ¤íŠ¸' },
                    
                    // ì°¨/í‹° ê´€ë ¨ (ì¼ë°˜ì ì¸ ë‹¨ì–´ ì œì™¸, êµ¬ì²´ì ì¸ ê²ƒë§Œ)
                    { pattern: /í—ˆë¸Œí‹°/gi, keyword: 'í—ˆë¸Œí‹°' },
                    { pattern: /ë…¹ì°¨/gi, keyword: 'ë…¹ì°¨' },
                    { pattern: /í™ì°¨/gi, keyword: 'í™ì°¨' },
                    { pattern: /ìš°ë¡±ì°¨/gi, keyword: 'ìš°ë¡±ì°¨' },
                    { pattern: /ë°€í¬í‹°/gi, keyword: 'ë°€í¬í‹°' },
                    // "í‹°"ì™€ "ì°¨"ëŠ” ë„ˆë¬´ ì¼ë°˜ì ì´ì–´ì„œ ì œì™¸
                    
                    // íŠ¹ìˆ˜ ì¹´í˜ ìœ í˜•
                    { pattern: /í«ì¹´í˜|í« ì¹´í˜/gi, keyword: 'í«ì¹´í˜' },
                    { pattern: /ë¶ì¹´í˜|ë¶ ì¹´í˜/gi, keyword: 'ë¶ì¹´í˜' }
                ];

                // ê° ë©”ë‰´ í‚¤ì›Œë“œì˜ ì¶œí˜„ ë¹ˆë„ ê³„ì‚°
                const keywordScores = {};
                menuPatterns.forEach(({ pattern, keyword }) => {
                    const matches = allText.match(pattern);
                    if (matches && matches.length > 0) {
                        // ì´ë¯¸ ì¡´ì¬í•˜ë©´ ë¹ˆë„ ì¶”ê°€, ì—†ìœ¼ë©´ ìƒˆë¡œ ì¶”ê°€
                        if (keywordScores[keyword]) {
                            keywordScores[keyword] += matches.length;
                        } else {
                            keywordScores[keyword] = matches.length;
                        }
                    }
                });

                // ë””ë²„ê¹…: í‚¤ì›Œë“œ ì¶”ì¶œ ê²°ê³¼ í™•ì¸
                console.log('í‚¤ì›Œë“œ ì¶”ì¶œ ê²°ê³¼:', {
                    cafeName,
                    searchQuery,
                    blogItemsCount: blogData.items?.length || 0,
                    allTextLength: allText.length,
                    allTextSample: allText.substring(0, 200), // ì²˜ìŒ 200ìë§Œ ìƒ˜í”Œ
                    keywordScores,
                    sortedKeywords: Object.entries(keywordScores).sort((a, b) => b[1] - a[1]).slice(0, 3)
                });

                // ë¹ˆë„ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ê³  ìƒìœ„ 3ê°œ ì„ íƒ (ìµœëŒ€ 3ê°œ)
                const sortedKeywords = Object.entries(keywordScores)
                    .sort((a, b) => b[1] - a[1]) // ë¹ˆë„ ë‚´ë¦¼ì°¨ìˆœ
                    .slice(0, 3) // ìµœëŒ€ 3ê°œ
                    .map(([keyword]) => keyword);

                // ìµœì†Œ 1ê°œ ì´ìƒì´ë©´ ë°˜í™˜, ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ (ê°•ì œ ë³´ì¶© ê¸ˆì§€)
                return sortedKeywords.length > 0 ? sortedKeywords : [];
            } catch (error) {
                console.error('í‚¤ì›Œë“œ ì¶”ì¶œ ì‹¤íŒ¨:', error);
                // ì—ëŸ¬ ë°œìƒ ì‹œ ì¹´í˜ ì´ë¦„ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ ì‹œë„
                return extractKeywordsFromName(cafeName);
            }
        }

        // ì¹´í˜ ì´ë¦„ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ (í´ë°±)
        function extractKeywordsFromName(cafeName) {
            const keywords = [];
            const name = (cafeName || '').toLowerCase();
            
            const namePatterns = [
                { pattern: /ì¼€ì´í¬|cake/gi, keyword: 'ì¼€ì´í¬' },
                { pattern: /ë§ˆì¹´ë¡±|macaron/gi, keyword: 'ë§ˆì¹´ë¡±' },
                { pattern: /ë¸Œë¼ìš°ë‹ˆ|brownie/gi, keyword: 'ë¸Œë¼ìš°ë‹ˆ' },
                { pattern: /ë””ì €íŠ¸|dessert/gi, keyword: 'ë””ì €íŠ¸' },
                { pattern: /ì›ë‘|bean/gi, keyword: 'ì›ë‘' },
                { pattern: /ë¡œìŠ¤íŒ…|roasting/gi, keyword: 'ë¡œìŠ¤íŒ…' },
                { pattern: /ë“œë¦½|drip/gi, keyword: 'ë“œë¦½' },
                { pattern: /ì—ìŠ¤í”„ë ˆì†Œ|espresso/gi, keyword: 'ì—ìŠ¤í”„ë ˆì†Œ' },
                { pattern: /ë¼ë–¼|latte/gi, keyword: 'ë¼ë–¼' },
                { pattern: /ì•„ë©”ë¦¬ì¹´ë…¸|americano/gi, keyword: 'ì•„ë©”ë¦¬ì¹´ë…¸' },
                { pattern: /ì½œë“œë¸Œë£¨|coldbrew/gi, keyword: 'ì½œë“œë¸Œë£¨' },
                { pattern: /ë² ì´ì»¤ë¦¬|bakery/gi, keyword: 'ë² ì´ì»¤ë¦¬' },
                { pattern: /ë¸ŒëŸ°ì¹˜|brunch/gi, keyword: 'ë¸ŒëŸ°ì¹˜' },
                { pattern: /í—ˆë¸Œí‹°|herbtea/gi, keyword: 'í—ˆë¸Œí‹°' },
                { pattern: /í«|pet/gi, keyword: 'í«ì¹´í˜' },
                { pattern: /ë¶|book/gi, keyword: 'ë¶ì¹´í˜' }
            ];
            
            namePatterns.forEach(({ pattern, keyword }) => {
                if (pattern.test(name) && keywords.length < 3 && !keywords.includes(keyword)) {
                    keywords.push(keyword);
                }
            });
            
            return keywords;
        }

        // ì¹´í˜ ê²€ìƒ‰
        async function searchCafes(address) {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const resultsSection = document.getElementById('resultsSection');
            const cafeList = document.getElementById('cafeList');
            const resultsHeader = document.getElementById('resultsHeader');

            // UI ì´ˆê¸°í™”
            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            resultsSection.style.display = 'none';
            cafeList.innerHTML = '';

            try {
                // 1ë‹¨ê³„: ì¹´ì¹´ì˜¤ APIë¡œ ì£¼ì†Œë¥¼ ì¢Œí‘œë¡œ ë³€í™˜ (ì •í™•í•œ ì£¼ì†Œ ê²€ìƒ‰)
                const addressData = await callKakaoAPI('address', {
                    query: address,
                    size: 1
                });

                if (!addressData.documents || addressData.documents.length === 0) {
                    throw new Error('ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì£¼ì†Œ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }

                const location = addressData.documents[0];
                const baseX = parseFloat(location.x); // ê²½ë„
                const baseY = parseFloat(location.y); // ìœ„ë„

                // 2ë‹¨ê³„: ì¹´ì¹´ì˜¤ APIë¡œ 500m ë°˜ê²½ ë‚´ ì¹´í˜ ê²€ìƒ‰ (ë°˜ê²½ ê²€ìƒ‰ ì§€ì›)
                const radius = 500; // 500m
                const cafeData = await callKakaoAPI('keyword', {
                    query: 'ì¹´í˜',
                    x: baseX,
                    y: baseY,
                    radius: radius,
                    size: 15
                });

                if (!cafeData.documents || cafeData.documents.length === 0) {
                    loadingEl.style.display = 'none';
                    showNoResults();
                    return;
                }

                // 3ë‹¨ê³„: ì¹´í˜ ì¹´í…Œê³ ë¦¬ í•„í„°ë§, í”„ëœì°¨ì´ì¦ˆ ì œì™¸ ë° ê±°ë¦¬ ê³„ì‚°
                const cafes = cafeData.documents
                    .filter(doc => {
                        // ì¹´í…Œê³ ë¦¬ í•„í„°ë§: ì¹´í˜ë§Œ í—ˆìš©
                        const categoryName = doc.category_name || '';
                        if (!isCafeCategory(categoryName)) {
                            return false;
                        }
                        // í”„ëœì°¨ì´ì¦ˆ ì œì™¸
                        const cafeName = doc.place_name || '';
                        return !isExcludedCafe(cafeName);
                    })
                    .map(doc => {
                        const cafeX = parseFloat(doc.x);
                        const cafeY = parseFloat(doc.y);
                        const distance = calculateDistance(baseY, baseX, cafeY, cafeX);
                        
                        // ì¹´ì¹´ì˜¤ API ì‘ë‹µ êµ¬ì¡°: road_address ê°ì²´ ì•ˆì— address_nameì´ ìˆìŒ
                        const roadAddr = (doc.road_address && doc.road_address.address_name) 
                            ? doc.road_address.address_name 
                            : '';
                        const addr = doc.address_name || '';
                        const placeName = doc.place_name || '';
                        
                        // ì¥ì†Œëª…ì—ì„œ ì¸µ ì •ë³´ ì¶”ì¶œ
                        const floorInfo = extractFloorInfo(placeName);
                        
                        return {
                            name: placeName,
                            address: addr, // ì§€ë²ˆ ì£¼ì†Œ
                            roadAddress: roadAddr, // ë„ë¡œëª… ì£¼ì†Œ
                            displayAddress: roadAddr || addr, // í‘œì‹œìš© (ë„ë¡œëª… ìš°ì„ )
                            floor: floorInfo, // ì¸µ ì •ë³´
                            x: cafeX,
                            y: cafeY,
                            distance: distance,
                            categoryName: doc.category_name || '',
                            doc: doc // ì£¼ì†Œ ì¬ì¡°íšŒìš©
                        };
                    })
                    .filter(cafe => cafe.distance <= 500) // 500m ì´ë‚´ë§Œ
                    .sort((a, b) => a.distance - b.distance); // ê±°ë¦¬ìˆœ ì •ë ¬

                if (cafes.length === 0) {
                    loadingEl.style.display = 'none';
                    showNoResults();
                    return;
                }

                // ë„ë¡œëª… ì£¼ì†Œê°€ ì—†ëŠ” ì¹´í˜ë“¤ì˜ ì¢Œí‘œë¡œ ì£¼ì†Œ ì¬ì¡°íšŒ ë° ì¸µ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ì€ ì´ ì‘ì—…ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ìœ ì§€
                const cafesWithAddress = await Promise.all(cafes.map(async (cafe) => {
                    // ë„ë¡œëª… ì£¼ì†Œê°€ ì—†ìœ¼ë©´ ì¢Œí‘œë¡œ ì£¼ì†Œ ì¡°íšŒ
                    if (!cafe.roadAddress && cafe.x && cafe.y) {
                        try {
                            const coordData = await callKakaoAPI('coord2address', {
                                x: cafe.x,
                                y: cafe.y
                            });
                            
                            if (coordData.documents && coordData.documents.length > 0) {
                                const doc = coordData.documents[0];
                                const roadAddr = (doc.road_address && doc.road_address.address_name) 
                                    ? doc.road_address.address_name 
                                    : '';
                                if (roadAddr) {
                                    cafe.roadAddress = roadAddr;
                                    cafe.displayAddress = roadAddr;
                                }
                            }
                        } catch (error) {
                            console.warn('ì£¼ì†Œ ì¬ì¡°íšŒ ì‹¤íŒ¨:', cafe.name, error);
                        }
                    }
                    
                    // ì¸µ ì •ë³´ê°€ ì—†ìœ¼ë©´ ë„¤ì´ë²„ ê²€ìƒ‰ APIë¡œ ì¸µ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    if (!cafe.floor) {
                        try {
                            const searchQuery = cafe.displayAddress || cafe.roadAddress || cafe.address
                                ? `${cafe.name} ${(cafe.displayAddress || cafe.roadAddress || cafe.address).split(' ').slice(0, 2).join(' ')}`
                                : cafe.name;
                            
                            const naverResult = await callNaverAPI('local', {
                                query: searchQuery,
                                display: 1,
                                sort: 'random'
                            });
                            
                            if (naverResult.items && naverResult.items.length > 0) {
                                const item = naverResult.items[0];
                                const title = (item.title || '').replace(/<[^>]*>/g, '');
                                const address = (item.address || '').replace(/<[^>]*>/g, '');
                                const roadAddress = (item.roadAddress || '').replace(/<[^>]*>/g, '');
                                
                                // ì œëª©, ì£¼ì†Œì—ì„œ ì¸µ ì •ë³´ ì¶”ì¶œ
                                const floorFromTitle = extractFloorInfo(title);
                                const floorFromAddress = extractFloorInfo(address + ' ' + roadAddress);
                                cafe.floor = floorFromTitle || floorFromAddress || '';
                            }
                        } catch (error) {
                            console.warn('ì¸µ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', cafe.name, error);
                            cafe.floor = cafe.floor || '';
                        }
                    }
                    
                    return cafe;
                }));

                // ë„¤ì´ë²„ ê²€ìƒ‰ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸ ë° ì¹´í…Œê³ ë¦¬ í™•ì¸ (ì¹´í˜ë§Œ í•„í„°ë§)
                const cafesSearchable = [];
                for (let i = 0; i < cafesWithAddress.length; i++) {
                    const cafe = cafesWithAddress[i];
                    // API í˜¸ì¶œ ì œí•œì„ ìœ„í•´ ì•½ê°„ì˜ ì§€ì—° ì¶”ê°€ (ì´ˆë‹¹ 5ê°œ ì œí•œ ê³ ë ¤)
                    if (i > 0 && i % 5 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                    
                    try {
                        const isSearchable = await isSearchableOnNaver(cafe);
                        if (isSearchable) {
                            cafesSearchable.push(cafe);
                            console.log(`ë„¤ì´ë²„ ê²€ìƒ‰ ê°€ëŠ¥ ë° ì¹´í…Œê³ ë¦¬ "ì¹´í˜" í™•ì¸ ì™„ë£Œ [${cafe.name}]`);
                        } else {
                            console.log(`ë„¤ì´ë²„ ê²€ìƒ‰ ë¶ˆê°€ëŠ¥ ë˜ëŠ” ì¹´í…Œê³ ë¦¬ê°€ "ì¹´í˜"ê°€ ì•„ë‹˜ - ë¦¬ìŠ¤íŒ… ì œì™¸ [${cafe.name}]`);
                        }
                    } catch (error) {
                        console.warn('ë„¤ì´ë²„ ê²€ìƒ‰ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸ ì‹¤íŒ¨:', cafe.name, error);
                        // ì—ëŸ¬ ë°œìƒ ì‹œ ê²€ìƒ‰ ê°€ëŠ¥í•œ ê²ƒìœ¼ë¡œ ê°„ì£¼í•˜ì§€ ì•ŠìŒ (ì¹´í…Œê³ ë¦¬ í™•ì¸ ì‹¤íŒ¨ ì‹œ ì œì™¸)
                        console.log(`ë„¤ì´ë²„ ê²€ìƒ‰ í™•ì¸ ì‹¤íŒ¨ë¡œ ì¸í•œ ë¦¬ìŠ¤íŒ… ì œì™¸ [${cafe.name}]`);
                    }
                }

                // ê° ì¹´í˜ì— ëŒ€í•´ í‚¤ì›Œë“œ ì¶”ì¶œ (ë°°ì¹˜ ì²˜ë¦¬ë¡œ ì„±ëŠ¥ ê°œì„ )
                const cafesWithKeywords = [];
                const keywordBatchSize = 5;
                
                for (let i = 0; i < cafesSearchable.length; i += keywordBatchSize) {
                    const batch = cafesSearchable.slice(i, i + keywordBatchSize);
                    
                    // ë°°ì¹˜ ë‚´ì—ì„œ ë³‘ë ¬ ì²˜ë¦¬
                    const batchResults = await Promise.all(
                        batch.map(async (cafe) => {
                            try {
                                const keywords = await extractCafeKeywords(
                                    cafe.name,
                                    cafe.displayAddress || cafe.roadAddress || cafe.address
                                );
                                console.log(`í‚¤ì›Œë“œ ì¶”ì¶œ ì™„ë£Œ [${cafe.name}]:`, keywords);
                                return { ...cafe, keywords: keywords || [] };
                            } catch (error) {
                                console.error('í‚¤ì›Œë“œ ì¶”ì¶œ ì‹¤íŒ¨:', cafe.name, error);
                                return { ...cafe, keywords: [] };
                            }
                        })
                    );
                    
                    cafesWithKeywords.push(...batchResults);
                    
                    // ë°°ì¹˜ ê°„ ì§€ì—° (API ì œí•œ ê³ ë ¤, ë§ˆì§€ë§‰ ë°°ì¹˜ëŠ” ì§€ì—° ë¶ˆí•„ìš”)
                    if (i + keywordBatchSize < cafesSearchable.length) {
                        await new Promise(resolve => setTimeout(resolve, 200)); // 200msë¡œ ë‹¨ì¶•
                    }
                }

                // ë¨¼ì € ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ìˆ¨ê¸°ê¸° (ê²°ê³¼ í‘œì‹œ ì „ì—)
                loadingEl.style.display = 'none';

                // ì¹´í˜ ëª©ë¡ í‘œì‹œ
                resultsHeader.textContent = `ì£¼ë³€ì˜ ${cafesWithKeywords.length}ê°œ ì¹´í˜ì…ë‹ˆë‹¤. (í”„ëœì°¨ì´ì¦ˆ ì œì™¸)`;
                resultsSection.style.display = 'block';

                cafesWithKeywords.forEach(cafe => {
                    const li = document.createElement('li');
                    li.className = 'cafe-item';
                    
                    const nameEl = document.createElement('div');
                    nameEl.className = 'cafe-name';
                    nameEl.onclick = () => openNaverMap(cafe);
                    
                    // ì¹´í˜ ì´ë¦„
                    nameEl.textContent = cafe.name;
                    
                    const addressEl = document.createElement('div');
                    addressEl.className = 'cafe-address';
                    // ë„ë¡œëª… ì£¼ì†Œ ìš°ì„  í‘œì‹œ, ì¸µ ì •ë³´ ì¶”ê°€
                    let addressText = cafe.displayAddress || cafe.roadAddress || cafe.address;
                    if (cafe.floor) {
                        addressText += ` ${cafe.floor}`;
                    }
                    addressEl.textContent = addressText;
                    
                    const distanceEl = document.createElement('div');
                    distanceEl.className = 'cafe-distance';
                    distanceEl.textContent = `${Math.round(cafe.distance)}m`;
                    
                    // í‚¤ì›Œë“œ í‘œì‹œ (ì´ë¯¸ ì¶”ì¶œë¨)
                    const keywords = cafe.keywords || [];
                    const keywordsContainer = document.createElement('div');
                    keywordsContainer.className = 'cafe-keywords';
                    
                    keywords.forEach(keyword => {
                        const keywordEl = document.createElement('span');
                        keywordEl.className = 'cafe-keyword';
                        keywordEl.textContent = keyword;
                        keywordsContainer.appendChild(keywordEl);
                    });
                    
                    // ê±°ë¦¬ì™€ í‚¤ì›Œë“œë¥¼ í•¨ê»˜ í‘œì‹œí•˜ê¸° ìœ„í•œ ì»¨í…Œì´ë„ˆ
                    const distanceContainer = document.createElement('div');
                    distanceContainer.style.display = 'flex';
                    distanceContainer.style.alignItems = 'center';
                    distanceContainer.appendChild(distanceEl);
                    if (keywords.length > 0) {
                        distanceContainer.appendChild(keywordsContainer);
                    }
                    
                    li.appendChild(nameEl);
                    li.appendChild(addressEl);
                    li.appendChild(distanceContainer);
                    cafeList.appendChild(li);
                });

            } catch (error) {
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                
                // ë” ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€
                let errorMessage = 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                
                if (error.message && error.message.includes('Failed to fetch')) {
                    errorMessage = 'ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œì»¬ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ì„œëŠ” Vercel CLIë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.\n\ní„°ë¯¸ë„ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”:\n1. npm i -g vercel\n2. vercel dev';
                } else if (error.message && error.message.includes('ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤')) {
                    errorMessage = error.message;
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                // ì¤„ë°”ê¿ˆì„ HTMLë¡œ ë³€í™˜
                errorMessage = errorMessage.replace(/\n/g, '<br>');
                errorEl.innerHTML = errorMessage;
                console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
            }
        }

        // ë„¤ì´ë²„ ê²€ìƒ‰ ê²°ê³¼ ê°€ì ¸ì˜¤ê¸° (ì¸µ ì •ë³´, ê²€ìƒ‰ ê°€ëŠ¥ ì—¬ë¶€, ì¹´í…Œê³ ë¦¬ í™•ì¸ í†µí•©)
        async function getNaverSearchInfo(cafe) {
            try {
                const address = cafe.displayAddress || cafe.roadAddress || cafe.address || '';
                
                // 1ì°¨ ê²€ìƒ‰: ë§¤ì¥ëª…ì¹­ + ì£¼ì†Œ
                let searchQueryWithAddress = cafe.name;
                if (address) {
                    const addressParts = address.split(' ');
                    const simplifiedAddress = addressParts.slice(1).join(' ') || address;
                    searchQueryWithAddress = `${cafe.name} ${simplifiedAddress}`;
                }
                
                // ë„¤ì´ë²„ ê²€ìƒ‰ APIë¡œ 1ì°¨ ê²€ìƒ‰ ê²°ê³¼ í™•ì¸
                const searchResult = await callNaverAPI('local', {
                    query: searchQueryWithAddress,
                    display: 5,
                    sort: 'random'
                });
                
                let floorInfo = cafe.floor || '';
                let isSearchable = false;
                
                // ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆê³ , ì²« ë²ˆì§¸ ê²°ê³¼ì˜ ì´ë¦„ì´ ì¹´í˜ ì´ë¦„ê³¼ ìœ ì‚¬í•œì§€ í™•ì¸
                if (searchResult.items && searchResult.items.length > 0) {
                    // ì—¬ëŸ¬ ê²°ê³¼ ì¤‘ì—ì„œ ì¹´í˜ ì´ë¦„ê³¼ ì¼ì¹˜í•˜ëŠ” ê²ƒì„ ì°¾ê¸°
                    for (const item of searchResult.items) {
                        const resultTitle = (item.title || '').replace(/<[^>]*>/g, '');
                        const resultCategory = (item.category || '').toLowerCase();
                        const resultAddress = (item.address || '').replace(/<[^>]*>/g, '');
                        const resultRoadAddress = (item.roadAddress || '').replace(/<[^>]*>/g, '');
                        
                        // ì¹´í˜ ì´ë¦„ì´ ê²€ìƒ‰ ê²°ê³¼ ì œëª©ì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                        const nameMatches = resultTitle.includes(cafe.name) || cafe.name.includes(resultTitle.split(' ')[0]);
                        
                        // ì¹´í…Œê³ ë¦¬ê°€ "ì¹´í˜"ì¸ì§€ í™•ì¸
                        const isCafeCategory = resultCategory && (resultCategory.includes('ì¹´í˜') || resultCategory.includes('cafe') || resultCategory.startsWith('ì¹´í˜'));
                        
                        if (nameMatches && isCafeCategory) {
                            isSearchable = true;
                            // ì¸µ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì¶”ì¶œ
                            if (!floorInfo) {
                                const floorFromTitle = extractFloorInfo(resultTitle);
                                const floorFromAddress = extractFloorInfo(resultAddress + ' ' + resultRoadAddress);
                                floorInfo = floorFromTitle || floorFromAddress || '';
                            }
                            break; // ì¼ì¹˜í•˜ëŠ” ê²°ê³¼ë¥¼ ì°¾ì•˜ìœ¼ë©´ ì¤‘ë‹¨
                        }
                    }
                }
                
                // 1ì°¨ ê²€ìƒ‰ ì‹¤íŒ¨ ì‹œ 2ì°¨ ê²€ìƒ‰: ë§¤ì¥ëª…ì¹­ë§Œ
                if (!isSearchable) {
                    const searchResultNameOnly = await callNaverAPI('local', {
                        query: cafe.name,
                        display: 5,
                        sort: 'random'
                    });
                    
                    // ë§¤ì¥ëª…ì¹­ë§Œìœ¼ë¡œ ê²€ìƒ‰ ê²°ê³¼ í™•ì¸
                    if (searchResultNameOnly.items && searchResultNameOnly.items.length > 0) {
                        for (const item of searchResultNameOnly.items) {
                            const resultTitle = (item.title || '').replace(/<[^>]*>/g, '');
                            const resultCategory = (item.category || '').toLowerCase();
                            const resultAddress = (item.address || '').replace(/<[^>]*>/g, '');
                            const resultRoadAddress = (item.roadAddress || '').replace(/<[^>]*>/g, '');
                            
                            // ì¹´í˜ ì´ë¦„ì´ ê²€ìƒ‰ ê²°ê³¼ ì œëª©ì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                            const nameMatches = resultTitle.includes(cafe.name) || cafe.name.includes(resultTitle.split(' ')[0]);
                            
                            // ì¹´í…Œê³ ë¦¬ê°€ "ì¹´í˜"ì¸ì§€ í™•ì¸
                            const isCafeCategory = resultCategory && (resultCategory.includes('ì¹´í˜') || resultCategory.includes('cafe') || resultCategory.startsWith('ì¹´í˜'));
                            
                            if (nameMatches && isCafeCategory) {
                                isSearchable = true;
                                // ì¸µ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì¶”ì¶œ
                                if (!floorInfo) {
                                    const floorFromTitle = extractFloorInfo(resultTitle);
                                    const floorFromAddress = extractFloorInfo(resultAddress + ' ' + resultRoadAddress);
                                    floorInfo = floorFromTitle || floorFromAddress || '';
                                }
                                break; // ì¼ì¹˜í•˜ëŠ” ê²°ê³¼ë¥¼ ì°¾ì•˜ìœ¼ë©´ ì¤‘ë‹¨
                            }
                        }
                    }
                }
                
                return { isSearchable, floorInfo };
            } catch (error) {
                console.warn('ë„¤ì´ë²„ ê²€ìƒ‰ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', cafe.name, error);
                // ì—ëŸ¬ ë°œìƒ ì‹œ ê²€ìƒ‰ ê°€ëŠ¥í•œ ê²ƒìœ¼ë¡œ ê°„ì£¼í•˜ì§€ ì•ŠìŒ
                return { isSearchable: false, floorInfo: cafe.floor || '' };
            }
        }

        // ë„¤ì´ë²„ë§µìœ¼ë¡œ ì´ë™
        async function openNaverMap(cafe) {
            // ì¹´í˜ ì´ë¦„ê³¼ ì£¼ì†Œë¥¼ í•¨ê»˜ ì‚¬ìš©í•˜ì—¬ ì •í™•í•œ ìœ„ì¹˜ ê²€ìƒ‰
            // ë„ë¡œëª… ì£¼ì†Œ ìš°ì„ , ì—†ìœ¼ë©´ ì§€ë²ˆ ì£¼ì†Œ ì‚¬ìš©
            const address = cafe.displayAddress || cafe.roadAddress || cafe.address || '';
            
            // 1ì°¨ ê²€ìƒ‰: ë§¤ì¥ëª…ì¹­ + ì£¼ì†Œ
            let searchQueryWithAddress = cafe.name;
            if (address) {
                // ì£¼ì†Œì˜ í•µì‹¬ ë¶€ë¶„ë§Œ ì‚¬ìš© (ì˜ˆ: "ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 152" -> "ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 152")
                const addressParts = address.split(' ');
                // ì‹œ/ë„ ì œê±°í•˜ê³  êµ¬/ë™/ë¡œ/ê¸¸ í¬í•¨
                const simplifiedAddress = addressParts.slice(1).join(' ') || address;
                searchQueryWithAddress = `${cafe.name} ${simplifiedAddress}`;
            }
            
            // ë„¤ì´ë²„ ê²€ìƒ‰ APIë¡œ 1ì°¨ ê²€ìƒ‰ ê²°ê³¼ í™•ì¸
            try {
                const searchResult = await callNaverAPI('local', {
                    query: searchQueryWithAddress,
                    display: 5,
                    sort: 'random'
                });
                
                // ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆê³ , ì²« ë²ˆì§¸ ê²°ê³¼ì˜ ì´ë¦„ì´ ì¹´í˜ ì´ë¦„ê³¼ ìœ ì‚¬í•œì§€ í™•ì¸
                let searchSuccess = false;
                if (searchResult.items && searchResult.items.length > 0) {
                    const firstResult = searchResult.items[0];
                    const resultTitle = (firstResult.title || '').replace(/<[^>]*>/g, '');
                    // ì¹´í˜ ì´ë¦„ì´ ê²€ìƒ‰ ê²°ê³¼ ì œëª©ì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                    if (resultTitle.includes(cafe.name) || cafe.name.includes(resultTitle.split(' ')[0])) {
                        searchSuccess = true;
                    }
                }
                
                if (searchSuccess) {
                    // 1ì°¨ ê²€ìƒ‰ ì„±ê³µ: ë§¤ì¥ëª…ì¹­ + ì£¼ì†Œë¡œ ë„¤ì´ë²„ë§µ ì—´ê¸°
                    const urlWithAddress = `https://map.naver.com/v5/search/${encodeURIComponent(searchQueryWithAddress)}`;
                    window.open(urlWithAddress, '_blank');
                } else {
                    // 1ì°¨ ê²€ìƒ‰ ì‹¤íŒ¨: ë§¤ì¥ëª…ì¹­ë§Œìœ¼ë¡œ ë„¤ì´ë²„ë§µ ì—´ê¸°
                    const urlNameOnly = `https://map.naver.com/v5/search/${encodeURIComponent(cafe.name)}`;
                    window.open(urlNameOnly, '_blank');
                }
            } catch (error) {
                // API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œì—ë„ 1ì°¨ ê²€ìƒ‰(ë§¤ì¥ëª…ì¹­ + ì£¼ì†Œ) ì‹œë„
                console.warn('ë„¤ì´ë²„ ê²€ìƒ‰ API í˜¸ì¶œ ì‹¤íŒ¨, 1ì°¨ ê²€ìƒ‰ìœ¼ë¡œ ì§„í–‰:', error);
                const urlWithAddress = `https://map.naver.com/v5/search/${encodeURIComponent(searchQueryWithAddress)}`;
                window.open(urlWithAddress, '_blank');
            }
        }

        // ê²°ê³¼ ì—†ìŒ í‘œì‹œ
        function showNoResults() {
            const resultsSection = document.getElementById('resultsSection');
            const cafeList = document.getElementById('cafeList');
            
            resultsSection.style.display = 'block';
            cafeList.innerHTML = `
                <li class="no-results">
                    <div class="no-results-title">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                    <div class="no-results-text">500m ì´ë‚´ì— ì¹´í˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
                </li>
            `;
        }

        // ì£¼ì†Œ í›„ë³´ ê²€ìƒ‰ ë° ë¦¬ìŠ¤íŒ…
        async function searchAddressCandidates(query) {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const resultsSection = document.getElementById('resultsSection');
            const cafeList = document.getElementById('cafeList');
            const resultsHeader = document.getElementById('resultsHeader');

            // UI ì´ˆê¸°í™”
            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            resultsSection.style.display = 'none';
            cafeList.innerHTML = '';

            try {
                // ì¹´ì¹´ì˜¤ APIë¡œ ì£¼ì†Œ ê²€ìƒ‰ (ì •í™•í•œ ì£¼ì†Œ ê²€ìƒ‰) + í‚¤ì›Œë“œ ê²€ìƒ‰ (ì¥ì†Œëª…)
                const [addressData, keywordData] = await Promise.all([
                    callKakaoAPI('address', {
                        query: query,
                        size: 10
                    }).catch(() => ({ documents: [] })),
                    callKakaoAPI('keyword', {
                        query: query,
                        size: 10
                    }).catch(() => ({ documents: [] }))
                ]);

                const suggestions = [];
                const seenAddresses = new Set();

                // ì¹´ì¹´ì˜¤ ì£¼ì†Œ ê²€ìƒ‰ ê²°ê³¼ ì²˜ë¦¬
                if (addressData.documents && addressData.documents.length > 0) {
                    addressData.documents.forEach(doc => {
                        const roadAddr = doc.road_address?.address_name || '';
                        const addr = doc.address_name || '';
                        
                        if (roadAddr || addr) {
                            const key = roadAddr || addr;
                            if (!seenAddresses.has(key) && suggestions.length < 15) {
                                seenAddresses.add(key);
                                suggestions.push({
                                    main: roadAddr || addr, // ë„ë¡œëª… ì£¼ì†Œ ìš°ì„ 
                                    sub: roadAddr ? addr : '', // ë„ë¡œëª…ì´ ìˆìœ¼ë©´ ì§€ë²ˆì„ ì„œë¸Œë¡œ
                                    fullAddress: roadAddr || addr,
                                    roadAddress: roadAddr || '',
                                    x: doc.x,
                                    y: doc.y
                                });
                            }
                        }
                    });
                }

                // ì¹´ì¹´ì˜¤ í‚¤ì›Œë“œ ê²€ìƒ‰ ê²°ê³¼ ì²˜ë¦¬ (ì—­, ê±´ë¬¼ëª… ë“±)
                if (keywordData.documents && keywordData.documents.length > 0) {
                    keywordData.documents.forEach(doc => {
                        const roadAddr = doc.road_address?.address_name || '';
                        const addr = doc.address_name || '';
                        const placeName = doc.place_name || '';
                        
                        if (placeName || roadAddr || addr) {
                            const displayName = placeName || roadAddr || addr;
                            const key = placeName + '|' + (roadAddr || addr);
                            
                            if (!seenAddresses.has(key) && suggestions.length < 15) {
                                seenAddresses.add(key);
                                suggestions.push({
                                    main: displayName,
                                    sub: roadAddr || addr, // ë„ë¡œëª… ì£¼ì†Œ ìš°ì„ 
                                    fullAddress: roadAddr || addr,
                                    roadAddress: roadAddr || '',
                                    x: doc.x,
                                    y: doc.y
                                });
                            }
                        }
                    });
                }

                loadingEl.style.display = 'none';

                if (suggestions.length === 0) {
                    errorEl.style.display = 'block';
                    errorEl.textContent = 'ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                    return;
                }

                // ì£¼ì†Œ í›„ë³´ ë¦¬ìŠ¤íŒ… í‘œì‹œ
                displayAddressCandidates(suggestions);
            } catch (error) {
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                errorEl.textContent = 'ì£¼ì†Œ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                console.error('ì£¼ì†Œ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
            }
        }

        // ì£¼ì†Œ í›„ë³´ ëª©ë¡ í‘œì‹œ
        function displayAddressCandidates(suggestions) {
            const resultsSection = document.getElementById('resultsSection');
            const cafeList = document.getElementById('cafeList');
            const resultsHeader = document.getElementById('resultsHeader');

            resultsHeader.textContent = `${suggestions.length}ê°œì˜ ì£¼ì†Œë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤. ì„ íƒí•´ì£¼ì„¸ìš”.`;
            resultsSection.style.display = 'block';
            cafeList.innerHTML = '';

            suggestions.forEach(suggestion => {
                const li = document.createElement('li');
                li.className = 'address-item';
                
                // ë„ë¡œëª… ì£¼ì†Œë¥¼ ë©”ì¸ìœ¼ë¡œ í‘œì‹œ
                const displayMain = suggestion.roadAddress || suggestion.main;
                const displaySub = suggestion.roadAddress ? suggestion.sub : '';
                
                // í…ìŠ¤íŠ¸ë¥¼ spanìœ¼ë¡œ ê°ì‹¸ì„œ í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€
                const mainEl = document.createElement('div');
                mainEl.className = 'address-main';
                const mainText = document.createTextNode(displayMain);
                mainEl.appendChild(mainText);
                
                li.appendChild(mainEl);
                
                if (displaySub) {
                    const subEl = document.createElement('div');
                    subEl.className = 'address-sub';
                    const subText = document.createTextNode(displaySub);
                    subEl.appendChild(subText);
                    li.appendChild(subEl);
                }
                
                // í´ë¦­ ì´ë²¤íŠ¸ëŠ” li ìš”ì†Œì—ë§Œ ë°”ì¸ë”©
                li.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    // ì„ íƒí•œ ì£¼ì†Œë¡œ ì¹´í˜ ê²€ìƒ‰
                    searchCafesByCoordinates(suggestion.x, suggestion.y, displayMain);
                };
                
                // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ë¡œë„ í¬ì¸í„° ì»¤ì„œ ê°•ì œ
                li.onmouseenter = () => {
                    li.style.cursor = 'pointer';
                };
                
                cafeList.appendChild(li);
            });
        }

        // ì¢Œí‘œë¡œ ì¹´í˜ ê²€ìƒ‰
        async function searchCafesByCoordinates(x, y, addressName) {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const resultsSection = document.getElementById('resultsSection');
            const cafeList = document.getElementById('cafeList');
            const resultsHeader = document.getElementById('resultsHeader');

            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            resultsSection.style.display = 'none';
            cafeList.innerHTML = '';

            try {
                const baseX = parseFloat(x);
                const baseY = parseFloat(y);

                // ì¹´ì¹´ì˜¤ APIë¡œ 500m ë°˜ê²½ ë‚´ ì¹´í˜ ê²€ìƒ‰ (ë°˜ê²½ ê²€ìƒ‰ ì§€ì›)
                const radius = 500;
                const cafeData = await callKakaoAPI('keyword', {
                    query: 'ì¹´í˜',
                    x: baseX,
                    y: baseY,
                    radius: radius,
                    size: 15
                });

                if (!cafeData.documents || cafeData.documents.length === 0) {
                    loadingEl.style.display = 'none';
                    showNoResults();
                    return;
                }

                // ì¹´í˜ ì¹´í…Œê³ ë¦¬ í•„í„°ë§, í”„ëœì°¨ì´ì¦ˆ ì œì™¸ ë° ê±°ë¦¬ ê³„ì‚°
                const cafes = cafeData.documents
                    .filter(doc => {
                        // ì¹´í…Œê³ ë¦¬ í•„í„°ë§: ì¹´í˜ë§Œ í—ˆìš©
                        const categoryName = doc.category_name || '';
                        if (!isCafeCategory(categoryName)) {
                            return false;
                        }
                        // í”„ëœì°¨ì´ì¦ˆ ì œì™¸
                        const cafeName = doc.place_name || '';
                        return !isExcludedCafe(cafeName);
                    })
                    .map(doc => {
                        const cafeX = parseFloat(doc.x);
                        const cafeY = parseFloat(doc.y);
                        const distance = calculateDistance(baseY, baseX, cafeY, cafeX);
                        
                        // ì¹´ì¹´ì˜¤ API ì‘ë‹µ êµ¬ì¡°
                        const roadAddr = (doc.road_address && doc.road_address.address_name) 
                            ? doc.road_address.address_name 
                            : '';
                        const addr = doc.address_name || '';
                        const placeName = doc.place_name || '';
                        
                        // ì¥ì†Œëª…ì—ì„œ ì¸µ ì •ë³´ ì¶”ì¶œ
                        const floorInfo = extractFloorInfo(placeName);
                        
                        return {
                            name: placeName,
                            address: addr, // ì§€ë²ˆ ì£¼ì†Œ
                            roadAddress: roadAddr, // ë„ë¡œëª… ì£¼ì†Œ
                            displayAddress: roadAddr || addr, // í‘œì‹œìš© (ë„ë¡œëª… ìš°ì„ )
                            floor: floorInfo, // ì¸µ ì •ë³´
                            x: cafeX,
                            y: cafeY,
                            distance: distance,
                            categoryName: doc.category_name || '',
                            doc: doc // ì£¼ì†Œ ì¬ì¡°íšŒìš©
                        };
                    })
                    .filter(cafe => cafe.distance <= 500)
                    .sort((a, b) => a.distance - b.distance);

                if (cafes.length === 0) {
                    loadingEl.style.display = 'none';
                    showNoResults();
                    return;
                }

                // ë„ë¡œëª… ì£¼ì†Œê°€ ì—†ëŠ” ì¹´í˜ë“¤ì˜ ì¢Œí‘œë¡œ ì£¼ì†Œ ì¬ì¡°íšŒ
                // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ì€ ì´ ì‘ì—…ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ìœ ì§€
                const cafesWithAddress = await Promise.all(cafes.map(async (cafe) => {
                    // ë„ë¡œëª… ì£¼ì†Œê°€ ì—†ìœ¼ë©´ ì¢Œí‘œë¡œ ì£¼ì†Œ ì¡°íšŒ
                    if (!cafe.roadAddress && cafe.x && cafe.y) {
                        try {
                            const coordData = await callKakaoAPI('coord2address', {
                                x: cafe.x,
                                y: cafe.y
                            });
                            
                            if (coordData.documents && coordData.documents.length > 0) {
                                const doc = coordData.documents[0];
                                const roadAddr = (doc.road_address && doc.road_address.address_name) 
                                    ? doc.road_address.address_name 
                                    : '';
                                if (roadAddr) {
                                    cafe.roadAddress = roadAddr;
                                    cafe.displayAddress = roadAddr;
                                }
                            }
                        } catch (error) {
                            console.warn('ì£¼ì†Œ ì¬ì¡°íšŒ ì‹¤íŒ¨:', cafe.name, error);
                        }
                    }
                    
                    return cafe;
                }));

                // ë„¤ì´ë²„ ê²€ìƒ‰ ì •ë³´ ì¡°íšŒ ë° í•„í„°ë§ (ì¸µ ì •ë³´ + ê²€ìƒ‰ ê°€ëŠ¥ ì—¬ë¶€ + ì¹´í…Œê³ ë¦¬ í™•ì¸ í†µí•©)
                // ë°°ì¹˜ ì²˜ë¦¬ë¡œ ì„±ëŠ¥ ê°œì„  (5ê°œì”© ë¬¶ì–´ì„œ ë³‘ë ¬ ì²˜ë¦¬)
                const cafesSearchable = [];
                const batchSize = 5;
                
                for (let i = 0; i < cafesWithAddress.length; i += batchSize) {
                    const batch = cafesWithAddress.slice(i, i + batchSize);
                    
                    // ë°°ì¹˜ ë‚´ì—ì„œ ë³‘ë ¬ ì²˜ë¦¬
                    const batchResults = await Promise.all(
                        batch.map(async (cafe) => {
                            try {
                                const { isSearchable, floorInfo } = await getNaverSearchInfo(cafe);
                                
                                if (isSearchable) {
                                    // ì¸µ ì •ë³´ ì—…ë°ì´íŠ¸
                                    if (floorInfo) {
                                        cafe.floor = floorInfo;
                                    }
                                    console.log(`ë„¤ì´ë²„ ê²€ìƒ‰ ê°€ëŠ¥ ë° ì¹´í…Œê³ ë¦¬ "ì¹´í˜" í™•ì¸ ì™„ë£Œ [${cafe.name}]`);
                                    return cafe;
                                } else {
                                    console.log(`ë„¤ì´ë²„ ê²€ìƒ‰ ë¶ˆê°€ëŠ¥ ë˜ëŠ” ì¹´í…Œê³ ë¦¬ê°€ "ì¹´í˜"ê°€ ì•„ë‹˜ - ë¦¬ìŠ¤íŒ… ì œì™¸ [${cafe.name}]`);
                                    return null;
                                }
                            } catch (error) {
                                console.warn('ë„¤ì´ë²„ ê²€ìƒ‰ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', cafe.name, error);
                                console.log(`ë„¤ì´ë²„ ê²€ìƒ‰ í™•ì¸ ì‹¤íŒ¨ë¡œ ì¸í•œ ë¦¬ìŠ¤íŒ… ì œì™¸ [${cafe.name}]`);
                                return null;
                            }
                        })
                    );
                    
                    // nullì´ ì•„ë‹Œ ê²°ê³¼ë§Œ ì¶”ê°€
                    batchResults.forEach(result => {
                        if (result) {
                            cafesSearchable.push(result);
                        }
                    });
                    
                    // ë°°ì¹˜ ê°„ ì§€ì—° (API ì œí•œ ê³ ë ¤, ë§ˆì§€ë§‰ ë°°ì¹˜ëŠ” ì§€ì—° ë¶ˆí•„ìš”)
                    if (i + batchSize < cafesWithAddress.length) {
                        await new Promise(resolve => setTimeout(resolve, 200)); // 200msë¡œ ë‹¨ì¶•
                    }
                }

                // ê° ì¹´í˜ì— ëŒ€í•´ í‚¤ì›Œë“œ ì¶”ì¶œ (ë°°ì¹˜ ì²˜ë¦¬ë¡œ ì„±ëŠ¥ ê°œì„ )
                const cafesWithKeywords = [];
                const keywordBatchSize = 5;
                
                for (let i = 0; i < cafesSearchable.length; i += keywordBatchSize) {
                    const batch = cafesSearchable.slice(i, i + keywordBatchSize);
                    
                    // ë°°ì¹˜ ë‚´ì—ì„œ ë³‘ë ¬ ì²˜ë¦¬
                    const batchResults = await Promise.all(
                        batch.map(async (cafe) => {
                            try {
                                const keywords = await extractCafeKeywords(
                                    cafe.name,
                                    cafe.displayAddress || cafe.roadAddress || cafe.address
                                );
                                console.log(`í‚¤ì›Œë“œ ì¶”ì¶œ ì™„ë£Œ [${cafe.name}]:`, keywords);
                                return { ...cafe, keywords: keywords || [] };
                            } catch (error) {
                                console.error('í‚¤ì›Œë“œ ì¶”ì¶œ ì‹¤íŒ¨:', cafe.name, error);
                                return { ...cafe, keywords: [] };
                            }
                        })
                    );
                    
                    cafesWithKeywords.push(...batchResults);
                    
                    // ë°°ì¹˜ ê°„ ì§€ì—° (API ì œí•œ ê³ ë ¤, ë§ˆì§€ë§‰ ë°°ì¹˜ëŠ” ì§€ì—° ë¶ˆí•„ìš”)
                    if (i + keywordBatchSize < cafesSearchable.length) {
                        await new Promise(resolve => setTimeout(resolve, 200)); // 200msë¡œ ë‹¨ì¶•
                    }
                }

                // ë¨¼ì € ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ìˆ¨ê¸°ê¸° (ê²°ê³¼ í‘œì‹œ ì „ì—)
                loadingEl.style.display = 'none';

                // ì¹´í˜ ëª©ë¡ í‘œì‹œ
                resultsHeader.textContent = `ì£¼ë³€ì˜ ${cafesWithKeywords.length}ê°œ ì¹´í˜ì…ë‹ˆë‹¤. (í”„ëœì°¨ì´ì¦ˆ ì œì™¸)`;
                resultsSection.style.display = 'block';

                cafesWithKeywords.forEach(cafe => {
                    const li = document.createElement('li');
                    li.className = 'cafe-item';
                    
                    const nameEl = document.createElement('div');
                    nameEl.className = 'cafe-name';
                    nameEl.onclick = () => openNaverMap(cafe);
                    
                    // ì¹´í˜ ì´ë¦„
                    nameEl.textContent = cafe.name;
                    
                    const addressEl = document.createElement('div');
                    addressEl.className = 'cafe-address';
                    // ë„ë¡œëª… ì£¼ì†Œ ìš°ì„  í‘œì‹œ, ì¸µ ì •ë³´ ì¶”ê°€
                    let addressText = cafe.displayAddress || cafe.roadAddress || cafe.address;
                    if (cafe.floor) {
                        addressText += ` ${cafe.floor}`;
                    }
                    addressEl.textContent = addressText;
                    
                    const distanceEl = document.createElement('div');
                    distanceEl.className = 'cafe-distance';
                    distanceEl.textContent = `${Math.round(cafe.distance)}m`;
                    
                    // í‚¤ì›Œë“œ í‘œì‹œ (ì´ë¯¸ ì¶”ì¶œë¨)
                    const keywords = cafe.keywords || [];
                    const keywordsContainer = document.createElement('div');
                    keywordsContainer.className = 'cafe-keywords';
                    
                    keywords.forEach(keyword => {
                        const keywordEl = document.createElement('span');
                        keywordEl.className = 'cafe-keyword';
                        keywordEl.textContent = keyword;
                        keywordsContainer.appendChild(keywordEl);
                    });
                    
                    // ê±°ë¦¬ì™€ í‚¤ì›Œë“œë¥¼ í•¨ê»˜ í‘œì‹œí•˜ê¸° ìœ„í•œ ì»¨í…Œì´ë„ˆ
                    const distanceContainer = document.createElement('div');
                    distanceContainer.style.display = 'flex';
                    distanceContainer.style.alignItems = 'center';
                    distanceContainer.appendChild(distanceEl);
                    if (keywords.length > 0) {
                        distanceContainer.appendChild(keywordsContainer);
                    }
                    
                    li.appendChild(nameEl);
                    li.appendChild(addressEl);
                    li.appendChild(distanceContainer);
                    cafeList.appendChild(li);
                });

            } catch (error) {
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                
                let errorMessage = 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                if (error.message) {
                    errorMessage = error.message.replace(/\n/g, '<br>');
                }
                
                errorEl.innerHTML = errorMessage;
                console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
            }
        }

        // ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸
        const addressInput = document.getElementById('addressInput');

        // í˜„ìœ„ì¹˜ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('locationButton').addEventListener('click', async () => {
            const locationButton = document.getElementById('locationButton');
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const resultsSection = document.getElementById('resultsSection');
            const cafeList = document.getElementById('cafeList');
            const resultsHeader = document.getElementById('resultsHeader');
            
            // ë²„íŠ¼ ë¹„í™œì„±í™”
            locationButton.disabled = true;
            locationButton.textContent = 'â³';
            
            // UI ì´ˆê¸°í™” - ê¸°ì¡´ ì¹´í˜ ëª©ë¡ ì œê±°
            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            resultsSection.style.display = 'none';
            cafeList.innerHTML = '';
            resultsHeader.textContent = '';
            
            try {
                // Geolocation APIë¡œ í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
                if (!navigator.geolocation) {
                    throw new Error('í˜„ì¬ ë¸Œë¼ìš°ì €ì—ì„œ ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
                
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });
                
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;
                
                // ì¢Œí‘œë¥¼ ì£¼ì†Œë¡œ ë³€í™˜
                try {
                    const coordData = await callKakaoAPI('coord2address', {
                        x: longitude,
                        y: latitude
                    });
                    
                    if (coordData.documents && coordData.documents.length > 0) {
                        const doc = coordData.documents[0];
                        const roadAddr = (doc.road_address && doc.road_address.address_name) 
                            ? doc.road_address.address_name 
                            : '';
                        const addr = doc.address_name || '';
                        const address = roadAddr || addr;
                        
                        // ì…ë ¥ì°½ì— ì£¼ì†Œ í‘œì‹œ
                        addressInput.value = address;
                        
                        // í•´ë‹¹ ì£¼ì†Œë¡œ ì¹´í˜ ê²€ìƒ‰
                        await searchCafesByCoordinates(longitude, latitude, address);
                    } else {
                        // ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨ ì‹œ ì¢Œí‘œë¡œ ì§ì ‘ ê²€ìƒ‰
                        const address = `ìœ„ë„ ${latitude.toFixed(6)}, ê²½ë„ ${longitude.toFixed(6)}`;
                        addressInput.value = address;
                        await searchCafesByCoordinates(longitude, latitude, address);
                    }
                } catch (error) {
                    console.warn('ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨, ì¢Œí‘œë¡œ ì§ì ‘ ê²€ìƒ‰:', error);
                    // ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨ ì‹œ ì¢Œí‘œë¡œ ì§ì ‘ ê²€ìƒ‰
                    const address = `ìœ„ë„ ${latitude.toFixed(6)}, ê²½ë„ ${longitude.toFixed(6)}`;
                    addressInput.value = address;
                    await searchCafesByCoordinates(longitude, latitude, address);
                }
                
            } catch (error) {
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                
                let errorMessage = 'í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                if (error.code === 1) {
                    errorMessage = 'ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
                } else if (error.code === 2) {
                    errorMessage = 'ìœ„ì¹˜ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. GPS ì‹ í˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
                } else if (error.code === 3) {
                    errorMessage = 'ìœ„ì¹˜ í™•ì¸ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                errorEl.textContent = errorMessage;
                console.error('ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
            } finally {
                // ë²„íŠ¼ í™œì„±í™”
                locationButton.disabled = false;
                locationButton.textContent = 'ğŸ“';
            }
        });

        // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('searchButton').addEventListener('click', () => {
            const address = addressInput.value.trim();
            if (address) {
                // ì£¼ì†Œ í›„ë³´ ê²€ìƒ‰ ë° ë¦¬ìŠ¤íŒ…
                searchAddressCandidates(address);
            }
        });

        // Enter í‚¤ ì´ë²¤íŠ¸
        addressInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const address = addressInput.value.trim();
                if (address) {
                    // ì£¼ì†Œ í›„ë³´ ê²€ìƒ‰ ë° ë¦¬ìŠ¤íŒ…
                    searchAddressCandidates(address);
                }
            }
        });
    </script>
</body>
</html>
