<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµ­ë°¥ explorer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #ffffff;
            color: #202124;
            line-height: 1.6;
            min-height: 100vh;
        }

        .address-item::selection,
        .address-item *::selection {
            background: transparent;
        }

        .address-item::-moz-selection,
        .address-item *::-moz-selection {
            background: transparent;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        h1 {
            text-align: center;
            font-size: 48px;
            font-weight: 300;
            color: #202124;
            margin-bottom: 50px;
            letter-spacing: -0.5px;
        }

        .search-section {
            margin-bottom: 40px;
        }

        .search-box {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 600px;
            margin: 0 auto;
        }

        .search-input {
            width: 100%;
            padding: 16px 20px;
            font-size: 16px;
            border: 1px solid #dfe1e5;
            border-radius: 24px;
            outline: none;
            transition: all 0.2s;
        }

        .search-buttons {
            display: flex;
            gap: 12px;
            width: 100%;
            align-items: center;
        }

        .search-input:focus {
            border-color: #4285f4;
            box-shadow: 0 2px 5px 1px rgba(64, 60, 67, 0.16);
        }

        .search-button {
            flex: 1;
            padding: 12px 24px;
            font-size: 15px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
        }

        .search-button:hover {
            background-color: #357ae8;
        }

        .search-button:active {
            background-color: #2a5fcc;
        }

        .location-button {
            flex: 0 0 auto;
            padding: 12px 16px;
            font-size: 18px;
            background-color: #34a853;
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .location-button:hover {
            background-color: #2d8f47;
        }

        .location-button:active {
            background-color: #267d3e;
        }

        .location-button:disabled {
            background-color: #c0c0c0;
            cursor: not-allowed;
        }

        .category-select {
            flex: 0 0 auto;
            padding: 12px 16px;
            font-size: 15px;
            background-color: #ffffff;
            color: #202124;
            border: 1px solid #dfe1e5;
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            outline: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%235f6368' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        .category-select:hover {
            border-color: #4285f4;
            box-shadow: 0 2px 5px 1px rgba(64, 60, 67, 0.16);
        }

        .category-select:focus {
            border-color: #4285f4;
            box-shadow: 0 2px 5px 1px rgba(64, 60, 67, 0.16);
        }

        .results-section {
            margin-top: 40px;
        }

        .results-header {
            font-size: 14px;
            color: #5f6368;
            margin-bottom: 20px;
            text-align: center;
        }

        .cafe-list {
            list-style: none;
        }

        .cafe-item {
            padding: 20px;
            border-bottom: 1px solid #f1f3f4;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .cafe-item:hover {
            background-color: #f8f9fa;
        }

        .cafe-item:last-child {
            border-bottom: none;
        }

        .cafe-name {
            font-size: 18px;
            font-weight: 500;
            color: #1a73e8;
            margin-bottom: 8px;
        }

        .cafe-name:hover {
            text-decoration: underline;
        }

        .cafe-address {
            font-size: 14px;
            color: #5f6368;
            margin-bottom: 6px;
        }

        .cafe-distance {
            font-size: 13px;
            color: #80868b;
        }

        .cafe-keywords {
            display: flex;
            gap: 6px;
            margin-left: 12px;
            flex-wrap: wrap;
        }

        .cafe-keyword {
            font-size: 11px;
            color: #5f6368;
            background-color: #f1f3f4;
            padding: 3px 8px;
            border-radius: 12px;
            white-space: nowrap;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #5f6368;
            font-size: 14px;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f1f3f4;
            border-top-color: #4285f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #ea4335;
            font-size: 14px;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #5f6368;
        }

        .no-results-title {
            font-size: 18px;
            margin-bottom: 8px;
            color: #202124;
        }

        .no-results-text {
            font-size: 14px;
        }

        .address-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dfe1e5;
            border-radius: 12px;
            margin-top: 8px;
        }

        .address-item {
            padding: 20px;
            border-bottom: 1px solid #f1f3f4;
            transition: background-color 0.2s;
            cursor: pointer !important;
            user-select: none !important;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            -webkit-touch-callout: none !important;
            -webkit-tap-highlight-color: transparent;
            background-color: #ffffff;
            display: block;
            width: 100%;
            text-align: left;
            border: none;
            outline: none;
        }

        .address-item:hover {
            background-color: #f8f9fa;
            cursor: pointer !important;
        }

        .address-item:active {
            background-color: #f1f3f4;
        }

        .address-item:last-child {
            border-bottom: none;
        }

        .address-item * {
            cursor: pointer !important;
            user-select: none !important;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            pointer-events: none !important;
            -webkit-touch-callout: none !important;
        }

        .address-main {
            font-size: 16px;
            color: #202124;
            margin-bottom: 4px;
            font-weight: 500;
            display: block;
        }

        .address-sub {
            font-size: 14px;
            color: #5f6368;
        }

        @media screen and (max-width: 768px) {
            .container {
                padding: 20px 16px;
            }

            h1 {
                font-size: 32px;
                margin-bottom: 30px;
            }

            .search-box {
                gap: 10px;
                max-width: 100%;
            }

            .search-buttons {
                flex-direction: row;
                gap: 8px;
            }

            .category-select {
                padding: 12px 14px;
                font-size: 14px;
                padding-right: 32px;
            }

            .search-input {
                padding: 14px 18px;
                font-size: 16px; /* iOS ì¤Œ ë°©ì§€ */
                border-radius: 20px;
            }

            .search-button {
                flex: 1;
                padding: 12px 16px;
                font-size: 14px;
                border-radius: 20px;
                min-width: 0;
            }

            .location-button {
                padding: 12px 14px;
                font-size: 18px;
                border-radius: 20px;
                flex: 0 0 auto;
            }
            
            .category-select {
                flex: 0 0 auto;
                min-width: 70px;
            }

            .cafe-item {
                padding: 16px;
            }

            .cafe-name {
                font-size: 16px;
                margin-bottom: 6px;
            }

            .cafe-address {
                font-size: 13px;
                margin-bottom: 4px;
                line-height: 1.5;
            }

            .cafe-distance {
                font-size: 12px;
            }

            .cafe-keywords {
                margin-left: 0;
                margin-top: 8px;
                gap: 4px;
            }

            .cafe-keyword {
                font-size: 10px;
                padding: 2px 6px;
            }

            .results-header {
                font-size: 13px;
                margin-bottom: 16px;
            }

            .address-item {
                padding: 14px 16px;
            }

            .address-main {
                font-size: 15px;
            }

            .address-sub {
                font-size: 13px;
            }

            .loading {
                padding: 30px 20px;
                font-size: 13px;
            }

            .loading-container {
                padding: 40px 16px;
            }

            .error {
                padding: 30px 20px;
                font-size: 13px;
            }

            .no-results {
                padding: 40px 16px;
            }

            .no-results-title {
                font-size: 16px;
            }
        }

        /* ì‘ì€ ëª¨ë°”ì¼ í™”ë©´ (iPhone SE ë“±) */
        @media screen and (max-width: 375px) {
            .container {
                padding: 16px 12px;
            }

            h1 {
                font-size: 28px;
                margin-bottom: 24px;
            }

            .search-input {
                padding: 12px 16px;
            }

            .search-button {
                padding: 12px 14px;
                font-size: 13px;
            }

            .location-button {
                padding: 12px 12px;
                font-size: 16px;
            }

            .category-select {
                padding: 12px 12px;
                font-size: 13px;
                padding-right: 28px;
                min-width: 65px;
            }

            .cafe-item {
                padding: 14px;
            }

            .cafe-name {
                font-size: 15px;
            }

            .cafe-address {
                font-size: 12px;
            }
        }

        /* ê°€ë¡œ ëª¨ë“œ ìµœì í™” */
        @media screen and (max-width: 768px) and (orientation: landscape) {
            .container {
                padding: 16px 20px;
            }

            h1 {
                font-size: 28px;
                margin-bottom: 20px;
            }

            .search-buttons {
                flex-direction: row;
                gap: 8px;
            }

            .search-button {
                flex: 1;
            }

            .location-button {
                flex: 0 0 auto;
                min-width: 80px;
            }

            .category-select {
                flex: 0 0 auto;
                min-width: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>êµ­ë°¥ explorer</h1>
        
        <div class="search-section">
            <div class="search-box">
                <input 
                    type="text" 
                    id="addressInput" 
                    class="search-input" 
                    placeholder="ì£¼ì†Œ ì…ë ¥"
                    autocomplete="off"
                >
                <div class="search-buttons">
                    <button id="searchButton" class="search-button">ê²€ìƒ‰</button>
                    <button id="locationButton" class="location-button" title="í˜„ìœ„ì¹˜">ğŸ“</button>
                    <select id="categorySelect" class="category-select" title="ì¹´í…Œê³ ë¦¬ ì„ íƒ">
                        <option value="êµ­ë°¥" selected>êµ­ë°¥</option>
                        <option value="ì¹´í˜">ì¹´í˜</option>
                        <option value="ë§ˆë¼íƒ•">ë§ˆë¼íƒ•</option>
                        <option value="ë¹µ">ë¹µ</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="results-section" id="resultsSection" style="display: none;">
            <div class="results-header" id="resultsHeader"></div>
            <ul class="cafe-list" id="cafeList"></ul>
        </div>

        <div class="loading" id="loading" style="display: none;">
            <div class="loading-container">
                <div class="spinner"></div>
                <div>ê²€ìƒ‰ ì¤‘...</div>
            </div>
        </div>
        <div class="error" id="error" style="display: none;"></div>
    </div>

    <script>
        // êµ­ë°¥ ê´€ë ¨ ë©”ë‰´ í‚¤ì›Œë“œ
        const SOUP_MENU_KEYWORDS = ['ìˆœëŒ€êµ­', 'ì„¤ë íƒ•', 'ê³°íƒ•', 'êµ­ë°¥', 'ìˆœëŒ“êµ­', 'ì„¤ë íƒ•ì§‘', 'ê³°íƒ•ì§‘', 'í•´ì¥êµ­', 'í•´ì¥êµ­ì§‘', 'ë¼ˆí•´ì¥êµ­', 'ì½©ë‚˜ë¬¼í•´ì¥êµ­', 'ì‹œë ˆê¸°í•´ì¥êµ­', 'ì„ ì§€í•´ì¥êµ­', 'ë”°ë¡œêµ­ë°¥', 'ê°ìíƒ•', 'ê°ìíƒ•ì§‘', 'ë¼ˆê°ìíƒ•', 'ê°ìíƒ•êµ­ë°¥', 'í•´ì¥', 'ìœ¡ê°œì¥', 'ìœ¡ê²Œì¥'];

        // API ì—”ë“œí¬ì¸íŠ¸ (ì„œë²„ë¦¬ìŠ¤ í•¨ìˆ˜ ì‚¬ìš©)
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:3000/api'
            : '/api';

        // ì¹´ì¹´ì˜¤ API í˜¸ì¶œ (ì„œë²„ë¦¬ìŠ¤ í•¨ìˆ˜ë¥¼ í†µí•´)
        async function callKakaoAPI(endpoint, params) {
            try {
                const queryParams = new URLSearchParams({
                    endpoint: endpoint,
                    ...params
                });
                
                const response = await fetch(`${API_BASE_URL}/kakao?${queryParams}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'API í˜¸ì¶œ ì‹¤íŒ¨');
                }

                return await response.json();
            } catch (error) {
                console.error('Kakao API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                throw error;
            }
        }

        // ë„¤ì´ë²„ API í˜¸ì¶œ (ì„œë²„ë¦¬ìŠ¤ í•¨ìˆ˜ë¥¼ í†µí•´)
        async function callNaverAPI(endpoint, params) {
            try {
                const queryParams = new URLSearchParams({
                    endpoint: endpoint,
                    ...params
                });
                
                const response = await fetch(`${API_BASE_URL}/naver?${queryParams}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'API í˜¸ì¶œ ì‹¤íŒ¨');
                }

                return await response.json();
            } catch (error) {
                console.error('Naver API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                throw error;
            }
        }

        // ê±°ë¦¬ ê³„ì‚° (Haversine ê³µì‹)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // ì§€êµ¬ ë°˜ì§€ë¦„ (ë¯¸í„°)
            const Ï†1 = lat1 * Math.PI / 180;
            const Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
            const Î”Î» = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                    Math.cos(Ï†1) * Math.cos(Ï†2) *
                    Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // ë¯¸í„° ë‹¨ìœ„
        }

        // ì¸µ ì •ë³´ ì¶”ì¶œ
        function extractFloorInfo(text) {
            if (!text) return '';
            
            const floorPatterns = [
                /(\d+)ì¸µ/g,
                /(\d+)F/g,
                /(\d+)f/g,
                /B(\d+)/g,
                /ì§€í•˜\s*(\d+)/g,
                /\((\d+)ì¸µ\)/g,
                /\((\d+)F\)/g
            ];
            
            for (const pattern of floorPatterns) {
                const match = text.match(pattern);
                if (match) {
                    return match[0];
                }
            }
            
            return '';
        }

        // êµ­ë°¥ ê´€ë ¨ ë©”ë‰´ë¥¼ íŒë§¤í•˜ëŠ” ë§¤ì¥ì¸ì§€ í™•ì¸
        function isSoupMenuRestaurant(restaurantName, categoryName) {
            if (!restaurantName && !categoryName) return false;
            
            const name = (restaurantName || '').toLowerCase();
            const category = (categoryName || '').toLowerCase();
            const combined = `${name} ${category}`;
            
            // êµ­ë°¥ ê´€ë ¨ í‚¤ì›Œë“œ í™•ì¸
            return SOUP_MENU_KEYWORDS.some(keyword => 
                combined.includes(keyword.toLowerCase())
            );
        }

        // ì¹´ì¹´ì˜¤ APIë¡œ êµ­ë°¥ ë§¤ì¥ ê²€ìƒ‰
        async function searchSoupRestaurantsFromKakaoAPI(baseX, baseY, radius = 500) {
            // ìˆœëŒ€êµ­, ì„¤ë íƒ•, ê³°íƒ• ë³‘ë ¬ ê²€ìƒ‰
            const [sundaeData, seolleongData, gomtangData] = await Promise.all([
                callKakaoAPI('keyword', {
                    query: 'ìˆœëŒ€êµ­',
                    x: baseX,
                    y: baseY,
                    radius: radius,
                    size: 15
                }).catch(() => ({ documents: [] })),
                callKakaoAPI('keyword', {
                    query: 'ì„¤ë íƒ•',
                    x: baseX,
                    y: baseY,
                    radius: radius,
                    size: 15
                }).catch(() => ({ documents: [] })),
                callKakaoAPI('keyword', {
                    query: 'ê³°íƒ•',
                    x: baseX,
                    y: baseY,
                    radius: radius,
                    size: 15
                }).catch(() => ({ documents: [] }))
            ]);
            
            // ì¤‘ë³µ ì œê±°ë¥¼ ìœ„í•œ Set ì‚¬ìš©
            const seen = new Set();
            const allDocs = [
                ...(sundaeData.documents || []),
                ...(seolleongData.documents || []),
                ...(gomtangData.documents || [])
            ];
            
            return allDocs.filter(doc => {
                const key = `${doc.place_name}|${doc.x}|${doc.y}`;
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });
        }

        // êµ­ë°¥ ë§¤ì¥ ê²°ê³¼ ì²˜ë¦¬ ë° í•„í„°ë§
        function processSoupRestaurantResults(documents, baseX, baseY) {
            return documents
                .map(doc => {
                    const restaurantX = parseFloat(doc.x);
                    const restaurantY = parseFloat(doc.y);
                    const distance = calculateDistance(baseY, baseX, restaurantY, restaurantX);
                    
                    const roadAddr = doc.road_address?.address_name || '';
                    const addr = doc.address_name || '';
                    const placeName = doc.place_name || '';
                    const floorInfo = extractFloorInfo(placeName);
                    
                    return {
                        name: placeName,
                        address: addr,
                        roadAddress: roadAddr,
                        displayAddress: roadAddr || addr,
                        floor: floorInfo,
                        x: restaurantX,
                        y: restaurantY,
                        distance: distance,
                        categoryName: doc.category_name || '',
                        doc: doc
                    };
                })
                .filter(restaurant => restaurant.distance <= 500)
                .sort((a, b) => a.distance - b.distance);
        }

        // ì£¼ì†Œ ì¬ì¡°íšŒ ê³µí†µ í•¨ìˆ˜
        async function enrichRestaurantsWithAddress(restaurants) {
            return Promise.all(restaurants.map(async (restaurant) => {
                if (!restaurant.roadAddress && restaurant.x && restaurant.y) {
                    try {
                        const coordData = await callKakaoAPI('coord2address', {
                            x: restaurant.x,
                            y: restaurant.y
                        });
                        
                        if (coordData.documents?.length > 0) {
                            const doc = coordData.documents[0];
                            const roadAddr = doc.road_address?.address_name || '';
                            if (roadAddr) {
                                restaurant.roadAddress = roadAddr;
                                restaurant.displayAddress = roadAddr;
                            }
                        }
                    } catch (error) {
                        console.warn('ì£¼ì†Œ ì¬ì¡°íšŒ ì‹¤íŒ¨:', restaurant.name, error);
                    }
                }
                return restaurant;
            }));
        }

        // ë§¤ì¥ëª…ì— êµ­ë°¥ ê´€ë ¨ í‚¤ì›Œë“œê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
        function hasSoupKeywordInName(restaurantName) {
            if (!restaurantName) return false;
            const name = restaurantName.toLowerCase();
            return SOUP_MENU_KEYWORDS.some(keyword => 
                name.includes(keyword.toLowerCase())
            );
        }

        // ë„¤ì´ë²„ ê²€ìƒ‰ ì •ë³´ ì¡°íšŒ ë° í•„í„°ë§
        async function processNaverSearchAndFilter(restaurantsWithAddress) {
            const restaurantsSearchable = [];
            const restaurantsExcluded = []; // ì œì™¸ëœ ë§¤ì¥ë“¤ ì €ì¥
            const batchSize = 5;
            
            for (let i = 0; i < restaurantsWithAddress.length; i += batchSize) {
                const batch = restaurantsWithAddress.slice(i, i + batchSize);
                
                const batchResults = await Promise.all(
                    batch.map(async (restaurant) => {
                        try {
                            // ë§¤ì¥ëª…ì— êµ­ë°¥ ê´€ë ¨ í‚¤ì›Œë“œê°€ í¬í•¨ëœ ê²½ìš° í•„í„°ë§ ìš°íšŒ
                            if (hasSoupKeywordInName(restaurant.name)) {
                                console.log(`ë§¤ì¥ëª…ì— êµ­ë°¥ ê´€ë ¨ í‚¤ì›Œë“œ í¬í•¨ - ë¦¬ìŠ¤íŒ… ì œì™¸ í•„í„° ìš°íšŒ [${restaurant.name}]`);
                                
                                // ì¸µ ì •ë³´ê°€ ì—†ìœ¼ë©´ ë„¤ì´ë²„ ê²€ìƒ‰ìœ¼ë¡œ ì¡°íšŒ ì‹œë„
                                if (!restaurant.floor) {
                                    restaurant.floor = await fetchFloorInfoFromNaver(restaurant);
                                }
                                
                                return { restaurant, isSearchable: true };
                            }
                            
                            // ì¼ë°˜ í•„í„°ë§ ë¡œì§ ì§„í–‰
                            const { isSearchable, floorInfo } = await getNaverSearchInfo(restaurant);
                            
                            if (isSearchable) {
                                if (floorInfo) {
                                    restaurant.floor = floorInfo;
                                }
                                console.log(`ë„¤ì´ë²„ ê²€ìƒ‰ ê°€ëŠ¥ ë° êµ­ë°¥ ë©”ë‰´ í™•ì¸ ì™„ë£Œ [${restaurant.name}]`);
                                return { restaurant, isSearchable: true };
                            } else {
                                console.log(`ë„¤ì´ë²„ ê²€ìƒ‰ ë¶ˆê°€ëŠ¥ ë˜ëŠ” êµ­ë°¥ ë©”ë‰´ê°€ ì•„ë‹˜ - ë¦¬ìŠ¤íŒ… ì œì™¸ [${restaurant.name}]`);
                                return { restaurant, isSearchable: false };
                            }
                        } catch (error) {
                            console.warn('ë„¤ì´ë²„ ê²€ìƒ‰ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', restaurant.name, error);
                            return { restaurant, isSearchable: false };
                        }
                    })
                );
                
                for (const result of batchResults) {
                    if (result.isSearchable) {
                        restaurantsSearchable.push(result.restaurant);
                    } else {
                        restaurantsExcluded.push(result.restaurant);
                    }
                }
                
                if (i + batchSize < restaurantsWithAddress.length) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }
            
            return { restaurantsSearchable, restaurantsExcluded };
        }

        // í•œì‹ ë§¤ì¥ì—ì„œ êµ­ë°¥ ë©”ë‰´ í™•ì¸ (ê³µí†µ í•¨ìˆ˜ - ì¤‘ë³µ ì œê±°)
        function checkKoreanRestaurantWithSoupMenu(item, restaurantName) {
            const resultTitle = (item.title || '').replace(/<[^>]*>/g, '');
            const resultCategory = (item.category || '').toLowerCase();
            const resultDescription = (item.description || '').replace(/<[^>]*>/g, '').toLowerCase();
            
            const nameMatches = resultTitle.includes(restaurantName) || restaurantName.includes(resultTitle.split(' ')[0]);
            const isKoreanFood = resultCategory.includes('í•œì‹') || resultCategory.includes('korean');
            
            if (nameMatches && isKoreanFood) {
                const menuText = `${resultTitle} ${resultDescription}`.toLowerCase();
                const hasSoupMenu = SOUP_MENU_KEYWORDS.some(keyword => 
                    menuText.includes(keyword.toLowerCase())
                );
                
                if (hasSoupMenu) {
                    return {
                        isValid: true,
                        title: resultTitle,
                        address: (item.address || '').replace(/<[^>]*>/g, ''),
                        roadAddress: (item.roadAddress || '').replace(/<[^>]*>/g, '')
                    };
                }
            }
            return { isValid: false };
        }

        // ë¦¬ìŠ¤íŒ… ë³´ì™„: í•œì‹ ë§¤ì¥ ì¤‘ êµ­ë°¥ ë©”ë‰´ê°€ ìˆëŠ” ë§¤ì¥ ì¶”ê°€
        async function supplementWithKoreanRestaurants(restaurantsExcluded, baseX, baseY, radius = 500) {
            const supplementedRestaurants = [];
            const batchSize = 5;
            
            for (let i = 0; i < restaurantsExcluded.length; i += batchSize) {
                const batch = restaurantsExcluded.slice(i, i + batchSize);
                
                const batchResults = await Promise.all(
                    batch.map(async (restaurant) => {
                        try {
                            const address = restaurant.displayAddress || restaurant.roadAddress || restaurant.address || '';
                            let searchQuery = restaurant.name;
                            if (address) {
                                const addressParts = address.split(' ');
                                const simplifiedAddress = addressParts.slice(1).join(' ') || address;
                                searchQuery = `${restaurant.name} ${simplifiedAddress}`;
                            }
                            
                            // 1ì°¨ ê²€ìƒ‰: ë§¤ì¥ëª… + ì£¼ì†Œ
                            const searchResult = await callNaverAPI('local', {
                                query: searchQuery,
                                display: 5,
                                sort: 'random'
                            });
                            
                            // 1ì°¨ ë° 2ì°¨ ê²€ìƒ‰ ê³µí†µ ì²˜ë¦¬ í•¨ìˆ˜ (ì¤‘ë³µ ì œê±°)
                            const processSearchResults = (items) => {
                                if (!items?.length) return null;
                                for (const item of items) {
                                    const checkResult = checkKoreanRestaurantWithSoupMenu(item, restaurant.name);
                                    if (checkResult.isValid) {
                                        if (!restaurant.floor) {
                                            restaurant.floor = extractFloorInfo(checkResult.title) || extractFloorInfo(checkResult.address + ' ' + checkResult.roadAddress) || '';
                                        }
                                        console.log(`í•œì‹ ë§¤ì¥ ì¤‘ êµ­ë°¥ ë©”ë‰´ í™•ì¸ ì™„ë£Œ - ë¦¬ìŠ¤íŒ… ë³´ì™„ [${restaurant.name}]`);
                                        return restaurant;
                                    }
                                }
                                return null;
                            };
                            
                            // 1ì°¨ ê²€ìƒ‰: ë§¤ì¥ëª… + ì£¼ì†Œ
                            const result1 = processSearchResults(searchResult.items);
                            if (result1) return result1;
                            
                            // 2ì°¨ ê²€ìƒ‰: ë§¤ì¥ëª…ë§Œ
                            const searchResultNameOnly = await callNaverAPI('local', {
                                query: restaurant.name,
                                display: 5,
                                sort: 'random'
                            });
                            
                            const result2 = processSearchResults(searchResultNameOnly.items);
                            if (result2) return result2;
                            
                            return null;
                        } catch (error) {
                            console.warn('í•œì‹ ë§¤ì¥ ë³´ì™„ ê²€ìƒ‰ ì‹¤íŒ¨:', restaurant.name, error);
                            return null;
                        }
                    })
                );
                
                for (const result of batchResults) {
                    if (result) {
                        supplementedRestaurants.push(result);
                    }
                }
                
                if (i + batchSize < restaurantsExcluded.length) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }
            
            return supplementedRestaurants;
        }

        // ì¸µ ì •ë³´ ì¡°íšŒ ê³µí†µ í•¨ìˆ˜ (ì¤‘ë³µ ì œê±°)
        async function fetchFloorInfoFromNaver(restaurant) {
            if (restaurant.floor) return restaurant.floor;
            
            try {
                const address = restaurant.displayAddress || restaurant.roadAddress || restaurant.address || '';
                const searchQuery = address
                    ? `${restaurant.name} ${address.split(' ').slice(0, 2).join(' ')}`
                    : restaurant.name;
                
                const naverResult = await callNaverAPI('local', {
                    query: searchQuery,
                    display: 1,
                    sort: 'random'
                });
                
                if (naverResult.items?.length > 0) {
                    const item = naverResult.items[0];
                    const title = (item.title || '').replace(/<[^>]*>/g, '');
                    const resultAddress = (item.address || '').replace(/<[^>]*>/g, '');
                    const resultRoadAddress = (item.roadAddress || '').replace(/<[^>]*>/g, '');
                    
                    return extractFloorInfo(title) || extractFloorInfo(resultAddress + ' ' + resultRoadAddress) || '';
                }
            } catch (error) {
                console.warn('ì¸µ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', restaurant.name, error);
            }
            return '';
        }

        // êµ­ë°¥ íŠ¹ì§• í‚¤ì›Œë“œ ì¶”ì¶œ (ë„¤ì´ë²„ ë¸”ë¡œê·¸ ë¦¬ë·°ì—ì„œ ì‹¤ì œ í…ìŠ¤íŠ¸ ë¶„ì„, ìµœì†Œ 1ê°œ ~ ìµœëŒ€ 3ê°œ)
        async function extractSoupRestaurantKeywords(restaurantName, restaurantAddress) {
            try {
                // êµ­ë°¥ ë§¤ì¥ ì´ë¦„ê³¼ ì£¼ì†Œë¥¼ ì¡°í•©í•˜ì—¬ ê²€ìƒ‰ì–´ ìƒì„±
                const searchQuery = restaurantAddress 
                    ? `${restaurantName} ${restaurantAddress.split(' ').slice(0, 3).join(' ')}`
                    : restaurantName;
                
                // ë„¤ì´ë²„ ë¸”ë¡œê·¸ ê²€ìƒ‰ API í˜¸ì¶œ
                const blogData = await callNaverAPI('blog', {
                    query: searchQuery,
                    display: 30,
                    sort: 'sim'
                });

                if (!blogData.items || blogData.items.length === 0) {
                    // ë¸”ë¡œê·¸ ê²€ìƒ‰ ì‹¤íŒ¨ ì‹œ êµ­ë°¥ ë§¤ì¥ ì´ë¦„ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ ì‹œë„
                    console.warn('ë¸”ë¡œê·¸ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ, êµ­ë°¥ ë§¤ì¥ ì´ë¦„ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ ì‹œë„:', restaurantName);
                    return extractKeywordsFromSoupName(restaurantName);
                }

                // ëª¨ë“  ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ì˜ ì œëª©ê³¼ ì„¤ëª…ì„ í•©ì³ì„œ í…ìŠ¤íŠ¸ ë¶„ì„
                const allText = blogData.items
                    .map(item => {
                        const title = (item.title || '').replace(/<[^>]*>/g, ' ');
                        const description = (item.description || '').replace(/<[^>]*>/g, ' ');
                        return `${title} ${description}`;
                    })
                    .join(' ');

                // êµ­ë°¥ ê´€ë ¨ ë©”ë‰´ í‚¤ì›Œë“œ íŒ¨í„´
                const menuPatterns = [
                    // êµ­ë°¥ ì¢…ë¥˜
                    { pattern: /ìˆœëŒ€êµ­|ìˆœëŒ“êµ­/gi, keyword: 'ìˆœëŒ€êµ­' },
                    { pattern: /ì„¤ë íƒ•/gi, keyword: 'ì„¤ë íƒ•' },
                    { pattern: /ê³°íƒ•/gi, keyword: 'ê³°íƒ•' },
                    { pattern: /í•´ì¥êµ­/gi, keyword: 'í•´ì¥êµ­' },
                    { pattern: /ë¼ˆí•´ì¥êµ­/gi, keyword: 'ë¼ˆí•´ì¥êµ­' },
                    { pattern: /ì½©ë‚˜ë¬¼í•´ì¥êµ­/gi, keyword: 'ì½©ë‚˜ë¬¼í•´ì¥êµ­' },
                    { pattern: /ì‹œë ˆê¸°í•´ì¥êµ­/gi, keyword: 'ì‹œë ˆê¸°í•´ì¥êµ­' },
                    { pattern: /ì„ ì§€í•´ì¥êµ­/gi, keyword: 'ì„ ì§€í•´ì¥êµ­' },
                    { pattern: /ë”°ë¡œêµ­ë°¥/gi, keyword: 'ë”°ë¡œêµ­ë°¥' },
                    { pattern: /ê°ìíƒ•/gi, keyword: 'ê°ìíƒ•' },
                    { pattern: /ë¼ˆê°ìíƒ•/gi, keyword: 'ë¼ˆê°ìíƒ•' },
                    { pattern: /ìœ¡ê°œì¥|ìœ¡ê²Œì¥/gi, keyword: 'ìœ¡ê°œì¥' },
                    
                    // êµ­ë°¥ íŠ¹ì§•
                    { pattern: /ê¹”ë”í•œ|ê¹”ë”|ë‹´ë°±|ì‹œì›/gi, keyword: 'ê¹”ë”í•œ' },
                    { pattern: /ì§„í•œ|ê¹Šì€|ê¹Šê³ /gi, keyword: 'ì§„í•œ êµ­ë¬¼' },
                    { pattern: /ì–¼í°|ì¹¼ì¹¼|ë§¤ìš´/gi, keyword: 'ì–¼í°í•œ' },
                    { pattern: /ê³ ì†Œ|ê³ ì†Œí•œ/gi, keyword: 'ê³ ì†Œí•œ' },
                    
                    // íŠ¹ë³„ ë©”ë‰´/ì¬ë£Œ
                    { pattern: /ìš°ê±°ì§€|ì‹œë˜ê¸°/gi, keyword: 'ìš°ê±°ì§€' },
                    { pattern: /ì„ ì§€/gi, keyword: 'ì„ ì§€' },
                    { pattern: /ìˆ˜ìœ¡/gi, keyword: 'ìˆ˜ìœ¡' },
                    { pattern: /ê³±ì°½|ë§‰ì°½/gi, keyword: 'ê³±ì°½' },
                    
                    // ë¶„ìœ„ê¸°/íŠ¹ì§•
                    { pattern: /24ì‹œê°„|24ì‹œ/gi, keyword: '24ì‹œê°„' },
                    { pattern: /ì•¼ì‹/gi, keyword: 'ì•¼ì‹' },
                    { pattern: /í•´ì¥|í•´ì¥í•˜ëŸ¬/gi, keyword: 'í•´ì¥' },
                    { pattern: /ë¬´í•œë¦¬í•„/gi, keyword: 'ë¬´í•œë¦¬í•„' }
                ];

                // ê° ë©”ë‰´ í‚¤ì›Œë“œì˜ ì¶œí˜„ ë¹ˆë„ ê³„ì‚°
                const keywordScores = {};
                for (const { pattern, keyword } of menuPatterns) {
                    const matches = allText.match(pattern);
                    if (matches && matches.length > 0) {
                        keywordScores[keyword] = (keywordScores[keyword] || 0) + matches.length;
                    }
                }

                // ë””ë²„ê¹…: í‚¤ì›Œë“œ ì¶”ì¶œ ê²°ê³¼ í™•ì¸
                console.log('êµ­ë°¥ í‚¤ì›Œë“œ ì¶”ì¶œ ê²°ê³¼:', {
                    restaurantName,
                    searchQuery,
                    blogItemsCount: blogData.items?.length || 0,
                    allTextLength: allText.length,
                    allTextSample: allText.substring(0, 200),
                    keywordScores,
                    sortedKeywords: Object.entries(keywordScores).sort((a, b) => b[1] - a[1]).slice(0, 3)
                });

                // ë¹ˆë„ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ê³  ìƒìœ„ 3ê°œ ì„ íƒ (ìµœëŒ€ 3ê°œ)
                const sortedKeywords = Object.entries(keywordScores)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3)
                    .map(([keyword]) => keyword);

                // ìµœì†Œ 1ê°œ ì´ìƒì´ë©´ ë°˜í™˜, ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´
                return sortedKeywords.length > 0 ? sortedKeywords : [];
            } catch (error) {
                console.error('êµ­ë°¥ í‚¤ì›Œë“œ ì¶”ì¶œ ì‹¤íŒ¨:', error);
                // ì—ëŸ¬ ë°œìƒ ì‹œ êµ­ë°¥ ë§¤ì¥ ì´ë¦„ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ ì‹œë„
                return extractKeywordsFromSoupName(restaurantName);
            }
        }

        // êµ­ë°¥ ë§¤ì¥ ì´ë¦„ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ (í´ë°±)
        function extractKeywordsFromSoupName(restaurantName) {
            const keywords = [];
            const name = (restaurantName || '').toLowerCase();
            
            const namePatterns = [
                { pattern: /ìˆœëŒ€êµ­|ìˆœëŒ“êµ­/gi, keyword: 'ìˆœëŒ€êµ­' },
                { pattern: /ì„¤ë íƒ•/gi, keyword: 'ì„¤ë íƒ•' },
                { pattern: /ê³°íƒ•/gi, keyword: 'ê³°íƒ•' },
                { pattern: /í•´ì¥êµ­/gi, keyword: 'í•´ì¥êµ­' },
                { pattern: /ê°ìíƒ•/gi, keyword: 'ê°ìíƒ•' },
                { pattern: /ìœ¡ê°œì¥|ìœ¡ê²Œì¥/gi, keyword: 'ìœ¡ê°œì¥' },
                { pattern: /24ì‹œê°„|24ì‹œ/gi, keyword: '24ì‹œê°„' },
                { pattern: /ë¬´í•œë¦¬í•„/gi, keyword: 'ë¬´í•œë¦¬í•„' }
            ];
            
            for (const { pattern, keyword } of namePatterns) {
                if (pattern.test(name) && keywords.length < 3 && !keywords.includes(keyword)) {
                    keywords.push(keyword);
                }
            }
            
            return keywords;
        }

        // í‚¤ì›Œë“œ ì¶”ì¶œ ê³µí†µ í•¨ìˆ˜
        async function processKeywords(restaurantsSearchable) {
            const restaurantsWithKeywords = [];
            const keywordBatchSize = 5;
            
            for (let i = 0; i < restaurantsSearchable.length; i += keywordBatchSize) {
                const batch = restaurantsSearchable.slice(i, i + keywordBatchSize);
                
                const batchResults = await Promise.all(
                    batch.map(async (restaurant) => {
                        try {
                            const keywords = await extractSoupRestaurantKeywords(
                                restaurant.name,
                                restaurant.displayAddress || restaurant.roadAddress || restaurant.address
                            );
                            console.log(`êµ­ë°¥ í‚¤ì›Œë“œ ì¶”ì¶œ ì™„ë£Œ [${restaurant.name}]:`, keywords);
                            return { ...restaurant, keywords: keywords || [] };
                        } catch (error) {
                            console.error('êµ­ë°¥ í‚¤ì›Œë“œ ì¶”ì¶œ ì‹¤íŒ¨:', restaurant.name, error);
                            return { ...restaurant, keywords: [] };
                        }
                    })
                );
                
                restaurantsWithKeywords.push(...batchResults);
                
                if (i + keywordBatchSize < restaurantsSearchable.length) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }
            
            return restaurantsWithKeywords;
        }

        // ë„¤ì´ë²„ ê²€ìƒ‰ ê²°ê³¼ ê°€ì ¸ì˜¤ê¸° (êµ­ë°¥ ë©”ë‰´ í™•ì¸)
        async function getNaverSearchInfo(restaurant) {
            try {
                // ë§¤ì¥ëª…ì— êµ­ë°¥ ê´€ë ¨ í‚¤ì›Œë“œê°€ í¬í•¨ëœ ê²½ìš° í•„í„°ë§ ìš°íšŒ
                if (hasSoupKeywordInName(restaurant.name)) {
                    console.log('ë§¤ì¥ëª…ì— êµ­ë°¥ ê´€ë ¨ í‚¤ì›Œë“œ í¬í•¨ - ë„¤ì´ë²„ ê²€ìƒ‰ í•„í„°ë§ ìš°íšŒ:', restaurant.name);
                    const floorInfo = await fetchFloorInfoFromNaver(restaurant);
                    return { isSearchable: true, floorInfo };
                }
                
                const address = restaurant.displayAddress || restaurant.roadAddress || restaurant.address || '';
                
                let searchQueryWithAddress = restaurant.name;
                if (address) {
                    const addressParts = address.split(' ');
                    const simplifiedAddress = addressParts.slice(1).join(' ') || address;
                    searchQueryWithAddress = `${restaurant.name} ${simplifiedAddress}`;
                }
                
                const searchResult = await callNaverAPI('local', {
                    query: searchQueryWithAddress,
                    display: 5,
                    sort: 'random'
                });
                
                let floorInfo = restaurant.floor || '';
                let isSearchable = false;
                
                if (searchResult.items && searchResult.items.length > 0) {
                    for (const item of searchResult.items) {
                        const resultTitle = (item.title || '').replace(/<[^>]*>/g, '');
                        const resultCategory = (item.category || '').toLowerCase();
                        const resultAddress = (item.address || '').replace(/<[^>]*>/g, '');
                        const resultRoadAddress = (item.roadAddress || '').replace(/<[^>]*>/g, '');
                        
                        const nameMatches = resultTitle.includes(restaurant.name) || restaurant.name.includes(resultTitle.split(' ')[0]);
                        
                        // êµ­ë°¥ ê´€ë ¨ ë©”ë‰´ë¥¼ íŒë§¤í•˜ëŠ” ë§¤ì¥ì¸ì§€ í™•ì¸
                        const isSoupMenu = isSoupMenuRestaurant(resultTitle, resultCategory);
                        
                        if (nameMatches && isSoupMenu) {
                            isSearchable = true;
                            if (!floorInfo) {
                                const floorFromTitle = extractFloorInfo(resultTitle);
                                const floorFromAddress = extractFloorInfo(resultAddress + ' ' + resultRoadAddress);
                                floorInfo = floorFromTitle || floorFromAddress || '';
                            }
                            break;
                        }
                    }
                }
                
                // 1ì°¨ ê²€ìƒ‰ ì‹¤íŒ¨ ì‹œ 2ì°¨ ê²€ìƒ‰: ë§¤ì¥ëª…ì¹­ë§Œ
                if (!isSearchable) {
                    const searchResultNameOnly = await callNaverAPI('local', {
                        query: restaurant.name,
                        display: 5,
                        sort: 'random'
                    });
                    
                    if (searchResultNameOnly.items && searchResultNameOnly.items.length > 0) {
                        for (const item of searchResultNameOnly.items) {
                            const resultTitle = (item.title || '').replace(/<[^>]*>/g, '');
                            const resultCategory = (item.category || '').toLowerCase();
                            const resultAddress = (item.address || '').replace(/<[^>]*>/g, '');
                            const resultRoadAddress = (item.roadAddress || '').replace(/<[^>]*>/g, '');
                            
                            const nameMatches = resultTitle.includes(restaurant.name) || restaurant.name.includes(resultTitle.split(' ')[0]);
                            const isSoupMenu = isSoupMenuRestaurant(resultTitle, resultCategory);
                            
                            if (nameMatches && isSoupMenu) {
                                isSearchable = true;
                                if (!floorInfo) {
                                    floorInfo = extractFloorInfo(resultTitle) || extractFloorInfo(resultAddress + ' ' + resultRoadAddress) || '';
                                }
                                break;
                            }
                        }
                    }
                }
                
                return { isSearchable, floorInfo };
            } catch (error) {
                console.warn('ë„¤ì´ë²„ ê²€ìƒ‰ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', restaurant.name, error);
                return { isSearchable: false, floorInfo: restaurant.floor || '' };
            }
        }

        // êµ­ë°¥ ë§¤ì¥ ëª©ë¡ ë Œë”ë§
        function renderRestaurantList(restaurants, resultsHeader, resultsSection, restaurantList) {
            resultsHeader.textContent = `ì£¼ë³€ì˜ ${restaurants.length}ê°œ êµ­ë°¥ ë§¤ì¥ì…ë‹ˆë‹¤.`;
            resultsSection.style.display = 'block';
            
            const fragment = document.createDocumentFragment();
            
            for (const restaurant of restaurants) {
                const li = document.createElement('li');
                li.className = 'cafe-item';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'cafe-name';
                nameDiv.textContent = restaurant.name;
                li.appendChild(nameDiv);
                
                let addressDiv = null;
                if (restaurant.displayAddress) {
                    addressDiv = document.createElement('div');
                    addressDiv.className = 'cafe-address';
                    let addressText = restaurant.displayAddress;
                    if (restaurant.floor) {
                        addressText += ` ${restaurant.floor}`;
                    }
                    addressDiv.textContent = addressText;
                    li.appendChild(addressDiv);
                }
                
                const distanceEl = document.createElement('div');
                distanceEl.className = 'cafe-distance';
                distanceEl.textContent = `${Math.round(restaurant.distance)}m`;
                
                // í‚¤ì›Œë“œ í‘œì‹œ
                const keywords = restaurant.keywords || [];
                const keywordsContainer = document.createElement('div');
                keywordsContainer.className = 'cafe-keywords';
                
                for (const keyword of keywords) {
                    const keywordEl = document.createElement('span');
                    keywordEl.className = 'cafe-keyword';
                    keywordEl.textContent = keyword;
                    keywordsContainer.appendChild(keywordEl);
                }
                
                const distanceContainer = document.createElement('div');
                distanceContainer.style.display = 'flex';
                distanceContainer.style.alignItems = 'center';
                distanceContainer.appendChild(distanceEl);
                if (keywords.length > 0) {
                    distanceContainer.appendChild(keywordsContainer);
                }
                
                li.appendChild(distanceContainer);
                
                li.onclick = () => openNaverMap(restaurant);
                
                fragment.appendChild(li);
            }
            
            restaurantList.innerHTML = '';
            restaurantList.appendChild(fragment);
        }

        // ë„¤ì´ë²„ë§µìœ¼ë¡œ ì´ë™
        async function openNaverMap(restaurant) {
            const address = restaurant.displayAddress || restaurant.roadAddress || restaurant.address || '';
            let searchQueryWithAddress = restaurant.name;
            if (address) {
                const addressParts = address.split(' ');
                const simplifiedAddress = addressParts.slice(1).join(' ') || address;
                searchQueryWithAddress = `${restaurant.name} ${simplifiedAddress}`;
            }
            
            try {
                const searchResult = await callNaverAPI('local', {
                    query: searchQueryWithAddress,
                    display: 5,
                    sort: 'random'
                });
                
                let searchSuccess = false;
                if (searchResult.items && searchResult.items.length > 0) {
                    const firstResult = searchResult.items[0];
                    const resultTitle = (firstResult.title || '').replace(/<[^>]*>/g, '');
                    if (resultTitle.includes(restaurant.name) || restaurant.name.includes(resultTitle.split(' ')[0])) {
                        searchSuccess = true;
                    }
                }
                
                if (searchSuccess) {
                    const urlWithAddress = `https://map.naver.com/v5/search/${encodeURIComponent(searchQueryWithAddress)}`;
                    window.open(urlWithAddress, '_blank');
                } else {
                    const urlNameOnly = `https://map.naver.com/v5/search/${encodeURIComponent(restaurant.name)}`;
                    window.open(urlNameOnly, '_blank');
                }
            } catch (error) {
                console.warn('ë„¤ì´ë²„ ê²€ìƒ‰ API í˜¸ì¶œ ì‹¤íŒ¨, 1ì°¨ ê²€ìƒ‰ìœ¼ë¡œ ì§„í–‰:', error);
                const urlWithAddress = `https://map.naver.com/v5/search/${encodeURIComponent(searchQueryWithAddress)}`;
                window.open(urlWithAddress, '_blank');
            }
        }

        // ê²°ê³¼ ì—†ìŒ í‘œì‹œ
        function showNoResults() {
            const resultsSection = document.getElementById('resultsSection');
            const restaurantList = document.getElementById('restaurantList') || document.getElementById('cafeList');
            
            resultsSection.style.display = 'block';
            restaurantList.innerHTML = `
                <li class="no-results">
                    <div class="no-results-title">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                    <div class="no-results-text">500m ì´ë‚´ì— êµ­ë°¥ ë§¤ì¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
                </li>
            `;
        }

        // ì£¼ì†Œ í›„ë³´ ê²€ìƒ‰ ë° ë¦¬ìŠ¤íŒ…
        async function searchAddressCandidates(query) {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const resultsSection = document.getElementById('resultsSection');
            const restaurantList = document.getElementById('cafeList');
            const resultsHeader = document.getElementById('resultsHeader');

            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            resultsSection.style.display = 'none';
            restaurantList.innerHTML = '';

            try {
                const [addressData, keywordData] = await Promise.all([
                    callKakaoAPI('address', {
                        query: query,
                        size: 10
                    }).catch(() => ({ documents: [] })),
                    callKakaoAPI('keyword', {
                        query: query,
                        size: 10
                    }).catch(() => ({ documents: [] }))
                ]);

                const suggestions = [];
                const seenAddresses = new Set();

                if (addressData.documents && addressData.documents.length > 0) {
                    for (const doc of addressData.documents) {
                        const roadAddr = doc.road_address?.address_name || '';
                        const addr = doc.address_name || '';
                        
                        if (roadAddr || addr) {
                            const key = roadAddr || addr;
                            if (!seenAddresses.has(key) && suggestions.length < 15) {
                                seenAddresses.add(key);
                                suggestions.push({
                                    main: roadAddr || addr,
                                    sub: roadAddr ? addr : '',
                                    fullAddress: roadAddr || addr,
                                    roadAddress: roadAddr || '',
                                    x: doc.x,
                                    y: doc.y
                                });
                            }
                        }
                    }
                }

                if (keywordData.documents && keywordData.documents.length > 0) {
                    for (const doc of keywordData.documents) {
                        const roadAddr = doc.road_address?.address_name || '';
                        const addr = doc.address_name || '';
                        const placeName = doc.place_name || '';
                        
                        if (placeName || roadAddr || addr) {
                            const displayName = placeName || roadAddr || addr;
                            const key = placeName + '|' + (roadAddr || addr);
                            
                            if (!seenAddresses.has(key) && suggestions.length < 15) {
                                seenAddresses.add(key);
                                suggestions.push({
                                    main: displayName,
                                    sub: roadAddr || addr,
                                    fullAddress: roadAddr || addr,
                                    roadAddress: roadAddr || '',
                                    x: doc.x,
                                    y: doc.y
                                });
                            }
                        }
                    }
                }

                loadingEl.style.display = 'none';

                if (suggestions.length === 0) {
                    errorEl.style.display = 'block';
                    errorEl.textContent = 'ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                    return;
                }

                displayAddressCandidates(suggestions);
            } catch (error) {
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                errorEl.textContent = 'ì£¼ì†Œ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                console.error('ì£¼ì†Œ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
            }
        }

        // ì£¼ì†Œ í›„ë³´ ëª©ë¡ í‘œì‹œ
        function displayAddressCandidates(suggestions) {
            const resultsSection = document.getElementById('resultsSection');
            const restaurantList = document.getElementById('cafeList');
            const resultsHeader = document.getElementById('resultsHeader');

            resultsHeader.textContent = `${suggestions.length}ê°œì˜ ì£¼ì†Œë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤. ì„ íƒí•´ì£¼ì„¸ìš”.`;
            resultsSection.style.display = 'block';
            restaurantList.innerHTML = '';

            const fragment = document.createDocumentFragment();
            
            for (const suggestion of suggestions) {
                const li = document.createElement('li');
                li.className = 'address-item';
                
                const displayMain = suggestion.roadAddress || suggestion.main;
                const displaySub = suggestion.roadAddress ? suggestion.sub : '';
                
                const mainEl = document.createElement('div');
                mainEl.className = 'address-main';
                mainEl.textContent = displayMain;
                li.appendChild(mainEl);
                
                if (displaySub) {
                    const subEl = document.createElement('div');
                    subEl.className = 'address-sub';
                    subEl.textContent = displaySub;
                    li.appendChild(subEl);
                }
                
                li.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const addressInput = document.getElementById('addressInput');
                    if (addressInput) {
                        addressInput.value = displayMain;
                    }
                    searchRestaurantsByCoordinates(suggestion.x, suggestion.y, displayMain);
                };
                
                fragment.appendChild(li);
            }
            
            restaurantList.appendChild(fragment);
        }

        // êµ­ë°¥ ë§¤ì¥ ê²€ìƒ‰ ê³µí†µ í•¨ìˆ˜ (ì¤‘ë³µ ì œê±°)
        async function searchAndProcessRestaurants(baseX, baseY, radius = 500) {
            const allResults = await searchSoupRestaurantsFromKakaoAPI(baseX, baseY, radius);
            
            console.log('ì¹´ì¹´ì˜¤ API ê²€ìƒ‰ ê²°ê³¼:', {
                query: 'ìˆœëŒ€êµ­ + ì„¤ë íƒ• + ê³°íƒ•',
                count: allResults.length,
                results: allResults.slice(0, 5).map(doc => doc.place_name)
            });

            if (allResults.length === 0) {
                return [];
            }

            const restaurants = processSoupRestaurantResults(allResults, baseX, baseY);

            if (restaurants.length === 0) {
                return [];
            }

            const restaurantsWithAddress = await enrichRestaurantsWithAddress(restaurants);
            const { restaurantsSearchable, restaurantsExcluded } = await processNaverSearchAndFilter(restaurantsWithAddress);
            
            // ë¦¬ìŠ¤íŒ… ë³´ì™„: í•œì‹ ë§¤ì¥ ì¤‘ êµ­ë°¥ ë©”ë‰´ê°€ ìˆëŠ” ë§¤ì¥ ì¶”ê°€
            const supplementedRestaurants = await supplementWithKoreanRestaurants(restaurantsExcluded, baseX, baseY, radius);
            
            // ìµœì¢… ë¦¬ìŠ¤íŒ…: ê¸°ì¡´ ê²€ìƒ‰ ê°€ëŠ¥í•œ ë§¤ì¥ + ë³´ì™„ëœ í•œì‹ ë§¤ì¥
            const finalRestaurants = [...restaurantsSearchable, ...supplementedRestaurants];
            // ê±°ë¦¬ìˆœìœ¼ë¡œ ì¬ì •ë ¬
            finalRestaurants.sort((a, b) => a.distance - b.distance);

            // í‚¤ì›Œë“œ ì¶”ì¶œ
            const restaurantsWithKeywords = await processKeywords(finalRestaurants);

            return restaurantsWithKeywords;
        }

        // ì¢Œí‘œë¡œ êµ­ë°¥ ë§¤ì¥ ê²€ìƒ‰
        async function searchRestaurantsByCoordinates(x, y, addressName) {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const resultsSection = document.getElementById('resultsSection');
            const restaurantList = document.getElementById('cafeList');
            const resultsHeader = document.getElementById('resultsHeader');

            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            resultsSection.style.display = 'none';
            resultsHeader.textContent = '';
            restaurantList.innerHTML = '';

            try {
                const baseX = parseFloat(x);
                const baseY = parseFloat(y);
                const radius = 500;
                
                const finalRestaurants = await searchAndProcessRestaurants(baseX, baseY, radius);

                if (finalRestaurants.length === 0) {
                    loadingEl.style.display = 'none';
                    showNoResults();
                    return;
                }

                loadingEl.style.display = 'none';
                renderRestaurantList(finalRestaurants, resultsHeader, resultsSection, restaurantList);

            } catch (error) {
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                let errorMessage = 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                if (error.message) {
                    errorMessage = error.message.replace(/\n/g, '<br>');
                }
                errorEl.innerHTML = errorMessage;
                console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
            }
        }

        // êµ­ë°¥ ë§¤ì¥ ê²€ìƒ‰
        async function searchRestaurants(address) {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const resultsSection = document.getElementById('resultsSection');
            const restaurantList = document.getElementById('cafeList');
            const resultsHeader = document.getElementById('resultsHeader');

            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            resultsSection.style.display = 'none';
            resultsHeader.textContent = '';
            restaurantList.innerHTML = '';

            try {
                const addressData = await callKakaoAPI('address', {
                    query: address,
                    size: 1
                });

                if (!addressData.documents || addressData.documents.length === 0) {
                    throw new Error('ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì£¼ì†Œ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }

                const location = addressData.documents[0];
                const baseX = parseFloat(location.x);
                const baseY = parseFloat(location.y);
                const radius = 500;
                
                const finalRestaurants = await searchAndProcessRestaurants(baseX, baseY, radius);

                if (finalRestaurants.length === 0) {
                    loadingEl.style.display = 'none';
                    showNoResults();
                    return;
                }

                loadingEl.style.display = 'none';
                renderRestaurantList(finalRestaurants, resultsHeader, resultsSection, restaurantList);

            } catch (error) {
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                let errorMessage = 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                if (error.message) {
                    errorMessage = error.message.replace(/\n/g, '<br>');
                }
                errorEl.innerHTML = errorMessage;
                console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
            }
        }

        // ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸
        const addressInput = document.getElementById('addressInput');

        // í˜„ìœ„ì¹˜ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('locationButton').addEventListener('click', async () => {
            const locationButton = document.getElementById('locationButton');
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const resultsSection = document.getElementById('resultsSection');
            const restaurantList = document.getElementById('cafeList');
            const resultsHeader = document.getElementById('resultsHeader');
            
            locationButton.disabled = true;
            locationButton.textContent = 'â³';
            
            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            resultsSection.style.display = 'none';
            restaurantList.innerHTML = '';
            resultsHeader.textContent = '';
            
            try {
                if (!navigator.geolocation) {
                    throw new Error('í˜„ì¬ ë¸Œë¼ìš°ì €ì—ì„œ ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
                
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        resolve, 
                        (error) => {
                            console.warn('ì¼ë°˜ ì •í™•ë„ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨, ê³ ì •í™•ë„ë¡œ ì¬ì‹œë„:', error);
                            navigator.geolocation.getCurrentPosition(
                                resolve,
                                reject,
                                {
                                    enableHighAccuracy: true,
                                    timeout: 15000,
                                    maximumAge: 60000
                                }
                            );
                        },
                        {
                            enableHighAccuracy: false,
                            timeout: 10000,
                            maximumAge: 60000
                        }
                    );
                });
                
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;
                
                let address = '';
                try {
                    const coordData = await callKakaoAPI('coord2address', {
                        x: longitude,
                        y: latitude
                    });
                    
                    if (coordData.documents && coordData.documents.length > 0) {
                        const doc = coordData.documents[0];
                        const roadAddr = doc.road_address?.address_name || '';
                        const addr = doc.address?.address_name || doc.address_name || '';
                        address = roadAddr || addr;
                    }
                    
                    if (!address || address.trim() === '') {
                        address = `ìœ„ë„ ${latitude.toFixed(6)}, ê²½ë„ ${longitude.toFixed(6)}`;
                    }
                } catch (error) {
                    console.error('ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨:', error);
                    address = `ìœ„ë„ ${latitude.toFixed(6)}, ê²½ë„ ${longitude.toFixed(6)}`;
                }
                
                if (address.startsWith('ìœ„ë„')) {
                    loadingEl.style.display = 'none';
                    errorEl.style.display = 'block';
                    errorEl.textContent = 'ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ ê²€ìƒ‰í•´ì£¼ì„¸ìš”.';
                    addressInput.value = '';
                    return;
                }
                
                addressInput.value = address;
                await searchRestaurantsByCoordinates(longitude, latitude, address);
                
            } catch (error) {
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                
                let errorMessage = 'í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                if (error.code === 1) {
                    errorMessage = 'ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
                } else if (error.code === 2) {
                    errorMessage = 'ìœ„ì¹˜ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ê³¼ ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”. (ì‹¤ë‚´ì—ì„œëŠ” ì •í™•ë„ê°€ ë‚®ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤)';
                } else if (error.code === 3) {
                    errorMessage = 'ìœ„ì¹˜ í™•ì¸ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                errorEl.textContent = errorMessage;
                console.error('ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
            } finally {
                locationButton.disabled = false;
                locationButton.textContent = 'ğŸ“';
            }
        });

        // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('searchButton').addEventListener('click', () => {
            const address = addressInput.value.trim();
            if (address) {
                searchAddressCandidates(address);
            }
        });

        // Enter í‚¤ ì´ë²¤íŠ¸
        addressInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const address = addressInput.value.trim();
                if (address) {
                    searchAddressCandidates(address);
                }
            }
        });

        // ì¹´í…Œê³ ë¦¬ ì„ íƒ ì´ë²¤íŠ¸
        const categorySelect = document.getElementById('categorySelect');
        categorySelect.addEventListener('change', (e) => {
            const selectedCategory = e.target.value;
            if (selectedCategory === 'ì¹´í˜') {
                window.location.href = 'index.html';
            } else if (selectedCategory === 'ë§ˆë¼íƒ•') {
                window.location.href = 'index2.html';
            } else if (selectedCategory === 'ë¹µ') {
                window.location.href = 'index3.html';
            }
        });
    </script>
</body>
</html>
